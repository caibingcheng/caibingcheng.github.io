<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>初探Linux文件和文件系统 - Bing's Blog</title><meta name=keywords content="[Life bbing bing hugo Blog C++ LoveIt]"><meta name=Description content="个人技术博客"><meta property="og:title" content="初探Linux文件和文件系统"><meta property="og:description" content="前面的文章讲了进程控制和进程通信的内容, 在学习和准备这些内容的过程中, 发现对Linux文件系统并不是很熟悉. 此前对Linux文件系统的理解非常肤浅, 嘴上会说&#34;万物皆是文件&#34;的话, 但是并不是很理解Linux的文件系统. 这里插入一篇文章, 学习和整理一下Linux文件系统的内容."><meta property="og:type" content="article"><meta property="og:url" content="https://imcbc.cn/202105/linux-filesystem/"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/caibingcheng/resources@main/images/13bOkrO.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-05-14T09:31:15+08:00"><meta property="article:modified_time" content="2021-05-21T19:24:18+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://cdn.jsdelivr.net/gh/caibingcheng/resources@main/images/13bOkrO.png"><meta name=twitter:title content="初探Linux文件和文件系统"><meta name=twitter:description content="前面的文章讲了进程控制和进程通信的内容, 在学习和准备这些内容的过程中, 发现对Linux文件系统并不是很熟悉. 此前对Linux文件系统的理解非常肤浅, 嘴上会说&#34;万物皆是文件&#34;的话, 但是并不是很理解Linux的文件系统. 这里插入一篇文章, 学习和整理一下Linux文件系统的内容."><meta name=application-name content="Bing's Blog"><meta name=apple-mobile-web-app-title content="Bing's Blog"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://imcbc.cn/202105/linux-filesystem/><link rel=prev href=https://imcbc.cn/202105/cmake-ndk-crosscomplie/><link rel=next href=https://imcbc.cn/202105/cpp-bitmap/><link rel=stylesheet href=https://fastly.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=https://fastly.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.0/css/all.min.css><link rel=stylesheet href=https://fastly.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css><link rel=stylesheet href=https://fastly.jsdelivr.net/gh/Albejr/jquery-albe-timeline/templates/simple/style-albe-timeline.css><link rel=stylesheet href=https://fastly.jsdelivr.net/gh/caibingcheng/orlike@client/orlike.min.css><link rel=stylesheet href=/css/custom.css><meta name=google-site-verification content="xy1bCgQPV_H3_o2XD34o2mIByQxmzkV3GPOfhXg_mTM"><meta name=msvalidate.01 content="c81a65b6344571786df543a56c7bbe18"><meta name=baidu-site-verification content="code-WcyzWjgFYo"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"初探Linux文件和文件系统","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/imcbc.cn\/202105\/linux-filesystem\/"},"image":["https:\/\/imcbc.cn\/android-chrome-192x192.png"],"genre":"posts","keywords":"Linux, 文件系统","wordcount":6332,"url":"https:\/\/imcbc.cn\/202105\/linux-filesystem\/","datePublished":"2021-05-14T09:31:15+08:00","dateModified":"2021-05-21T19:24:18+08:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"Bing","logo":"https:\/\/imcbc.cn\/android-chrome-192x192.png"},"author":{"@type":"Person","name":"bbing"},"description":""}</script></head><body header-desktop=normal header-mobile=normal><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><a href=https://github.com/caibingcheng/ class=github-corner aria-label="View source on GitHub"><svg width="3.5rem" height="3.5rem" viewBox="0 0 250 250" style="fill:#151513;color:#fff;position:absolute;top:0;border:0;left:0;transform:scale(-1,1)" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><div class=header-title><a href=/ title="Bing's Blog">Bing's Blog</a></div><div class=menu><div class=menu-inner><div class=dropdown><a href=/posts/ class="menu-item menu-more dropbtn" title><i class='fas fa fa-archive'></i> 归档</a><div class="menu-more-content dropdown-content"><a href=/tags/ title><i class='fas fa fa-tag'></i> 标签 </a><a href=/categories/ title><i class='fas fa fa-th'></i> 分类</a></div></div><a class=menu-item href=/friends/><i class='fas fa fa-users'></i> 友链</a><div class=dropdown><a href=javascript:void(0); class="menu-item menu-more dropbtn" title><i class='fas fa fa-angle-double-down'></i> 更多</a><div class="menu-more-content dropdown-content"><a href=/tools/ title><i class='fas fa fa-cubes'></i> 工具 </a><a href=/about/ title><i class='fas fa fa-address-card'></i> 关于 </a><a href=/timeline/ title><i class='fas fa fa-building'></i> 建站 </a><a href=/index.xml/ title><i class='fas fa fa-rss'></i> RSS</a></div></div><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=搜索文章内容 id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin"></i></span>
</span><a href=https://travellings.link target=_blank class=menu-item rel=noopener title=开往-友链接力><i class='fas fa-fw fa-subway'></i></a>
<a href=https://rssblog.cn/bbing class=menu-item target=_blank rel=noopener title=RSSBlog><i class='fas fa-fw fa-inbox'></i></a>
<a href=https://www.foreverblog.cn/go.html class=menu-item target=_blank rel=noopener title=穿梭虫洞><i class="fas fa-fw fa-life-ring" title=穿梭虫洞-随机访问十年之约友链博客></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Bing's Blog">Bing's Blog</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章内容 id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></div><a href=/posts/ class=menu-item title><i class='fas fa fa-archive'></i> 归档</a>
<a href=/tags/ class=menu-item title><i class='fas fa fa-tag'></i> 标签</a>
<a href=/categories/ class=menu-item title><i class='fas fa fa-th'></i> 分类</a>
<a class=menu-item href=/friends/><i class='fas fa fa-users'></i> 友链</a>
<a href=/tools/ class=menu-item title><i class='fas fa fa-cubes'></i> 工具</a>
<a href=/about/ class=menu-item title><i class='fas fa fa-address-card'></i> 关于</a>
<a href=/timeline/ class=menu-item title><i class='fas fa fa-building'></i> 建站</a>
<a href=/index.xml/ class=menu-item title><i class='fas fa fa-rss'></i> RSS</a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class=single-title>初探Linux文件和文件系统<sup>
<a id=reader-button-title title=阅读模式><i class="fa fa-book fa-fw"></i></a></sup></h1><div class=post-meta><div class=post-meta-line></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2021-05-14>2021-05-14</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 6332 字&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 13 分钟&nbsp;</div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#文件>文件</a><ul><li><a href=#ls>ls</a></li><li><a href=#文件权限>文件权限</a></li><li><a href=#stat>stat</a></li></ul></li><li><a href=#文件系统>文件系统</a><ul><li><a href=#inode>inode</a><ul><li><a href=#pipe>pipe</a></li></ul></li><li><a href=#block>block</a></li><li><a href=#super_block>super_block</a></li><li><a href=#dentry>dentry</a></li></ul></li><li><a href=#小结>小结</a></li><li><a href=#遗留问题todo>遗留问题(TODO)</a></li><li><a href=#参考链接>参考链接</a></li></ul></nav></div></div><div class=content id=content><p>前面的文章讲了进程控制和进程通信的内容, 在学习和准备这些内容的过程中, 发现对Linux文件系统并不是很熟悉. 此前对Linux文件系统的理解非常肤浅, 嘴上会说"万物皆是文件"的话, 但是并不是很理解Linux的文件系统. 这里插入一篇文章, 学习和整理一下Linux文件系统的内容.</p><h2 id=文件>文件</h2><blockquote><p>这一节作为引言, 先看看我们日常操作的一些结果在深入内核去看会更容易理解.</p></blockquote><h3 id=ls>ls</h3><p>在Linux上可以使用ls命令查看对应路径下的文件, 比如ls -la查看当前路径下的文件:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>drwxrwxr-x 3 mi mi 4096 4月  27 19:32 .
</span></span><span class=line><span class=cl>drwxrwxr-x 7 mi mi 4096 4月  26 10:02 ..
</span></span><span class=line><span class=cl>-rw-rw-r-- 1 mi mi    0 4月  26 10:03 file_attr
</span></span><span class=line><span class=cl>drwxrwxr-x 2 mi mi 4096 4月  27 19:32 file_dic
</span></span></code></pre></td></tr></table></div></div><p>每一行代表一个文件或者一个目录, 一行大概可以分成七块区域, 以文件file_attr为例: <code>-rw-rw-r--</code>, <code>1</code>, <code>mi</code>, <code>mi</code>, <code>0</code>, <code>4月 26 10:03</code>, <code>file_attr</code>.</p><p>首先可以理解, <code>4月 26 10:03</code>, <code>file_attr</code>代表的是时间和文件名, 且时间是在每次写入文件时才会改变, 打开文件时这个时间是不变的, 所以这里的时间就是最后修改的时间. 其他的部分是什么意思呢?</p><p><code>-rw-rw-r--</code>代表文件的权限, 在Linux系统中, 一切操作都有比较严格的权限控制, 对一个文件来说, 它可以读/写/执行, 所以Linux使用<code>rwx</code>三个字符分别表示文件的读写和执行权限, 实际上是一个mask, 用3bits表示, 从高到底分别是读写和执行, 所以可以用7表示读写执行权限, 6表示读写权限, 1表示执行权限等等. 针对当前用户, 当前用户组, 其他用户组可以设置不同的读/写/执行权限.</p><p>数字<code>1</code>则表示有几个文件link了这个文件, 表示的是硬链接. <code>mi mi</code>两项代表这个文件的拥有者和拥有者的用户组. 数字<code>0</code>则代表文件内容的大小, 因为没有向文件中添加内容, 所以大小为0.</p><p>注意到当前目录表示<code>.</code>和上一级目录表示<code>..</code>都被ls打印出来了, 其是这两种目录都是文件. 在Linux中目录和文件都被当做文件, 只是属于不同的文件类型.</p><h3 id=文件权限>文件权限</h3><p>普通文件的文件权限比较好理解, 这里就不再验证了. 目录文件的文件权限如何理解呢?</p><p>对某个目录./filesystem/, 向关闭所有权限:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>chmod 000 ./filesystem/
</span></span></code></pre></td></tr></table></div></div><p>这时候再查看就会报错:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$ ls ./filesystem/
</span></span><span class=line><span class=cl>ls: cannot open directory &#39;./filesystem/&#39;: Permission denied
</span></span></code></pre></td></tr></table></div></div><p>添加读写权限:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>chmod 600 ./filesystem/
</span></span></code></pre></td></tr></table></div></div><p>这时候再查看依然会有一些错误:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$ ls  ./filesystem/
</span></span><span class=line><span class=cl>ls: cannot access &#39;./filesystem/file_attr&#39;: Permission denied
</span></span><span class=line><span class=cl>ls: cannot access &#39;./filesystem/file_dic&#39;: Permission denied
</span></span><span class=line><span class=cl>file_attr  file_dic
</span></span></code></pre></td></tr></table></div></div><p>列举除了目录下的文件, 但是对目录下的文件没有访问权限(继续往下看)?</p><p>如果添加读写执行权限, 这一切都正常了:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$ ls -la filesystem/
</span></span><span class=line><span class=cl>total 12
</span></span><span class=line><span class=cl>drwxrwxrwx  3 mi mi 4096 5月  11 20:36 .
</span></span><span class=line><span class=cl>drwxrwxrwx 11 mi mi 4096 5月   8 20:32 ..
</span></span><span class=line><span class=cl>-rw-rw-r--  1 mi mi    0 5月   8 20:32 file_attr
</span></span><span class=line><span class=cl>drwxrwxr-x  2 mi mi 4096 5月  11 20:36 file_dic
</span></span></code></pre></td></tr></table></div></div><p>可以继续类似实验, 总的来说, 目录同样需要读写执行权限, 如果权限不对, 可以会有无法打开文件, 无法ls文件, 无法添加文件, 无法cd到目录等问题.</p><h3 id=stat>stat</h3><p>可以使用stat查看文件的详细信息, 比如下面两段:</p><p>当前目录的信息:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$ stat .
</span></span><span class=line><span class=cl>  File: .
</span></span><span class=line><span class=cl>  Size: 4096            Blocks: 8          IO Block: 4096   directory
</span></span><span class=line><span class=cl>Device: 802h/2050d      Inode: 136185988   Links: 3
</span></span><span class=line><span class=cl>Access: (0775/drwxrwxr-x)  Uid: ( 1000/      mi)   Gid: ( 1000/      mi)
</span></span><span class=line><span class=cl>Access: 2021-05-11 20:36:13.625994262 +0800
</span></span><span class=line><span class=cl>Modify: 2021-05-11 20:36:12.533997328 +0800
</span></span><span class=line><span class=cl>Change: 2021-05-11 20:36:12.533997328 +0800
</span></span><span class=line><span class=cl> Birth: -
</span></span></code></pre></td></tr></table></div></div><p>某个普通文件的信息:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$ stat ./file_attr
</span></span><span class=line><span class=cl>  File: ./file_attr
</span></span><span class=line><span class=cl>  Size: 0               Blocks: 0          IO Block: 4096   regular empty file
</span></span><span class=line><span class=cl>Device: 802h/2050d      Inode: 136185989   Links: 1
</span></span><span class=line><span class=cl>Access: (0664/-rw-rw-r--)  Uid: ( 1000/      mi)   Gid: ( 1000/      mi)
</span></span><span class=line><span class=cl>Access: 2021-05-12 13:04:02.996823303 +0800
</span></span><span class=line><span class=cl>Modify: 2021-05-08 20:32:55.623371621 +0800
</span></span><span class=line><span class=cl>Change: 2021-05-08 20:32:55.623371621 +0800
</span></span><span class=line><span class=cl> Birth: -
</span></span></code></pre></td></tr></table></div></div><p>两段信息结构相同, 包含了名称, 大小, link, 日期, 权限等信息.</p><p>Inode项是inode的id, inode是实际存储文件信息和内容的结构体, 对操作系统来说, 文件名是陌生的, 操作系统看文件是看的inode. 通过ls -i也可以查看文件的inode id.</p><p>目录和文件都有inode.</p><h2 id=文件系统>文件系统</h2><blockquote><p>问题: 文件是怎么储存在磁盘上, 又是如何加载进内存的?</p></blockquote><p>如果让我们自己设计磁盘存储文件的方式, 可能会想到两种:</p><ol><li>文件存储在磁盘连续的空间上;</li><li>文件分片存储在磁盘连续的空间上;</li></ol><p>如果是第一种存储方式, 那么可能会遇到一些问题, 比如磁盘上存储了很多很小的文件, 假设只有1KB, 之后我们删除其中的一些文件, 那么在磁盘上就会有很多坑坑洼洼的小碎片, 如果这时候我们要存储一个比较大文件, 但是没有连续的空间了, 该怎么办呢? 这时候我们可以"整理"一下磁盘, 把分散的文件移动到一起, 这样就会有大的连续的存储空间了. 但是, 这样必然会设计大量的搬运操作, 大大提高系统功耗, 降低系统的效率, 且容易损坏磁盘.</p><p>第二种方式这是类比链表(或者类比内存RAM), 将磁盘分成很多很多的小块, 比如每块只有1KB, 那么文件就存储在这些小块上. 比如, 文件小于1KB, 则一块空间就行了, 文件大于1KB, 则每1KB都存储在一小块空间上, 不需要连续. 相比于第一种方法, 第二种方法原生地就把磁盘分割成了很多小块, 就算有超大文件需要存储也用担心有没有足够大小的连续空间的问题. 但是第二种方法就需要存储每个小块的地址, 并且需要知道小块的顺序关系, 而第一种方法一般只需要存储一个地址和文件大小就行了.</p><p>一般使用的是第二种存储方式, 按照映射关系又可以分为不同的文件系统, 有的类似树状结构存储, 有的类似链表结构存储.</p><p>链式存储:</p><p><figure><a class=lightgallery href=https://bu.dusays.com/2022/06/26/62b87a9d8ab66.png title=&amp;ldquo;链式存储&amp;rdquo; data-thumbnail=https://bu.dusays.com/2022/06/26/62b87a9d8ab66.png data-sub-html="<h2>链式存储</h2><p>&amp;ldquo;链式存储&amp;rdquo;</p>"><img class=lazyload src=/svg/loading.min.svg data-src=https://bu.dusays.com/2022/06/26/62b87a9d8ab66.png data-srcset="https://bu.dusays.com/2022/06/26/62b87a9d8ab66.png, https://bu.dusays.com/2022/06/26/62b87a9d8ab66.png 1.5x, https://bu.dusays.com/2022/06/26/62b87a9d8ab66.png 2x" data-sizes=auto alt=https://bu.dusays.com/2022/06/26/62b87a9d8ab66.png></a><figcaption class=image-caption>链式存储</figcaption></figure></p><p>树状存储:</p><p><figure><a class=lightgallery href=https://bu.dusays.com/2022/06/26/62b87aa068ebe.png title=&amp;ldquo;树状存储&amp;rdquo; data-thumbnail=https://bu.dusays.com/2022/06/26/62b87aa068ebe.png data-sub-html="<h2>树状存储</h2><p>&amp;ldquo;树状存储&amp;rdquo;</p>"><img class=lazyload src=/svg/loading.min.svg data-src=https://bu.dusays.com/2022/06/26/62b87aa068ebe.png data-srcset="https://bu.dusays.com/2022/06/26/62b87aa068ebe.png, https://bu.dusays.com/2022/06/26/62b87aa068ebe.png 1.5x, https://bu.dusays.com/2022/06/26/62b87aa068ebe.png 2x" data-sizes=auto alt=https://bu.dusays.com/2022/06/26/62b87aa068ebe.png></a><figcaption class=image-caption>树状存储</figcaption></figure></p><h3 id=inode>inode</h3><p>inode可以认为是操作系统眼中的文件, 磁盘或者内存上都会有inode, 这里是内存上(VFS)的inode, 是一个结构体.</p><p>inode在Linux上是已经分配好的, 磁盘上会有一块固定区域存放inode的bitmap, 这也意味着inode的数量是有限的, 在硬盘格式化的时候就已经确定好了. 通过<code>df -i</code>可以看到系统各个分区的inode总数和使用数.</p><p>所以我们可能会遇到的一个问题是, 硬盘空间明明还有很多, 但是已经无法创建新的文件了, 这时候就可以考虑是不是inode没有了.</p><p><a href=https://code.woboq.org/linux/linux/include/linux/fs.h.html#inode target=_blank rel="noopener noreffer">在线看inode结构</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * Keep mostly read-only and often accessed (especially for
</span></span></span><span class=line><span class=cl><span class=cm> * the RCU path lookup and &#39;stat&#39; data) fields at the beginning
</span></span></span><span class=line><span class=cl><span class=cm> * of the &#39;struct inode&#39;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=n>inode</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>umode_t</span>				<span class=n>i_mode</span><span class=p>;</span>               <span class=c1>// 文件权限, rwx等
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=kt>unsigned</span> <span class=kt>short</span>		<span class=n>i_opflags</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>kuid_t</span>				<span class=n>i_uid</span><span class=p>;</span>                <span class=c1>// 文件所属用户id, ls可以看到
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=n>kgid_t</span>				<span class=n>i_gid</span><span class=p>;</span>                <span class=c1>// 文件所属用户组id, ls可以看到
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=kt>unsigned</span> <span class=kt>int</span>		<span class=n>i_flags</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=cp>#ifdef CONFIG_FS_POSIX_ACL
</span></span></span><span class=line><span class=cl><span class=cp></span>	<span class=k>struct</span> <span class=n>posix_acl</span>	<span class=o>*</span><span class=n>i_acl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>posix_acl</span>	<span class=o>*</span><span class=n>i_default_acl</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>	<span class=k>const</span> <span class=k>struct</span> <span class=n>inode_operations</span>	<span class=o>*</span><span class=n>i_op</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>super_block</span>				<span class=o>*</span><span class=n>i_sb</span><span class=p>;</span>        <span class=c1>// 指向了super block, 对同一个文件系统是唯一的
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>struct</span> <span class=n>address_space</span>			<span class=o>*</span><span class=n>i_mapping</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=c1>//......
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=cm>/* Stat data, not accessed from path walking */</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>long</span>		<span class=n>i_ino</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>	 * Filesystems may only read i_nlink directly.  They shall use the
</span></span></span><span class=line><span class=cl><span class=cm>	 * following functions for modification:
</span></span></span><span class=line><span class=cl><span class=cm>	 *
</span></span></span><span class=line><span class=cl><span class=cm>	 *    (set|clear|inc|drop)_nlink
</span></span></span><span class=line><span class=cl><span class=cm>	 *    inode_(inc|dec)_link_count
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=k>union</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>const</span> <span class=kt>unsigned</span> <span class=kt>int</span> 	<span class=n>i_nlink</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=kt>unsigned</span> <span class=kt>int</span> 		<span class=n>__i_nlink</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>};</span>
</span></span><span class=line><span class=cl>	<span class=n>dev_t</span>				<span class=n>i_rdev</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>loff_t</span>				<span class=n>i_size</span><span class=p>;</span>         <span class=c1>// 文件大小
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>struct</span> <span class=n>timespec64</span>	<span class=n>i_atime</span><span class=p>;</span>        <span class=c1>// 操作时间相关
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>struct</span> <span class=n>timespec64</span>	<span class=n>i_mtime</span><span class=p>;</span>        <span class=c1>// 操作时间相关
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>struct</span> <span class=n>timespec64</span>	<span class=n>i_ctime</span><span class=p>;</span>        <span class=c1>// 操作时间相关
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=n>spinlock_t</span>			<span class=n>i_lock</span><span class=p>;</span>	<span class=cm>/* i_blocks, i_bytes, maybe i_size */</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>short</span>      <span class=n>i_bytes</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>u8</span>					<span class=n>i_blkbits</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>u8</span>					<span class=n>i_write_hint</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>blkcnt_t</span>			<span class=n>i_blocks</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=c1>//......
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>union</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>struct</span> <span class=n>pipe_inode_info</span>	<span class=o>*</span><span class=n>i_pipe</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=k>struct</span> <span class=n>block_device</span>		<span class=o>*</span><span class=n>i_bdev</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=k>struct</span> <span class=n>cdev</span>				<span class=o>*</span><span class=n>i_cdev</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=kt>char</span>					<span class=o>*</span><span class=n>i_link</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=kt>unsigned</span>				<span class=n>i_dir_seq</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>};</span>                        	<span class=c1>// inode的类型, 比如可以是一个pipe或者link等, 这时候可以不需要磁盘上具体的文件内容, 仅inode结构就可以了
</span></span></span><span class=line><span class=cl><span class=c1>//......
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span> <span class=n>__randomize_layout</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>从这个结构体中我们可以看到, inode基本包含一个文件的所有信息, 文件大小, 访问时间, 文件权限等等, 但是<strong>不包括文件名</strong>.</p><p>结构体用一个union表示了文件的类型, 比如是pipe文件(i_pipe)还是link的文件(i_link)等等, 因为一个文件同时只能属于一种类型, 不可能既是link有时pipe等等, 所以只需要使用union表示即可.</p><p>我们使用的ls和stat等命令就可以打印inode的基本信息.</p><p>以下是文件系统的inode, 是在磁盘上的结构, 比如<a href=https://code.woboq.org/linux/linux/fs/ext4/ext4.h.html target=_blank rel="noopener noreffer">ext4</a>文件系统:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * Structure of an inode on the disk
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=n>ext4_inode</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>__le16</span>	<span class=n>i_mode</span><span class=p>;</span>		<span class=cm>/* File mode */</span>
</span></span><span class=line><span class=cl>	<span class=n>__le16</span>	<span class=n>i_uid</span><span class=p>;</span>		<span class=cm>/* Low 16 bits of Owner Uid */</span>
</span></span><span class=line><span class=cl>	<span class=n>__le32</span>	<span class=n>i_size_lo</span><span class=p>;</span>	<span class=cm>/* Size in bytes */</span>
</span></span><span class=line><span class=cl>	<span class=n>__le32</span>	<span class=n>i_atime</span><span class=p>;</span>	<span class=cm>/* Access time */</span>
</span></span><span class=line><span class=cl>	<span class=n>__le32</span>	<span class=n>i_ctime</span><span class=p>;</span>	<span class=cm>/* Inode Change time */</span>
</span></span><span class=line><span class=cl>	<span class=n>__le32</span>	<span class=n>i_mtime</span><span class=p>;</span>	<span class=cm>/* Modification time */</span>
</span></span><span class=line><span class=cl>	<span class=n>__le32</span>	<span class=n>i_dtime</span><span class=p>;</span>	<span class=cm>/* Deletion Time */</span>
</span></span><span class=line><span class=cl>	<span class=n>__le16</span>	<span class=n>i_gid</span><span class=p>;</span>		<span class=cm>/* Low 16 bits of Group Id */</span>
</span></span><span class=line><span class=cl>	<span class=n>__le16</span>	<span class=n>i_links_count</span><span class=p>;</span>	<span class=cm>/* Links count */</span>
</span></span><span class=line><span class=cl>	<span class=n>__le32</span>	<span class=n>i_blocks_lo</span><span class=p>;</span>	<span class=cm>/* Blocks count */</span>
</span></span><span class=line><span class=cl>	<span class=n>__le32</span>	<span class=n>i_flags</span><span class=p>;</span>	<span class=cm>/* File flags */</span>
</span></span><span class=line><span class=cl><span class=c1>//.......
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=n>__le32</span>	<span class=n>i_block</span><span class=p>[</span><span class=n>EXT4_N_BLOCKS</span><span class=p>];</span><span class=cm>/* Pointers to blocks */</span>
</span></span><span class=line><span class=cl>	<span class=n>__le32</span>	<span class=n>i_generation</span><span class=p>;</span>	<span class=cm>/* File version (for NFS) */</span>
</span></span><span class=line><span class=cl>	<span class=n>__le32</span>	<span class=n>i_file_acl_lo</span><span class=p>;</span>	<span class=cm>/* File ACL */</span>
</span></span><span class=line><span class=cl>	<span class=n>__le32</span>	<span class=n>i_size_high</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>__le32</span>	<span class=n>i_obso_faddr</span><span class=p>;</span>	<span class=cm>/* Obsoleted fragment address */</span>
</span></span><span class=line><span class=cl><span class=c1>//......
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><p>在这里也保存了和文件相关的一些基本信息, 比如mode/时间等等, 同时文件系统的inode也包含<code>i_block</code>这个成员, <code>i_block</code>就可以指向磁盘上真正的block.</p><p>TODO: 虚拟文件系统的inode是如何与文件系统inode关联的.</p><h4 id=pipe>pipe</h4><p>以下展示的是inode如何描述一个pipe:</p><p><figure><a class=lightgallery href=https://bu.dusays.com/2022/06/26/62b87aa30cc5f.png title=&amp;ldquo;pipe&amp;rdquo; data-thumbnail=https://bu.dusays.com/2022/06/26/62b87aa30cc5f.png data-sub-html="<h2>pipe</h2><p>&amp;ldquo;pipe&amp;rdquo;</p>"><img class=lazyload src=/svg/loading.min.svg data-src=https://bu.dusays.com/2022/06/26/62b87aa30cc5f.png data-srcset="https://bu.dusays.com/2022/06/26/62b87aa30cc5f.png, https://bu.dusays.com/2022/06/26/62b87aa30cc5f.png 1.5x, https://bu.dusays.com/2022/06/26/62b87aa30cc5f.png 2x" data-sizes=auto alt=https://bu.dusays.com/2022/06/26/62b87aa30cc5f.png></a><figcaption class=image-caption>pipe</figcaption></figure></p><blockquote><p>前面的文章说过: Linux管道是一个文件, 但是没有具体的文件内容, 在struct inode中就可以看到inode会有一个成员指向pipe_inode_info.</p></blockquote><p>pipe_inode_info结构体如下, 这里会关注tmp_page和bufs, 分别指向了page缓存和pipe的环形缓存队列. 并且这两者都是以page为单位的, 所以这里可以看到, pipe的最小单位是page, 并且pipe结构体中有一个锁, 所以可以猜测, pipe的原子操作是以page(已缓存的tmp_page)为单位(之前的文章中已经有过这个结论).</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> *	struct pipe_inode_info - a linux kernel pipe
</span></span></span><span class=line><span class=cl><span class=cm> *	@mutex: mutex protecting the whole thing
</span></span></span><span class=line><span class=cl><span class=cm> *	@wait: reader/writer wait point in case of empty/full pipe
</span></span></span><span class=line><span class=cl><span class=cm> *	@nrbufs: the number of non-empty pipe buffers in this pipe
</span></span></span><span class=line><span class=cl><span class=cm> *	@buffers: total number of buffers (should be a power of 2)
</span></span></span><span class=line><span class=cl><span class=cm> *	@curbuf: the current pipe buffer entry
</span></span></span><span class=line><span class=cl><span class=cm> *	@tmp_page: cached released page
</span></span></span><span class=line><span class=cl><span class=cm> *	@readers: number of current readers of this pipe
</span></span></span><span class=line><span class=cl><span class=cm> *	@writers: number of current writers of this pipe
</span></span></span><span class=line><span class=cl><span class=cm> *	@files: number of struct file referring this pipe (protected by -&gt;i_lock)
</span></span></span><span class=line><span class=cl><span class=cm> *	@waiting_writers: number of writers blocked waiting for room
</span></span></span><span class=line><span class=cl><span class=cm> *	@r_counter: reader counter
</span></span></span><span class=line><span class=cl><span class=cm> *	@w_counter: writer counter
</span></span></span><span class=line><span class=cl><span class=cm> *	@fasync_readers: reader side fasync
</span></span></span><span class=line><span class=cl><span class=cm> *	@fasync_writers: writer side fasync
</span></span></span><span class=line><span class=cl><span class=cm> *	@bufs: the circular array of pipe buffers
</span></span></span><span class=line><span class=cl><span class=cm> *	@user: the user who created this pipe
</span></span></span><span class=line><span class=cl><span class=cm> **/</span>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=n>pipe_inode_info</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>mutex</span> <span class=n>mutex</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>wait_queue_head_t</span> <span class=n>wait</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>nrbufs</span><span class=p>,</span> <span class=n>curbuf</span><span class=p>,</span> <span class=n>buffers</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>readers</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>writers</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>files</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>waiting_writers</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>r_counter</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>w_counter</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>page</span> <span class=o>*</span><span class=n>tmp_page</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>fasync_struct</span> <span class=o>*</span><span class=n>fasync_readers</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>fasync_struct</span> <span class=o>*</span><span class=n>fasync_writers</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>pipe_buffer</span> <span class=o>*</span><span class=n>bufs</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>user_struct</span> <span class=o>*</span><span class=n>user</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><p>pipe_buffer的结构内容:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> *	struct pipe_buffer - a linux kernel pipe buffer
</span></span></span><span class=line><span class=cl><span class=cm> *	@page: the page containing the data for the pipe buffer
</span></span></span><span class=line><span class=cl><span class=cm> *	@offset: offset of data inside the @page
</span></span></span><span class=line><span class=cl><span class=cm> *	@len: length of data inside the @page
</span></span></span><span class=line><span class=cl><span class=cm> *	@ops: operations associated with this buffer. See @pipe_buf_operations.
</span></span></span><span class=line><span class=cl><span class=cm> *	@flags: pipe buffer flags. See above.
</span></span></span><span class=line><span class=cl><span class=cm> *	@private: private data owned by the ops.
</span></span></span><span class=line><span class=cl><span class=cm> **/</span>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=n>pipe_buffer</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>page</span> <span class=o>*</span><span class=n>page</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>offset</span><span class=p>,</span> <span class=n>len</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>const</span> <span class=k>struct</span> <span class=n>pipe_buf_operations</span> <span class=o>*</span><span class=n>ops</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>flags</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>private</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><p>pipe_buffer描述了整个pipe的page机构, 偏移量, 操作函数等信息. page还有更复杂的结构, 这里就先不研究了. 总之, 我们还是可以看出pipe与page之间的关系.</p><h3 id=block>block</h3><p>TODO: inode如何访问到block的需要再确认.</p><p>block是磁盘存储内容的最小单位, 计算机按照block为单位读取磁盘内容. (类比内存按照page为最小单位读写.) 每次读写一个block都会触发一个IO操作.</p><p>这里说明的是, inode可以直接将内容存储在block中, 这样一次跳转就可以访问到磁盘的内容, 但是如果直接指向block就会导致文件的最大大小受到限制.</p><p>所以inode会有多种机制, 可以直接指向保存内容的block, 也可以指向一个中间block, 这个中间block会指向多个保存有文件内容的block, 或者这个中间block再指向多个次中间block, 这些block再指向保存有文件内容的block.</p><p>这样的好处就是不需要过大的inode, inode只需极少数的block指针, 就可以存储很大的文件. 坏处是多级指向会降低对大文件读写的效率, 因为计算机按照block读取文件内容, 多级指向就会增加IO访问次数, 降低读写效率.</p><p>以下是文件系统inode到block的多级指向结构:</p><p><figure><a class=lightgallery href=https://bu.dusays.com/2022/06/26/62b87aa57c86e.png title=&amp;ldquo;inode-block&amp;rdquo; data-thumbnail=https://bu.dusays.com/2022/06/26/62b87aa57c86e.png data-sub-html="<h2>inode-block</h2><p>&amp;ldquo;inode-block&amp;rdquo;</p>"><img class=lazyload src=/svg/loading.min.svg data-src=https://bu.dusays.com/2022/06/26/62b87aa57c86e.png data-srcset="https://bu.dusays.com/2022/06/26/62b87aa57c86e.png, https://bu.dusays.com/2022/06/26/62b87aa57c86e.png 1.5x, https://bu.dusays.com/2022/06/26/62b87aa57c86e.png 2x" data-sizes=auto alt=https://bu.dusays.com/2022/06/26/62b87aa57c86e.png></a><figcaption class=image-caption>inode-block</figcaption></figure></p><p>通过inode和block的指向关系, 我们可以大概算出系统支持的最大文件大小. 假设block大小是4KB, 那么通过inode直接指向block, 一个文件最大大概是4KB. 通过一级指向, 那么一个文件最大大概是$(4KB / 64b) * 4KB = 256MB$. 通过二级指向, 一个文件最大大概有$((4KB / 64b) * 4KB / 64b) * 4KB = 16GB$. 上述是比较简单的计算, 但是计算方式基本如此, 供参考.</p><h3 id=super_block>super_block</h3><p>super block是内核直接管理的block, 内核可以直接拿到这个block的内容. 一个文件系统负责操作一个super block.</p><p><a href=https://code.woboq.org/linux/linux/include/linux/fs.h.html#super_block target=_blank rel="noopener noreffer">在线看super_block</a>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=k>struct</span> <span class=n>super_block</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>list_head</span>	<span class=n>s_list</span><span class=p>;</span>		<span class=cm>/* Keep this first */</span>
</span></span><span class=line><span class=cl>	<span class=n>dev_t</span>				<span class=n>s_dev</span><span class=p>;</span>		<span class=cm>/* search index; _not_ kdev_t */</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>char</span>		<span class=n>s_blocksize_bits</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>long</span>		<span class=n>s_blocksize</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>loff_t</span>				<span class=n>s_maxbytes</span><span class=p>;</span>	<span class=cm>/* Max file size */</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>file_system_type</span>			<span class=o>*</span><span class=n>s_type</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>const</span> <span class=k>struct</span> <span class=n>super_operations</span>	<span class=o>*</span><span class=n>s_op</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>const</span> <span class=k>struct</span> <span class=n>dquot_operations</span>	<span class=o>*</span><span class=n>dq_op</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>const</span> <span class=k>struct</span> <span class=n>quotactl_ops</span>		<span class=o>*</span><span class=n>s_qcop</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>const</span> <span class=k>struct</span> <span class=n>export_operations</span> 	<span class=o>*</span><span class=n>s_export_op</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>long</span>		<span class=n>s_flags</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>long</span>		<span class=n>s_iflags</span><span class=p>;</span>	<span class=cm>/* internal SB_I_* flags */</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>long</span>		<span class=n>s_magic</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>dentry</span>		<span class=o>*</span><span class=n>s_root</span><span class=p>;</span>    <span class=c1>// 根结点dentry
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>struct</span> <span class=n>rw_semaphore</span>	<span class=n>s_umount</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span>					<span class=n>s_count</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>atomic_t</span>			<span class=n>s_active</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=c1>//......
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>struct</span> <span class=n>hlist_bl_head</span>	<span class=n>s_roots</span><span class=p>;</span>	<span class=cm>/* alternate root dentries for NFS */</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>list_head</span>		<span class=n>s_mounts</span><span class=p>;</span>	<span class=cm>/* list of mounts; _not_ for fs use */</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>block_device</span>		<span class=o>*</span><span class=n>s_bdev</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>backing_dev_info</span> <span class=o>*</span><span class=n>s_bdi</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>mtd_info</span>			<span class=o>*</span><span class=n>s_mtd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>hlist_node</span>		<span class=n>s_instances</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>int</span>			<span class=n>s_quota_types</span><span class=p>;</span>	<span class=cm>/* Bitmask of supported quota types */</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>quota_info</span>		<span class=n>s_dquot</span><span class=p>;</span>		<span class=cm>/* Diskquota specific options */</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>sb_writers</span>		<span class=n>s_writers</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=c1>//......
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=kt>char</span>			<span class=n>s_id</span><span class=p>[</span><span class=mi>32</span><span class=p>];</span>	<span class=cm>/* Informational name */</span>
</span></span><span class=line><span class=cl>	<span class=n>uuid_t</span>			<span class=n>s_uuid</span><span class=p>;</span>		<span class=cm>/* UUID */</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>int</span>	<span class=n>s_max_links</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>fmode_t</span>			<span class=n>s_mode</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>	 * The next field is for VFS *only*. No filesystems have any business
</span></span></span><span class=line><span class=cl><span class=cm>	 * even looking at it. You had been warned.
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>mutex</span> <span class=n>s_vfs_rename_mutex</span><span class=p>;</span>	<span class=cm>/* Kludge */</span>
</span></span><span class=line><span class=cl>	<span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>	 * Filesystem subtype.  If non-empty the filesystem type field
</span></span></span><span class=line><span class=cl><span class=cm>	 * in /proc/mounts will be &#34;type.subtype&#34;
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>s_subtype</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>const</span> <span class=k>struct</span> <span class=n>dentry_operations</span> <span class=o>*</span><span class=n>s_d_op</span><span class=p>;</span> <span class=cm>/* default d_op for dentries */</span>
</span></span><span class=line><span class=cl>	<span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>	 * Saved pool identifier for cleancache (-1 means none)
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>cleancache_poolid</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>shrinker</span> <span class=n>s_shrink</span><span class=p>;</span>	<span class=cm>/* per-sb shrinker handle */</span>
</span></span><span class=line><span class=cl>	<span class=cm>/* Number of inodes with nlink == 0 but still referenced */</span>
</span></span><span class=line><span class=cl>	<span class=n>atomic_long_t</span> <span class=n>s_remove_count</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=cm>/* Pending fsnotify inode refs */</span>
</span></span><span class=line><span class=cl>	<span class=n>atomic_long_t</span> <span class=n>s_fsnotify_inode_refs</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=cm>/* Being remounted read-only */</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>s_readonly_remount</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=cm>/* AIO completions deferred from interrupt context */</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>workqueue_struct</span> <span class=o>*</span><span class=n>s_dio_done_wq</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>hlist_head</span> <span class=n>s_pins</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>	 * Owning user namespace and default context in which to
</span></span></span><span class=line><span class=cl><span class=cm>	 * interpret filesystem uids, gids, quotas, device nodes,
</span></span></span><span class=line><span class=cl><span class=cm>	 * xattrs and security labels.
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>user_namespace</span> <span class=o>*</span><span class=n>s_user_ns</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>	 * The list_lru structure is essentially just a pointer to a table
</span></span></span><span class=line><span class=cl><span class=cm>	 * of per-node lru lists, each of which has its own spinlock.
</span></span></span><span class=line><span class=cl><span class=cm>	 * There is no need to put them into separate cachelines.
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>list_lru</span>		<span class=n>s_dentry_lru</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>list_lru</span>		<span class=n>s_inode_lru</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>rcu_head</span>		<span class=n>rcu</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>work_struct</span>	<span class=n>destroy_work</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>mutex</span>		<span class=n>s_sync_lock</span><span class=p>;</span>	<span class=cm>/* sync serialisation lock */</span>
</span></span><span class=line><span class=cl>	<span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>	 * Indicates how deep in a filesystem stack this SB is
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>s_stack_depth</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=cm>/* s_inode_list_lock protects s_inodes */</span>
</span></span><span class=line><span class=cl>	<span class=n>spinlock_t</span>		<span class=n>s_inode_list_lock</span> <span class=n>____cacheline_aligned_in_smp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>list_head</span>	<span class=n>s_inodes</span><span class=p>;</span>	<span class=cm>/* all inodes */</span>
</span></span><span class=line><span class=cl>	<span class=n>spinlock_t</span>		<span class=n>s_inode_wblist_lock</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>list_head</span>	<span class=n>s_inodes_wb</span><span class=p>;</span>	<span class=cm>/* writeback inodes */</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=n>__randomize_layout</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>很多成员不太懂什么意思, 这里先关注s_root这个成员, s_root指向的是一个dentry, 从名字也可以看出是指向的根结点的dentry, 也就是<code>/</code>目录.</p><p>因为每个inode都有一个指向super block的指针, 所以每个inode都可以间接访问到根结点, 这也为文件系统的访问奠定了基础.</p><p><figure><a class=lightgallery href=https://bu.dusays.com/2022/06/26/62b87aa96c462.png title=&amp;ldquo;inode-super_block&amp;rdquo; data-thumbnail=https://bu.dusays.com/2022/06/26/62b87aa96c462.png data-sub-html="<h2>inode-super_block</h2><p>&amp;ldquo;inode-super_block&amp;rdquo;</p>"><img class=lazyload src=/svg/loading.min.svg data-src=https://bu.dusays.com/2022/06/26/62b87aa96c462.png data-srcset="https://bu.dusays.com/2022/06/26/62b87aa96c462.png, https://bu.dusays.com/2022/06/26/62b87aa96c462.png 1.5x, https://bu.dusays.com/2022/06/26/62b87aa96c462.png 2x" data-sizes=auto alt=https://bu.dusays.com/2022/06/26/62b87aa96c462.png></a><figcaption class=image-caption>inode-super_block</figcaption></figure></p><p>下面来看dentry的结构.</p><h3 id=dentry>dentry</h3><p>dentry是一个目录的结构表示:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=k>struct</span> <span class=n>dentry</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=cm>/* RCU lookup touched fields */</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>int</span> 	<span class=n>d_flags</span><span class=p>;</span>		<span class=cm>/* protected by d_lock */</span>
</span></span><span class=line><span class=cl>	<span class=n>seqcount_t</span> 		<span class=n>d_seq</span><span class=p>;</span>			<span class=cm>/* per dentry seqlock */</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>hlist_bl_node</span> <span class=n>d_hash</span><span class=p>;</span>	<span class=cm>/* lookup hash list */</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>dentry</span>	 	<span class=o>*</span><span class=n>d_parent</span><span class=p>;</span>		<span class=cm>/* parent directory */</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>qstr</span> 		<span class=n>d_name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>inode</span> 		<span class=o>*</span><span class=n>d_inode</span><span class=p>;</span>		<span class=cm>/* Where the name belongs to - NULL is
</span></span></span><span class=line><span class=cl><span class=cm>					 	* negative */</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>char</span> <span class=n>d_iname</span><span class=p>[</span><span class=n>DNAME_INLINE_LEN</span><span class=p>];</span>	<span class=cm>/* small names */</span>
</span></span><span class=line><span class=cl>	<span class=cm>/* Ref lookup also touches following */</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>lockref</span> <span class=n>d_lockref</span><span class=p>;</span>					<span class=cm>/* per-dentry lock and refcount */</span>
</span></span><span class=line><span class=cl>	<span class=k>const</span> <span class=k>struct</span> <span class=n>dentry_operations</span> <span class=o>*</span><span class=n>d_op</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>super_block</span> <span class=o>*</span><span class=n>d_sb</span><span class=p>;</span>	<span class=cm>/* The root of the dentry tree */</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>d_time</span><span class=p>;</span>		<span class=cm>/* used by d_revalidate */</span>
</span></span><span class=line><span class=cl>	<span class=kt>void</span> <span class=o>*</span><span class=n>d_fsdata</span><span class=p>;</span>				<span class=cm>/* fs-specific data */</span>
</span></span><span class=line><span class=cl>	<span class=k>union</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>struct</span> <span class=n>list_head</span> <span class=n>d_lru</span><span class=p>;</span>		<span class=cm>/* LRU list */</span>
</span></span><span class=line><span class=cl>		<span class=n>wait_queue_head_t</span> <span class=o>*</span><span class=n>d_wait</span><span class=p>;</span>	<span class=cm>/* in-lookup ones only */</span>
</span></span><span class=line><span class=cl>	<span class=p>};</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>list_head</span> <span class=n>d_child</span><span class=p>;</span>	<span class=cm>/* child of parent list */</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>list_head</span> <span class=n>d_subdirs</span><span class=p>;</span>	<span class=cm>/* our children */</span>
</span></span><span class=line><span class=cl>	<span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>	 * d_alias and d_rcu can share memory
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=k>union</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>struct</span> <span class=n>hlist_node</span> <span class=n>d_alias</span><span class=p>;</span>	<span class=cm>/* inode alias list */</span>
</span></span><span class=line><span class=cl>		<span class=k>struct</span> <span class=n>hlist_bl_node</span> <span class=n>d_in_lookup_hash</span><span class=p>;</span>	<span class=cm>/* only for in-lookup ones */</span>
</span></span><span class=line><span class=cl>	 	<span class=k>struct</span> <span class=n>rcu_head</span> <span class=n>d_rcu</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=n>d_u</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=n>__randomize_layout</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>每个dentry都会有指向父结点的指针d_parent, 目录名d_name也存在dentry的结构体中, 还会有一个指向inode的指针d_inode, 这也说明目录和文件之间存在一定的关系. 除此之外, dentry也可以之间访问到自己的兄弟结点d_child和孩子结点d_subdirs, 有了这两个指向关系, 系统就可以做一些缓存操作, 不需要每次都从根结点一层一层访问到当前结点(这里是个人猜测的).</p><p>比如我们要访问某个文件, 一般会按照以下顺序, 先是解析路径, 找到根结点, 一层一层查找, 直到当前结点.</p><p><figure><a class=lightgallery href=https://bu.dusays.com/2022/06/26/62b87aac891df.png title=&amp;ldquo;open&amp;rdquo; data-thumbnail=https://bu.dusays.com/2022/06/26/62b87aac891df.png data-sub-html="<h2>open</h2><p>&amp;ldquo;open&amp;rdquo;</p>"><img class=lazyload src=/svg/loading.min.svg data-src=https://bu.dusays.com/2022/06/26/62b87aac891df.png data-srcset="https://bu.dusays.com/2022/06/26/62b87aac891df.png, https://bu.dusays.com/2022/06/26/62b87aac891df.png 1.5x, https://bu.dusays.com/2022/06/26/62b87aac891df.png 2x" data-sizes=auto alt=https://bu.dusays.com/2022/06/26/62b87aac891df.png></a><figcaption class=image-caption>open</figcaption></figure></p><h2 id=小结>小结</h2><p>这一篇主要是学习一些概念, 很多知识我也是第一次接触, 不是科班出身.</p><p>我们所理解的文件对操作系统来说就是inode, inode存储了文件的基本信息, 包括权限和访问时间等等, 但是inode不包括文件名. inode可以直接访问到文件内容的block, 也可以通过多级跳转访问到文件内容的block, 具体看文件的大小和block大小的关系.</p><p>之前学习过的pipe也是一个inode, 并且没有实际的block, 只是系统内存上的一个inode结构体. 通过pipe结构体, 我们也可以看到pipe缓存是以页为基本单位, 并且会给之加锁, 所以pipe对一个page的读写是原子操作的.</p><p>目录会和dentry关联, dentry也会有指向inode的指针, 所以目录的一些基本信息也会存储在inode中, 这也可以认为目录也是文件. inode可以直接访问到super block, 进而访问到根结点的dentry, 一般来说我们访问一个文件, 系统会从根结点一层一层的追溯到被访问文件的inode. 文件名和inode的对应关系会存在一个表中, 但是存在哪, 如何存的还需进一步学习.</p><h2 id=遗留问题todo>遗留问题(TODO)</h2><ol><li>查看根目录inode信息, 有几项特殊的内容:</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Shell data-lang=Shell><span class=line><span class=cl>ls -ia /
</span></span><span class=line><span class=cl><span class=m>2</span> .  <span class=m>2</span> ..  <span class=m>2</span> dev  <span class=m>2</span> run
</span></span><span class=line><span class=cl><span class=m>1</span> proc  <span class=m>1</span> sys
</span></span></code></pre></td></tr></table></div></div><p><code>.</code> <code>..</code> <code>dev</code>和<code>run</code>的inode id相同;
<code>proc</code>和<code>sys</code>的inode id相同;
为什么他们的inode id相同但是内容会不同?</p><ol start=2><li>inode如何找到block的? 是那个成员指向?</li><li>dentry找到inode的具体过程如何? 是哪些成员参与指向?</li></ol><h2 id=参考链接>参考链接</h2><ol><li><a href=https://zhuanlan.zhihu.com/p/100030111 target=_blank rel="noopener noreffer">Linux中的任务和调度[一]</a></li><li><a href=https://zhuanlan.zhihu.com/p/66794639 target=_blank rel="noopener noreffer">Linux的进程地址空间[一]</a></li><li><a href=https://stackoverflow.com/questions/9305992/if-threads-share-the-same-pid-how-can-they-be-identified target=_blank rel="noopener noreffer">If threads share the same PID, how can they be identified?</a></li><li><a href=https://blog.csdn.net/qq_28351465/article/details/88950311 target=_blank rel="noopener noreffer">从内核角度看Linux 线程和进程的区别</a></li><li><a href=https://code.woboq.org/linux/linux/include/linux/fs.h.html#inode target=_blank rel="noopener noreffer">linux/include/linux/fs.h</a></li><li><a href="https://www.kernel.org/doc/html/latest/filesystems/vfs.html?highlight=inode" target=_blank rel="noopener noreffer">Overview of the Linux Virtual File System</a></li><li><a href="https://www.kernel.org/doc/html/latest/filesystems/ext4/inodes.html?highlight=inode" target=_blank rel="noopener noreffer">Index Nodes</a></li><li><a href="https://www.kernel.org/doc/html/latest/filesystems/overlayfs.html?highlight=inode" target=_blank rel="noopener noreffer">Overlay Filesystem</a></li></ol><p>这一篇知识很浅, 通过写这篇文章对文件系统也有一些粗浅的了解了, 后续还会写一个文件系统的专题.</p></div><div class=post-footer id=post-footer><div class=orlike-box></div><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2021-05-21</span></div><div class=post-info-license><span><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></div><div class=post-info-more><section><i class="fas fa-fw fa-th"></i>&nbsp;<a href=/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/>操作系统</a></section><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/linux/>Linux</a>,&nbsp;<a href=/tags/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/>文件系统</a></section></div><div class=post-nav><a href=/202105/cmake-ndk-crosscomplie/ class=prev rel=prev title=cmake链接ndk交叉编译><i class="fas fa-angle-left fa-fw"></i>cmake链接ndk交叉编译</a>
<a href=/202105/cpp-bitmap/ class=next rel=next title=数据结构与算法之位图>数据结构与算法之位图<i class="fas fa-angle-right fa-fw"></i></a></div></div><div id=my-random-posts><div class=loadingThree><span></span>
<span></span>
<span></span>
<span></span>
<span></span></div></div><div id=comments><div id=giscus class=comment></div><script src=https://giscus.app/client.js data-repo=caibingcheng/comment data-repo-id=R_kgDOHgda4w data-category=Announcements data-category-id=DIC_kwDOHgda484CTfDe data-mapping=og:title data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=/css/giscus.css data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script><noscript>Please enable JavaScript to view the comments powered by <a href=https://giscus.app/>giscus</a>.</noscript></div></article></div></main><footer class=footer><hr style=opacity:.2><div class=footer-container><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2020 - 2024</span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span><span class=icp-splitter>&nbsp;|&nbsp;</span><br class=icp-br><span class=icp><a href="https://icp.gov.moe/?keyword=20222231" target=_blank>萌ICP备20222231号</a></span></div><div class=footer-line><a href=https://wiki.imcbc.cn target=_blank rel=noopener title="Bing's Wiki">Wiki</a>
&nbsp;|&nbsp;
<a href=https://rssblog.cn target=_blank rel=noopener title=RSSBlog>RSSBlog</a>
&nbsp;|&nbsp;
<a href=https://travellings.link target=_blank rel=noopener title=开往-友链接力>开往-友链接力</a>
&nbsp;|&nbsp;
<a href=https://www.foreverblog.cn/go.html target=_blank>穿梭虫洞</a></div><div class=footer-line><script>var build_date="2024-03-05T21:35:50+08:00"</script>已运行
<span id=run-time></span>
&nbsp;|&nbsp;
构建于
<span id=build-time></span>&nbsp;前</div><div class=footer-line><script async src=https://npm.elemecdn.com/penndu@1.0.0/bsz.js></script>
共计
<span id=busuanzi_value_site_uv></span>&nbsp;访客
&nbsp;|&nbsp;
<span id=busuanzi_value_site_pv></span>&nbsp;访问
&nbsp;|&nbsp;
256K&nbsp;字</div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw"></i>
</a><a id=reader-button class=fixed-button title=阅读模式><i class="fa fa-book fa-fw"></i></a></div><link rel=stylesheet href=https://fastly.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/css/lightgallery.min.css><link rel=stylesheet href=https://fastly.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css><link rel=stylesheet href=https://fastly.jsdelivr.net/npm/katex@0.11.1/dist/contrib/copy-tex.min.css><script type=text/javascript src=https://cdn.staticfile.org/jquery/3.6.0/jquery.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/npm/autocomplete.js@0.37.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/npm/algoliasearch@4.2.0/dist/algoliasearch-lite.umd.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/js/lightgallery.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/npm/lg-thumbnail.js@1.2.0/dist/lg-thumbnail.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/npm/lg-zoom.js@1.2.0/dist/lg-zoom.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/npm/katex@0.11.1/dist/contrib/copy-tex.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/npm/katex@0.11.1/dist/contrib/mhchem.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/gh/Albejr/jquery-albe-timeline/jquery-albe-timeline.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/gh/caibingcheng/orlike@client/orlike.min.js></script><script type=text/javascript src=/js/custom.js></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:50},comment:{},lightGallery:{actualSize:!1,exThumbImage:"data-thumbnail",hideBarsDelay:2e3,selector:".lightgallery",speed:400,thumbContHeight:80,thumbWidth:80,thumbnail:!0},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{algoliaAppID:"JMTHQS1VUU",algoliaIndex:"blog-bbing",algoliaSearchKey:"0dd43732743475449c844c0d0f21366a",highlightTag:"em",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:50,type:"algolia"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>