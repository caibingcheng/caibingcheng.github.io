<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>glibc-fopen源码阅读-补充篇-open系统调用 - Bing's Blog</title><meta name=keywords content="[Life bbing bing hugo Blog C++ LoveIt]"><meta name=Description content="个人技术博客"><meta property="og:title" content="glibc-fopen源码阅读-补充篇-open系统调用"><meta property="og:description" content="上一篇《glibc-fopen源码阅读》讲到了fopen是怎么工作的，以及FILE是怎么和文件关联起来的。但是再次阅读之后，发现还是有些细节存在疑问："><meta property="og:type" content="article"><meta property="og:url" content="https://imcbc.cn/202202/fopen-sys-open/"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/caibingcheng/resources@main/images/13bOkrO.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-02-22T16:50:08+08:00"><meta property="article:modified_time" content="2022-02-22T16:50:08+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://cdn.jsdelivr.net/gh/caibingcheng/resources@main/images/13bOkrO.png"><meta name=twitter:title content="glibc-fopen源码阅读-补充篇-open系统调用"><meta name=twitter:description content="上一篇《glibc-fopen源码阅读》讲到了fopen是怎么工作的，以及FILE是怎么和文件关联起来的。但是再次阅读之后，发现还是有些细节存在疑问："><meta name=application-name content="Bing's Blog"><meta name=apple-mobile-web-app-title content="Bing's Blog"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://imcbc.cn/202202/fopen-sys-open/><link rel=prev href=https://imcbc.cn/202201/framestack/><link rel=next href=https://imcbc.cn/202202/glibc-mmap/><link rel=stylesheet href=https://fastly.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=https://fastly.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.0/css/all.min.css><link rel=stylesheet href=https://fastly.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css><link rel=stylesheet href=https://fastly.jsdelivr.net/gh/Albejr/jquery-albe-timeline/templates/simple/style-albe-timeline.css><link rel=stylesheet href=https://fastly.jsdelivr.net/gh/caibingcheng/orlike@client/orlike.min.css><link rel=stylesheet href=/css/custom.css><meta name=google-site-verification content="xy1bCgQPV_H3_o2XD34o2mIByQxmzkV3GPOfhXg_mTM"><meta name=msvalidate.01 content="c81a65b6344571786df543a56c7bbe18"><meta name=baidu-site-verification content="code-WcyzWjgFYo"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"glibc-fopen源码阅读-补充篇-open系统调用","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/imcbc.cn\/202202\/fopen-sys-open\/"},"image":["https:\/\/imcbc.cn\/android-chrome-192x192.png"],"genre":"posts","keywords":"Linux, 文件系统, glibc","wordcount":3437,"url":"https:\/\/imcbc.cn\/202202\/fopen-sys-open\/","datePublished":"2022-02-22T16:50:08+08:00","dateModified":"2022-02-22T16:50:08+08:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"Bing","logo":"https:\/\/imcbc.cn\/android-chrome-192x192.png"},"author":{"@type":"Person","name":"bbing"},"description":""}</script></head><body header-desktop=normal header-mobile=normal><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><a href=https://github.com/caibingcheng/ class=github-corner aria-label="View source on GitHub"><svg width="3.5rem" height="3.5rem" viewBox="0 0 250 250" style="fill:#151513;color:#fff;position:absolute;top:0;border:0;left:0;transform:scale(-1,1)" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><div class=header-title><a href=/ title="Bing's Blog">Bing's Blog</a></div><div class=menu><div class=menu-inner><div class=dropdown><a href=/posts/ class="menu-item menu-more dropbtn" title><i class='fas fa fa-archive'></i> 归档</a><div class="menu-more-content dropdown-content"><a href=/tags/ title><i class='fas fa fa-tag'></i> 标签 </a><a href=/categories/ title><i class='fas fa fa-th'></i> 分类</a></div></div><a class=menu-item href=/friends/><i class='fas fa fa-users'></i> 友链</a><div class=dropdown><a href=javascript:void(0); class="menu-item menu-more dropbtn" title><i class='fas fa fa-angle-double-down'></i> 更多</a><div class="menu-more-content dropdown-content"><a href=/tools/ title><i class='fas fa fa-cubes'></i> 工具 </a><a href=/about/ title><i class='fas fa fa-address-card'></i> 关于 </a><a href=/timeline/ title><i class='fas fa fa-building'></i> 建站 </a><a href=/index.xml/ title><i class='fas fa fa-rss'></i> RSS</a></div></div><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=搜索文章内容 id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin"></i></span>
</span><a href=https://travellings.link target=_blank class=menu-item rel=noopener title=开往-友链接力><i class='fas fa-fw fa-subway'></i></a>
<a href=https://rssblog.cn/bbing class=menu-item target=_blank rel=noopener title=RSSBlog><i class='fas fa-fw fa-inbox'></i></a>
<a href=https://www.foreverblog.cn/go.html class=menu-item target=_blank rel=noopener title=穿梭虫洞><i class="fas fa-fw fa-life-ring" title=穿梭虫洞-随机访问十年之约友链博客></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Bing's Blog">Bing's Blog</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章内容 id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></div><a href=/posts/ class=menu-item title><i class='fas fa fa-archive'></i> 归档</a>
<a href=/tags/ class=menu-item title><i class='fas fa fa-tag'></i> 标签</a>
<a href=/categories/ class=menu-item title><i class='fas fa fa-th'></i> 分类</a>
<a class=menu-item href=/friends/><i class='fas fa fa-users'></i> 友链</a>
<a href=/tools/ class=menu-item title><i class='fas fa fa-cubes'></i> 工具</a>
<a href=/about/ class=menu-item title><i class='fas fa fa-address-card'></i> 关于</a>
<a href=/timeline/ class=menu-item title><i class='fas fa fa-building'></i> 建站</a>
<a href=/index.xml/ class=menu-item title><i class='fas fa fa-rss'></i> RSS</a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class=single-title>glibc-fopen源码阅读-补充篇-open系统调用<sup>
<a id=reader-button-title title=阅读模式><i class="fa fa-book fa-fw"></i></a></sup></h1><div class=post-meta><div class=post-meta-line></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2022-02-22>2022-02-22</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 3437 字&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 7 分钟&nbsp;</div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#系统调用open>系统调用open</a><ul><li><a href=#openat>openat</a></li><li><a href=#build_open_flags>build_open_flags</a></li><li><a href=#getname>getname</a></li><li><a href=#get_unused_fd_flags>get_unused_fd_flags</a></li><li><a href=#do_filp_open>do_filp_open</a></li><li><a href=#fsnotify_open>fsnotify_open</a></li><li><a href=#fd_install>fd_install</a></li></ul></li></ul></nav></div></div><div class=content id=content><p>上一篇<a href=/202106/fopen-deep rel>《glibc-fopen源码阅读》</a>讲到了<code>fopen</code>是怎么工作的，以及<code>FILE</code>是怎么和文件关联起来的。但是再次阅读之后，发现还是有些细节存在疑问：</p><ol><li>系统调用<code>openat</code>怎么就拿到了<code>fd</code>？</li><li><code>struct file</code>怎么和文件内容关联起来的，什么时候关联起来的？</li></ol><p>带着以上疑问，继续阅读系统的<code>open</code>类函数。不过仅了解<code>fopen</code>也是可以的，并不影响对glibc的文件打开过程的理解。</p><h2 id=系统调用open>系统调用open</h2><p>上篇已经说到，<code>fopen</code>最终通过系统调用<code>openat</code>拿到了文件的<code>fd</code>，并且将<code>fd</code>放到了<code>FILE</code>的<code>_fileno</code>成员中：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=kt>int</span>
</span></span><span class=line><span class=cl><span class=nf>__libc_open64</span> <span class=p>(</span><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>file</span><span class=p>,</span> <span class=kt>int</span> <span class=n>oflag</span><span class=p>,</span> <span class=p>...)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>mode</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>__OPEN_NEEDS_MODE</span> <span class=p>(</span><span class=n>oflag</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>va_list</span> <span class=n>arg</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>va_start</span> <span class=p>(</span><span class=n>arg</span><span class=p>,</span> <span class=n>oflag</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>mode</span> <span class=o>=</span> <span class=n>va_arg</span> <span class=p>(</span><span class=n>arg</span><span class=p>,</span> <span class=kt>int</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>va_end</span> <span class=p>(</span><span class=n>arg</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>SYSCALL_CANCEL</span> <span class=p>(</span><span class=n>openat</span><span class=p>,</span> <span class=n>AT_FDCWD</span><span class=p>,</span> <span class=n>file</span><span class=p>,</span> <span class=n>oflag</span> <span class=o>|</span> <span class=n>EXTRA_OPEN_FLAGS</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                         <span class=n>mode</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=openat>openat</h3><p><code>fopen</code>最终走到的系统调用是<code>openat</code>，<code>openat</code>调用的是<code>do_sys_open</code>，对<code>fopen</code>来说，调用<code>openat</code>和<code>open</code>是一样的：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=n>SYSCALL_DEFINE3</span><span class=p>(</span><span class=n>open</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span> <span class=n>__user</span> <span class=o>*</span><span class=p>,</span> <span class=n>filename</span><span class=p>,</span> <span class=kt>int</span><span class=p>,</span> <span class=n>flags</span><span class=p>,</span> <span class=n>umode_t</span><span class=p>,</span> <span class=n>mode</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>force_o_largefile</span><span class=p>())</span>
</span></span><span class=line><span class=cl>		<span class=n>flags</span> <span class=o>|=</span> <span class=n>O_LARGEFILE</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nf>do_sys_open</span><span class=p>(</span><span class=n>AT_FDCWD</span><span class=p>,</span> <span class=n>filename</span><span class=p>,</span> <span class=n>flags</span><span class=p>,</span> <span class=n>mode</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=n>SYSCALL_DEFINE4</span><span class=p>(</span><span class=n>openat</span><span class=p>,</span> <span class=kt>int</span><span class=p>,</span> <span class=n>dfd</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span> <span class=n>__user</span> <span class=o>*</span><span class=p>,</span> <span class=n>filename</span><span class=p>,</span> <span class=kt>int</span><span class=p>,</span> <span class=n>flags</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=n>umode_t</span><span class=p>,</span> <span class=n>mode</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>force_o_largefile</span><span class=p>())</span>
</span></span><span class=line><span class=cl>		<span class=n>flags</span> <span class=o>|=</span> <span class=n>O_LARGEFILE</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nf>do_sys_open</span><span class=p>(</span><span class=n>dfd</span><span class=p>,</span> <span class=n>filename</span><span class=p>,</span> <span class=n>flags</span><span class=p>,</span> <span class=n>mode</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>open</code>和<code>openat</code>指向的都是<code>do_sys_open</code>这个函数，下面来看<code>do_sys_open</code>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=kt>long</span> <span class=nf>do_sys_open</span><span class=p>(</span><span class=kt>int</span> <span class=n>dfd</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span> <span class=n>__user</span> <span class=o>*</span><span class=n>filename</span><span class=p>,</span> <span class=kt>int</span> <span class=n>flags</span><span class=p>,</span> <span class=n>umode_t</span> <span class=n>mode</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>open_flags</span> <span class=n>op</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>fd</span> <span class=o>=</span> <span class=n>build_open_flags</span><span class=p>(</span><span class=n>flags</span><span class=p>,</span> <span class=n>mode</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>op</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>filename</span> <span class=o>*</span><span class=n>tmp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>fd</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=n>fd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>tmp</span> <span class=o>=</span> <span class=n>getname</span><span class=p>(</span><span class=n>filename</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>IS_ERR</span><span class=p>(</span><span class=n>tmp</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=n>PTR_ERR</span><span class=p>(</span><span class=n>tmp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>fd</span> <span class=o>=</span> <span class=n>get_unused_fd_flags</span><span class=p>(</span><span class=n>flags</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>fd</span> <span class=o>&gt;=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>struct</span> <span class=n>file</span> <span class=o>*</span><span class=n>f</span> <span class=o>=</span> <span class=n>do_filp_open</span><span class=p>(</span><span class=n>dfd</span><span class=p>,</span> <span class=n>tmp</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>op</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=n>IS_ERR</span><span class=p>(</span><span class=n>f</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=n>put_unused_fd</span><span class=p>(</span><span class=n>fd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=n>fd</span> <span class=o>=</span> <span class=n>PTR_ERR</span><span class=p>(</span><span class=n>f</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=n>fsnotify_open</span><span class=p>(</span><span class=n>f</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=n>fd_install</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=n>f</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=n>putname</span><span class=p>(</span><span class=n>tmp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>fd</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>初看可以分为几个部分：</p><ol><li>建立<code>open flag</code></li><li>获取<code>name</code>（什么<code>name</code>？）</li><li>获取<code>fd</code></li><li>打开文件</li><li>通知<code>file system</code></li><li>将文件注册到进程</li></ol><p>下面逐个分析。</p><h3 id=build_open_flags>build_open_flags</h3><p>先是根据不同情况设置不同的<code>open flag</code>，我认为这里不是重点，稍微看看就好了，不过注意一下<code>O_TMPFILE_MASK</code>（因为最近用到了<code>tmpfile</code>这个函数&mldr;），有些情况是会直接返回一个错误码的。所以，<code>fd</code>相关的返回值，如果是负数则表示发生错误，可以从其返回值大致判断错误类型。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=k>static</span> <span class=kr>inline</span> <span class=kt>int</span> <span class=nf>build_open_flags</span><span class=p>(</span><span class=kt>int</span> <span class=n>flags</span><span class=p>,</span> <span class=n>umode_t</span> <span class=n>mode</span><span class=p>,</span> <span class=k>struct</span> <span class=n>open_flags</span> <span class=o>*</span><span class=n>op</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ......
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=p>(</span><span class=n>flags</span> <span class=o>&amp;</span> <span class=n>__O_TMPFILE</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>((</span><span class=n>flags</span> <span class=o>&amp;</span> <span class=n>O_TMPFILE_MASK</span><span class=p>)</span> <span class=o>!=</span> <span class=n>O_TMPFILE</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=o>-</span><span class=n>EINVAL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=p>(</span><span class=n>acc_mode</span> <span class=o>&amp;</span> <span class=n>MAY_WRITE</span><span class=p>))</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=o>-</span><span class=n>EINVAL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>flags</span> <span class=o>&amp;</span> <span class=n>O_PATH</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>		 * If we have O_PATH in the open flag. Then we
</span></span></span><span class=line><span class=cl><span class=cm>		 * cannot have anything other than the below set of flags
</span></span></span><span class=line><span class=cl><span class=cm>		 */</span>
</span></span><span class=line><span class=cl>		<span class=n>flags</span> <span class=o>&amp;=</span> <span class=n>O_DIRECTORY</span> <span class=o>|</span> <span class=n>O_NOFOLLOW</span> <span class=o>|</span> <span class=n>O_PATH</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=n>acc_mode</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ......
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=getname>getname</h3><p><code>getname</code>会返回一个<code>filename</code>的结构体，所以先来看看<code>filename</code>结构体：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=k>struct</span> <span class=n>filename</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>const</span> <span class=kt>char</span>		<span class=o>*</span><span class=n>name</span><span class=p>;</span>	<span class=cm>/* pointer to actual string */</span>
</span></span><span class=line><span class=cl>	<span class=k>const</span> <span class=n>__user</span> <span class=kt>char</span>	<span class=o>*</span><span class=n>uptr</span><span class=p>;</span>	<span class=cm>/* original userland pointer */</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span>			<span class=n>refcnt</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>audit_names</span>	<span class=o>*</span><span class=n>aname</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>const</span> <span class=kt>char</span>		<span class=n>iname</span><span class=p>[];</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><p><code>audit</code>对应的是linux审计系统相关，就先不理它了。其余注意到<code>filename</code>结构体主要是存储了一些字符串，大概可以猜想到是存储的文件路径相关的字符串。但是为什么需要这么多成员来存储呢？</p><p>再看<code>getname</code>函数指向的<code>getname_flags</code>，这里或许可以找到<code>filename</code>的一些原理：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=k>struct</span> <span class=n>filename</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=nf>getname_flags</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span> <span class=n>__user</span> <span class=o>*</span><span class=n>filename</span><span class=p>,</span> <span class=kt>int</span> <span class=n>flags</span><span class=p>,</span> <span class=kt>int</span> <span class=o>*</span><span class=n>empty</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>//......
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>const</span> <span class=n>size_t</span> <span class=n>size</span> <span class=o>=</span> <span class=n>offsetof</span><span class=p>(</span><span class=k>struct</span> <span class=n>filename</span><span class=p>,</span> <span class=n>iname</span><span class=p>[</span><span class=mi>1</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>  <span class=n>kname</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=n>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>    * size is chosen that way we to guarantee that
</span></span></span><span class=line><span class=cl><span class=cm>    * result-&gt;iname[0] is within the same object and that
</span></span></span><span class=line><span class=cl><span class=cm>    * kname can&#39;t be equal to result-&gt;iname, no matter what.
</span></span></span><span class=line><span class=cl><span class=cm>    */</span>
</span></span><span class=line><span class=cl>  <span class=n>result</span> <span class=o>=</span> <span class=n>kzalloc</span><span class=p>(</span><span class=n>size</span><span class=p>,</span> <span class=n>GFP_KERNEL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>unlikely</span><span class=p>(</span><span class=o>!</span><span class=n>result</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>__putname</span><span class=p>(</span><span class=n>kname</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>ERR_PTR</span><span class=p>(</span><span class=o>-</span><span class=n>ENOMEM</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=n>result</span><span class=o>-&gt;</span><span class=n>name</span> <span class=o>=</span> <span class=n>kname</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>len</span> <span class=o>=</span> <span class=n>strncpy_from_user</span><span class=p>(</span><span class=n>kname</span><span class=p>,</span> <span class=n>filename</span><span class=p>,</span> <span class=n>PATH_MAX</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>//.......
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=n>result</span><span class=o>-&gt;</span><span class=n>refcnt</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>//......
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=n>result</span><span class=o>-&gt;</span><span class=n>uptr</span> <span class=o>=</span> <span class=n>filename</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>result</span><span class=o>-&gt;</span><span class=n>aname</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>audit_getname</span><span class=p>(</span><span class=n>result</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>kname</code>指向的是<code>filename</code>结构体的第一个成员，它会<code>alloc</code>一段空间，下面是关于<code>kzalloc</code>函数的描述：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * kmalloc is the normal method of allocating memory
</span></span></span><span class=line><span class=cl><span class=cm> * for objects smaller than page size in the kernel.
</span></span></span><span class=line><span class=cl><span class=cm>*/</span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=n>__always_inline</span> <span class=kt>void</span> <span class=o>*</span><span class=nf>kmalloc</span><span class=p>(</span><span class=n>size_t</span> <span class=n>size</span><span class=p>,</span> <span class=n>gfp_t</span> <span class=n>flags</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kr>inline</span> <span class=kt>void</span> <span class=o>*</span><span class=nf>kzalloc</span><span class=p>(</span><span class=n>size_t</span> <span class=n>size</span><span class=p>,</span> <span class=n>gfp_t</span> <span class=n>flags</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>kmalloc</span><span class=p>(</span><span class=n>size</span><span class=p>,</span> <span class=n>flags</span> <span class=o>|</span> <span class=n>__GFP_ZERO</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>现在可以知道，<code>filename</code>结构体的<code>name</code>成员指向了<code>kmalloc</code>申请的一块内存，这块内存的最大空间是<code>1Page</code>，这也就是为什么会有<code>PATH_MAX</code>这个系统宏了，其对应大小是<code>4096</code>，在我的系统上就是一个<code>Page</code>的大小。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=n>len</span> <span class=o>=</span> <span class=n>strncpy_from_user</span><span class=p>(</span><span class=n>kname</span><span class=p>,</span> <span class=n>filename</span><span class=p>,</span> <span class=n>PATH_MAX</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>result</span><span class=o>-&gt;</span><span class=n>refcnt</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>result</span><span class=o>-&gt;</span><span class=n>uptr</span> <span class=o>=</span> <span class=n>filename</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>以上，<code>filename</code>结构体的<code>name</code>成员指向了自己分配的一块内存，其内容是<code>filename</code>这个字符串的拷贝，<code>uptr</code>成员则指向了<code>filename</code>这个字符串，<code>refcnt</code>成员被置为1。但是，现在还没回答上面的问题，为什么<code>filename</code>结构体会有两个成员来存储同一个字符串？</p><p>可以大概猜想一下，调用完<code>open</code>之后，<code>filename</code>字符串因为是用户申请的，所以可能被回收，如果后续还在使用的话就存在越界的可能，所以需要一块额外的空间存储<code>filename</code>字符串，所以就自己申请一块了。后续还会用到<code>filename</code>结构体的<code>name</code>成员。</p><h3 id=get_unused_fd_flags>get_unused_fd_flags</h3><p><code>get_unused_fd_flags</code>调用的是<code>__alloc_fd</code>函数，这里注意到<code>current</code>，先前已经介绍过，代表当前的<code>task_struct</code>，所以这里拿到了当前进程的<code>files</code>，在<a href=/202105/process-ctracon4/ rel>《进程控制和通信(四) · PCB介绍 》</a>中已经讲过<code>task_struct</code>和<code>files</code>的关系了。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=kt>int</span> <span class=nf>get_unused_fd_flags</span><span class=p>(</span><span class=kt>unsigned</span> <span class=n>flags</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>__alloc_fd</span><span class=p>(</span><span class=n>current</span><span class=o>-&gt;</span><span class=n>files</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>rlimit</span><span class=p>(</span><span class=n>RLIMIT_NOFILE</span><span class=p>),</span> <span class=n>flags</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>下面是摘取自<code>__alloc_fd</code>的一些语句：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=n>fdt</span> <span class=o>=</span> <span class=n>files_fdtable</span><span class=p>(</span><span class=n>files</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>fd</span> <span class=o>=</span> <span class=n>start</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=n>fd</span> <span class=o>&lt;</span> <span class=n>files</span><span class=o>-&gt;</span><span class=n>next_fd</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=n>fd</span> <span class=o>=</span> <span class=n>files</span><span class=o>-&gt;</span><span class=n>next_fd</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=n>fd</span> <span class=o>&lt;</span> <span class=n>fdt</span><span class=o>-&gt;</span><span class=n>max_fds</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=n>fd</span> <span class=o>=</span> <span class=n>find_next_fd</span><span class=p>(</span><span class=n>fdt</span><span class=p>,</span> <span class=n>fd</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>//......
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=n>error</span> <span class=o>=</span> <span class=n>expand_files</span><span class=p>(</span><span class=n>files</span><span class=p>,</span> <span class=n>fd</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>  * If we needed to expand the fs array we
</span></span></span><span class=line><span class=cl><span class=cm>  * might have blocked - try again.
</span></span></span><span class=line><span class=cl><span class=cm>  */</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=n>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>goto</span> <span class=n>repeat</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=n>start</span> <span class=o>&lt;=</span> <span class=n>files</span><span class=o>-&gt;</span><span class=n>next_fd</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=n>files</span><span class=o>-&gt;</span><span class=n>next_fd</span> <span class=o>=</span> <span class=n>fd</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>__set_open_fd</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=n>fdt</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>// ......
</span></span></span></code></pre></td></tr></table></div></div><p>可以知道，<code>__alloc_fd</code>的大致过程：</p><ol><li>获取<code>fdtable</code></li><li>找到一个可用的<code>fd</code></li><li>如果没有可用的<code>fd</code>，则尝试扩展<code>fdtable</code>（参考<a href=/202105/process-ctracon4/ rel>《进程控制和通信(四) · PCB介绍 》</a>）</li><li>扩展后在尝试找一个可用的<code>fd</code></li><li>找<code>fd</code>成功，设置<code>fdtable</code>对应<code>bit</code>位</li></ol><p>目前为止，文件还是没有被打开，也没有对<code>filename</code>指向的文件做任何操作。不过，<code>fd</code>和<code>filename</code>结构体准备好后，就可以打开文件了。</p><h3 id=do_filp_open>do_filp_open</h3><p>以下是<code>do_filp_open</code>函数：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=k>struct</span> <span class=n>file</span> <span class=o>*</span><span class=nf>do_filp_open</span><span class=p>(</span><span class=kt>int</span> <span class=n>dfd</span><span class=p>,</span> <span class=k>struct</span> <span class=n>filename</span> <span class=o>*</span><span class=n>pathname</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=k>const</span> <span class=k>struct</span> <span class=n>open_flags</span> <span class=o>*</span><span class=n>op</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>nameidata</span> <span class=n>nd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>flags</span> <span class=o>=</span> <span class=n>op</span><span class=o>-&gt;</span><span class=n>lookup_flags</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>file</span> <span class=o>*</span><span class=n>filp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>set_nameidata</span><span class=p>(</span><span class=o>&amp;</span><span class=n>nd</span><span class=p>,</span> <span class=n>dfd</span><span class=p>,</span> <span class=n>pathname</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>filp</span> <span class=o>=</span> <span class=n>path_openat</span><span class=p>(</span><span class=o>&amp;</span><span class=n>nd</span><span class=p>,</span> <span class=n>op</span><span class=p>,</span> <span class=n>flags</span> <span class=o>|</span> <span class=n>LOOKUP_RCU</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>unlikely</span><span class=p>(</span><span class=n>filp</span> <span class=o>==</span> <span class=n>ERR_PTR</span><span class=p>(</span><span class=o>-</span><span class=n>ECHILD</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>		<span class=n>filp</span> <span class=o>=</span> <span class=n>path_openat</span><span class=p>(</span><span class=o>&amp;</span><span class=n>nd</span><span class=p>,</span> <span class=n>op</span><span class=p>,</span> <span class=n>flags</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>unlikely</span><span class=p>(</span><span class=n>filp</span> <span class=o>==</span> <span class=n>ERR_PTR</span><span class=p>(</span><span class=o>-</span><span class=n>ESTALE</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>		<span class=n>filp</span> <span class=o>=</span> <span class=n>path_openat</span><span class=p>(</span><span class=o>&amp;</span><span class=n>nd</span><span class=p>,</span> <span class=n>op</span><span class=p>,</span> <span class=n>flags</span> <span class=o>|</span> <span class=n>LOOKUP_REVAL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>restore_nameidata</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>filp</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这个函数看着比较简单，大概是先通过<code>filename</code>得到一个<code>nameidata</code>的结构体，然后就用这个<code>nameidata</code>生成了一个<code>struct file</code>。</p><p><code>nameidata</code>是什么？还是先来看看这个结构体的成员：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=k>struct</span> <span class=n>nameidata</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>path</span>	<span class=n>path</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>qstr</span>	<span class=n>last</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>path</span>	<span class=n>root</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>inode</span>	<span class=o>*</span><span class=n>inode</span><span class=p>;</span> <span class=cm>/* path.dentry.d_inode */</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>int</span>	<span class=n>flags</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span>	<span class=n>seq</span><span class=p>,</span> <span class=n>m_seq</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span>		<span class=n>last_type</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span>	<span class=n>depth</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span>		<span class=n>total_link_count</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>saved</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>struct</span> <span class=n>path</span> <span class=n>link</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=k>struct</span> <span class=n>delayed_call</span> <span class=n>done</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=kt>unsigned</span> <span class=n>seq</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=o>*</span><span class=n>stack</span><span class=p>,</span> <span class=n>internal</span><span class=p>[</span><span class=n>EMBEDDED_LEVELS</span><span class=p>];</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>filename</span>	<span class=o>*</span><span class=n>name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>nameidata</span> <span class=o>*</span><span class=n>saved</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>inode</span>	<span class=o>*</span><span class=n>link_inode</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span>	<span class=n>root_seq</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span>		<span class=n>dfd</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=n>__randomize_layout</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>我认为重要的就是两个<code>inode</code>，一个是<code>dentry</code>的<code>inode</code>，一个是<code>link_inode</code>。</p><p><code>set_nameidata</code>只是大概填写<code>nameidata</code>的一些基础信息，关于<code>inode</code>的部分这里并没有填写。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=nf>set_nameidata</span><span class=p>(</span><span class=k>struct</span> <span class=n>nameidata</span> <span class=o>*</span><span class=n>p</span><span class=p>,</span> <span class=kt>int</span> <span class=n>dfd</span><span class=p>,</span> <span class=k>struct</span> <span class=n>filename</span> <span class=o>*</span><span class=n>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>nameidata</span> <span class=o>*</span><span class=n>old</span> <span class=o>=</span> <span class=n>current</span><span class=o>-&gt;</span><span class=n>nameidata</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>p</span><span class=o>-&gt;</span><span class=n>stack</span> <span class=o>=</span> <span class=n>p</span><span class=o>-&gt;</span><span class=n>internal</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>p</span><span class=o>-&gt;</span><span class=n>dfd</span> <span class=o>=</span> <span class=n>dfd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>p</span><span class=o>-&gt;</span><span class=n>name</span> <span class=o>=</span> <span class=n>name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>p</span><span class=o>-&gt;</span><span class=n>total_link_count</span> <span class=o>=</span> <span class=n>old</span> <span class=o>?</span> <span class=n>old</span><span class=o>-&gt;</span><span class=nl>total_link_count</span> <span class=p>:</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>p</span><span class=o>-&gt;</span><span class=n>saved</span> <span class=o>=</span> <span class=n>old</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>current</span><span class=o>-&gt;</span><span class=n>nameidata</span> <span class=o>=</span> <span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>所以，接下来需要关注<code>path_openat</code>函数是怎么填写<code>nameidata</code>的：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=n>file</span> <span class=o>=</span> <span class=n>alloc_empty_file</span><span class=p>(</span><span class=n>op</span><span class=o>-&gt;</span><span class=n>open_flag</span><span class=p>,</span> <span class=n>current_cred</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=n>error</span> <span class=o>=</span> <span class=n>do_o_path</span><span class=p>(</span><span class=n>nd</span><span class=p>,</span> <span class=n>flags</span><span class=p>,</span> <span class=n>file</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>摘取了一些语句，大致过程如上，先是申请了一个空的<code>struct file</code>，根据<code>alloc_empty_file</code>的输入参数，也大概可以看出，<code>alloc_empty_file</code>只是申请了一个结构体之类的内存，不会真正打开文件（因为没有路径等信息输入）。然后是<code>do_o_path</code>（这里有多个类似的函数入口，仅挑选<code>do_o_path</code>追踪）：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=k>static</span> <span class=kt>int</span> <span class=nf>do_o_path</span><span class=p>(</span><span class=k>struct</span> <span class=n>nameidata</span> <span class=o>*</span><span class=n>nd</span><span class=p>,</span> <span class=kt>unsigned</span> <span class=n>flags</span><span class=p>,</span> <span class=k>struct</span> <span class=n>file</span> <span class=o>*</span><span class=n>file</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>path</span> <span class=n>path</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>error</span> <span class=o>=</span> <span class=n>path_lookupat</span><span class=p>(</span><span class=n>nd</span><span class=p>,</span> <span class=n>flags</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>path</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>audit_inode</span><span class=p>(</span><span class=n>nd</span><span class=o>-&gt;</span><span class=n>name</span><span class=p>,</span> <span class=n>path</span><span class=p>.</span><span class=n>dentry</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=n>error</span> <span class=o>=</span> <span class=n>vfs_open</span><span class=p>(</span><span class=o>&amp;</span><span class=n>path</span><span class=p>,</span> <span class=n>file</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=n>path_put</span><span class=p>(</span><span class=o>&amp;</span><span class=n>path</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>error</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>大概是两步：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=kt>int</span> <span class=n>error</span> <span class=o>=</span> <span class=n>path_lookupat</span><span class=p>(</span><span class=n>nd</span><span class=p>,</span> <span class=n>flags</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>path</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>error</span> <span class=o>=</span> <span class=n>vfs_open</span><span class=p>(</span><span class=o>&amp;</span><span class=n>path</span><span class=p>,</span> <span class=n>file</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>在<code>path_lookupat</code>的时候会填写<code>nameidata</code>的<code>inode</code>等成员，因此，<code>path_lookupat</code>之后可以通过<code>nameidata</code>拿到文件的<code>dentry</code>信息了，在<code>dentry</code>的<code>inode</code>表里就可以找到文件对应的<code>inode</code>。</p><p>然后通过<code>vfs_open</code>打开文件，拿到文件的<code>inode</code>等信息填写到<code>struct file</code>结构体中。不同的<code>vfs</code>会有对应的<code>open</code>方法，<code>vfs_open</code>指向的<code>do_dentry_open</code>方法中，就会使用文件所在<code>vfs</code>的<code>open</code>方法来打开文件。</p><p>到目前为止，已经打开文件，拿到文件的<code>inode</code>等信息，并且写入<code>struct file</code>了。</p><p><figure><a class=lightgallery href=https://bu.dusays.com/2022/06/26/62b87a7191bb8.png title=&amp;ldquo;do_filp_open过程&amp;rdquo; data-thumbnail=https://bu.dusays.com/2022/06/26/62b87a7191bb8.png data-sub-html="<h2>do_filp_open过程</h2><p>&amp;ldquo;do_filp_open过程&amp;rdquo;</p>"><img class=lazyload src=/svg/loading.min.svg data-src=https://bu.dusays.com/2022/06/26/62b87a7191bb8.png data-srcset="https://bu.dusays.com/2022/06/26/62b87a7191bb8.png, https://bu.dusays.com/2022/06/26/62b87a7191bb8.png 1.5x, https://bu.dusays.com/2022/06/26/62b87a7191bb8.png 2x" data-sizes=auto alt=https://bu.dusays.com/2022/06/26/62b87a7191bb8.png></a><figcaption class=image-caption>do_filp_open过程</figcaption></figure></p><h3 id=fsnotify_open>fsnotify_open</h3><p>略。（这部分有机会单独讲，关于Linux文件事件）</p><p><figure><a class=lightgallery href=https://bu.dusays.com/2022/06/26/62b87a757fa2b.png title=&amp;ldquo;fsnotify_open过程&amp;rdquo; data-thumbnail=https://bu.dusays.com/2022/06/26/62b87a757fa2b.png data-sub-html="<h2>fsnotify_open过程</h2><p>&amp;ldquo;fsnotify_open过程&amp;rdquo;</p>"><img class=lazyload src=/svg/loading.min.svg data-src=https://bu.dusays.com/2022/06/26/62b87a757fa2b.png data-srcset="https://bu.dusays.com/2022/06/26/62b87a757fa2b.png, https://bu.dusays.com/2022/06/26/62b87a757fa2b.png 1.5x, https://bu.dusays.com/2022/06/26/62b87a757fa2b.png 2x" data-sizes=auto alt=https://bu.dusays.com/2022/06/26/62b87a757fa2b.png></a><figcaption class=image-caption>fsnotify_open过程</figcaption></figure></p><h3 id=fd_install>fd_install</h3><p>文件已经打开了，怎么让进程拥有这个文件呢？并且我们已经知道，文件可以通过一个<code>fd</code>就能打开了。关键是<code>fd_install</code>函数：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=kt>void</span> <span class=nf>fd_install</span><span class=p>(</span><span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>fd</span><span class=p>,</span> <span class=k>struct</span> <span class=n>file</span> <span class=o>*</span><span class=n>file</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>__fd_install</span><span class=p>(</span><span class=n>current</span><span class=o>-&gt;</span><span class=n>files</span><span class=p>,</span> <span class=n>fd</span><span class=p>,</span> <span class=n>file</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>通过<code>current</code>可以获得当前<code>task_struct</code>的<code>files_struct</code>，进而可以获得<code>fdtable</code>。然后将<code>fdtable</code>的第<code>fd</code>个元素指向<code>file</code>这个<code>struct file</code>结构体。此时通过<code>task_struct</code>就可以找到对应的文件了，并且通过<code>fd</code>就能准确在<code>fdtable</code>中找到对应的<code>struct file</code>。</p></div><div class=post-footer id=post-footer><div class=orlike-box></div><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2022-02-22</span></div><div class=post-info-license><span><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></div><div class=post-info-more><section><i class="fas fa-fw fa-th"></i>&nbsp;<a href=/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/>操作系统</a>,&nbsp;<a href=/categories/glibc/>glibc</a></section><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/linux/>Linux</a>,&nbsp;<a href=/tags/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/>文件系统</a>,&nbsp;<a href=/tags/glibc/>glibc</a></section></div><div class=post-nav><a href=/202201/framestack/ class=prev rel=prev title=程序的栈帧><i class="fas fa-angle-left fa-fw"></i>程序的栈帧</a>
<a href=/202202/glibc-mmap/ class=next rel=next title=glibc-mmap源码阅读>glibc-mmap源码阅读<i class="fas fa-angle-right fa-fw"></i></a></div></div><div id=my-random-posts><div class=loadingThree><span></span>
<span></span>
<span></span>
<span></span>
<span></span></div></div><div id=comments><div id=giscus class=comment></div><script src=https://giscus.app/client.js data-repo=caibingcheng/comment data-repo-id=R_kgDOHgda4w data-category=Announcements data-category-id=DIC_kwDOHgda484CTfDe data-mapping=og:title data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=/css/giscus.css data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script><noscript>Please enable JavaScript to view the comments powered by <a href=https://giscus.app/>giscus</a>.</noscript></div></article></div></main><footer class=footer><hr style=opacity:.2><div class=footer-container><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2020 - 2024</span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span><span class=icp-splitter>&nbsp;|&nbsp;</span><br class=icp-br><span class=icp><a href="https://icp.gov.moe/?keyword=20222231" target=_blank>萌ICP备20222231号</a></span></div><div class=footer-line><a href=https://wiki.imcbc.cn target=_blank rel=noopener title="Bing's Wiki">Wiki</a>
&nbsp;|&nbsp;
<a href=https://rssblog.cn target=_blank rel=noopener title=RSSBlog>RSSBlog</a>
&nbsp;|&nbsp;
<a href=https://travellings.link target=_blank rel=noopener title=开往-友链接力>开往-友链接力</a>
&nbsp;|&nbsp;
<a href=https://www.foreverblog.cn/go.html target=_blank>穿梭虫洞</a></div><div class=footer-line><script>var build_date="2024-03-05T21:35:50+08:00"</script>已运行
<span id=run-time></span>
&nbsp;|&nbsp;
构建于
<span id=build-time></span>&nbsp;前</div><div class=footer-line><script async src=https://npm.elemecdn.com/penndu@1.0.0/bsz.js></script>
共计
<span id=busuanzi_value_site_uv></span>&nbsp;访客
&nbsp;|&nbsp;
<span id=busuanzi_value_site_pv></span>&nbsp;访问
&nbsp;|&nbsp;
256K&nbsp;字</div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw"></i>
</a><a id=reader-button class=fixed-button title=阅读模式><i class="fa fa-book fa-fw"></i></a></div><link rel=stylesheet href=https://fastly.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/css/lightgallery.min.css><link rel=stylesheet href=https://fastly.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css><link rel=stylesheet href=https://fastly.jsdelivr.net/npm/katex@0.11.1/dist/contrib/copy-tex.min.css><script type=text/javascript src=https://cdn.staticfile.org/jquery/3.6.0/jquery.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/npm/autocomplete.js@0.37.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/npm/algoliasearch@4.2.0/dist/algoliasearch-lite.umd.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/js/lightgallery.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/npm/lg-thumbnail.js@1.2.0/dist/lg-thumbnail.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/npm/lg-zoom.js@1.2.0/dist/lg-zoom.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/npm/katex@0.11.1/dist/contrib/copy-tex.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/npm/katex@0.11.1/dist/contrib/mhchem.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/gh/Albejr/jquery-albe-timeline/jquery-albe-timeline.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/gh/caibingcheng/orlike@client/orlike.min.js></script><script type=text/javascript src=/js/custom.js></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:50},comment:{},lightGallery:{actualSize:!1,exThumbImage:"data-thumbnail",hideBarsDelay:2e3,selector:".lightgallery",speed:400,thumbContHeight:80,thumbWidth:80,thumbnail:!0},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{algoliaAppID:"JMTHQS1VUU",algoliaIndex:"blog-bbing",algoliaSearchKey:"0dd43732743475449c844c0d0f21366a",highlightTag:"em",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:50,type:"algolia"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>