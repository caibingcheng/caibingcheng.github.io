<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>进程控制和通信(五) - Bing's Blog</title><meta name=keywords content="[Life bbing bing hugo Blog C++ LoveIt]"><meta name=Description content="个人技术博客"><meta property="og:title" content="进程控制和通信(五)"><meta property="og:description" content="socket通信应用
这是进程通信的最后一节. socket可以实现不同进程间的通信, 可以是相同机器的不同进程, 也可以是不同机器的不同进程.
本文的目的是简要学习socket通信的应用, 并且结合前几篇的内容, 学习socket通信的部分底层实现. 涉及到的一些api因为网上参考内容很多, 这里就不会介绍api的使用了."><meta property="og:type" content="article"><meta property="og:url" content="https://imcbc.cn/202106/process-ctracon5/"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/caibingcheng/resources@main/images/13bOkrO.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-06-03T17:34:50+08:00"><meta property="article:modified_time" content="2021-06-07T17:42:06+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://cdn.jsdelivr.net/gh/caibingcheng/resources@main/images/13bOkrO.png"><meta name=twitter:title content="进程控制和通信(五)"><meta name=twitter:description content="socket通信应用
这是进程通信的最后一节. socket可以实现不同进程间的通信, 可以是相同机器的不同进程, 也可以是不同机器的不同进程.
本文的目的是简要学习socket通信的应用, 并且结合前几篇的内容, 学习socket通信的部分底层实现. 涉及到的一些api因为网上参考内容很多, 这里就不会介绍api的使用了."><meta name=application-name content="Bing's Blog"><meta name=apple-mobile-web-app-title content="Bing's Blog"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://imcbc.cn/202106/process-ctracon5/><link rel=prev href=https://imcbc.cn/202106/fopen-deep/><link rel=next href=https://imcbc.cn/202106/algo-encrypter-rc4/><link rel=stylesheet href=https://fastly.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=https://fastly.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.0/css/all.min.css><link rel=stylesheet href=https://fastly.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css><link rel=stylesheet href=https://fastly.jsdelivr.net/gh/Albejr/jquery-albe-timeline/templates/simple/style-albe-timeline.css><link rel=stylesheet href=https://fastly.jsdelivr.net/gh/caibingcheng/orlike@client/orlike.min.css><link rel=stylesheet href=/css/custom.css><meta name=google-site-verification content="xy1bCgQPV_H3_o2XD34o2mIByQxmzkV3GPOfhXg_mTM"><meta name=msvalidate.01 content="c81a65b6344571786df543a56c7bbe18"><meta name=baidu-site-verification content="code-WcyzWjgFYo"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"进程控制和通信(五)","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/imcbc.cn\/202106\/process-ctracon5\/"},"image":["https:\/\/imcbc.cn\/android-chrome-192x192.png"],"genre":"posts","keywords":"进程, 进程通信, socket, Linux","wordcount":6128,"url":"https:\/\/imcbc.cn\/202106\/process-ctracon5\/","datePublished":"2021-06-03T17:34:50+08:00","dateModified":"2021-06-07T17:42:06+08:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"Bing","logo":"https:\/\/imcbc.cn\/android-chrome-192x192.png"},"author":{"@type":"Person","name":"bbing"},"description":""}</script></head><body header-desktop=normal header-mobile=normal><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><a href=https://github.com/caibingcheng/ class=github-corner aria-label="View source on GitHub"><svg width="3.5rem" height="3.5rem" viewBox="0 0 250 250" style="fill:#151513;color:#fff;position:absolute;top:0;border:0;left:0;transform:scale(-1,1)" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><div class=header-title><a href=/ title="Bing's Blog">Bing's Blog</a></div><div class=menu><div class=menu-inner><div class=dropdown><a href=/posts/ class="menu-item menu-more dropbtn" title><i class='fas fa fa-archive'></i> 归档</a><div class="menu-more-content dropdown-content"><a href=/tags/ title><i class='fas fa fa-tag'></i> 标签 </a><a href=/categories/ title><i class='fas fa fa-th'></i> 分类</a></div></div><a class=menu-item href=/friends/><i class='fas fa fa-users'></i> 友链</a><div class=dropdown><a href=javascript:void(0); class="menu-item menu-more dropbtn" title><i class='fas fa fa-angle-double-down'></i> 更多</a><div class="menu-more-content dropdown-content"><a href=/tools/ title><i class='fas fa fa-cubes'></i> 工具 </a><a href=/about/ title><i class='fas fa fa-address-card'></i> 关于 </a><a href=/timeline/ title><i class='fas fa fa-building'></i> 建站 </a><a href=/index.xml/ title><i class='fas fa fa-rss'></i> RSS</a></div></div><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=搜索文章内容 id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin"></i></span>
</span><a href=https://travellings.link target=_blank class=menu-item rel=noopener title=开往-友链接力><i class='fas fa-fw fa-subway'></i></a>
<a href=https://rssblog.cn/bbing class=menu-item target=_blank rel=noopener title=RSSBlog><i class='fas fa-fw fa-inbox'></i></a>
<a href=https://www.foreverblog.cn/go.html class=menu-item target=_blank rel=noopener title=穿梭虫洞><i class="fas fa-fw fa-life-ring" title=穿梭虫洞-随机访问十年之约友链博客></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Bing's Blog">Bing's Blog</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章内容 id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></div><a href=/posts/ class=menu-item title><i class='fas fa fa-archive'></i> 归档</a>
<a href=/tags/ class=menu-item title><i class='fas fa fa-tag'></i> 标签</a>
<a href=/categories/ class=menu-item title><i class='fas fa fa-th'></i> 分类</a>
<a class=menu-item href=/friends/><i class='fas fa fa-users'></i> 友链</a>
<a href=/tools/ class=menu-item title><i class='fas fa fa-cubes'></i> 工具</a>
<a href=/about/ class=menu-item title><i class='fas fa fa-address-card'></i> 关于</a>
<a href=/timeline/ class=menu-item title><i class='fas fa fa-building'></i> 建站</a>
<a href=/index.xml/ class=menu-item title><i class='fas fa fa-rss'></i> RSS</a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class=single-title>进程控制和通信(五)<span class=single-title> · socket通信</span><sup>
<a id=reader-button-title title=阅读模式><i class="fa fa-book fa-fw"></i></a></sup></h1><div class=post-meta><div class=post-meta-line></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2021-06-03>2021-06-03</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 6128 字&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 13 分钟&nbsp;</div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#socket通信应用>socket通信应用</a><ul><li><a href=#utils>utils</a></li><li><a href=#server>server</a></li><li><a href=#client>client</a></li><li><a href=#输出>输出</a></li></ul></li><li><a href=#socket>socket</a><ul><li><a href=#sock_create>sock_create</a><ul><li><a href=#__sock_create>__sock_create</a></li><li><a href=#sock_alloc>sock_alloc</a></li></ul></li><li><a href=#sock_map_fd>sock_map_fd</a><ul><li><a href=#sock_alloc_file>sock_alloc_file</a></li></ul></li><li><a href=#小结>小结</a></li></ul></li><li><a href=#bind>bind</a><ul><li><a href=#sockfd_lookup_light>sockfd_lookup_light</a></li><li><a href=#move_addr_to_kernel>move_addr_to_kernel</a></li><li><a href=#inet_bind>inet_bind</a><ul><li><a href=#__inet_bind>__inet_bind</a></li></ul></li><li><a href=#小结-1>小结</a></li></ul></li><li><a href=#listen>listen</a><ul><li><a href=#inet_listen>inet_listen</a><ul><li><a href=#inet_csk_listen_start>inet_csk_listen_start</a></li></ul></li><li><a href=#小结-2>小结</a></li></ul></li><li><a href=#accept>accept</a><ul><li><a href=#inet_accept>inet_accept</a></li><li><a href=#小结-3>小结</a></li></ul></li><li><a href=#connect>connect</a><ul><li><a href=#inet_stream_connect>inet_stream_connect</a></li><li><a href=#小结-4>小结</a></li></ul></li><li><a href=#总结>总结</a></li></ul></nav></div></div><div class=content id=content><h2 id=socket通信应用>socket通信应用</h2><p>这是进程通信的最后一节. socket可以实现不同进程间的通信, 可以是相同机器的不同进程, 也可以是不同机器的不同进程.</p><p>本文的目的是简要学习socket通信的应用, 并且结合前几篇的内容, 学习socket通信的部分底层实现. 涉及到的一些api因为网上参考内容很多, 这里就不会介绍api的使用了.</p><h3 id=utils>utils</h3><p>utils封装了<code>init</code>/<code>bind</code>和<code>connet</code>调用.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=c1>// utils.h
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;arpa/inet.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/socket.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;netinet/in.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>init_socket</span><span class=p>(</span><span class=kt>int</span> <span class=o>*</span><span class=n>sock</span><span class=p>,</span> <span class=k>struct</span> <span class=n>sockaddr_in</span> <span class=o>*</span><span class=n>serv_addr</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>ip</span><span class=p>,</span> <span class=k>const</span> <span class=kt>int</span> <span class=o>&amp;</span><span class=n>port</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>*</span><span class=n>sock</span> <span class=o>=</span> <span class=n>socket</span><span class=p>(</span><span class=n>AF_INET</span><span class=p>,</span> <span class=n>SOCK_STREAM</span><span class=p>,</span> <span class=n>IPPROTO_TCP</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>memset</span><span class=p>(</span><span class=n>serv_addr</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=k>struct</span> <span class=n>sockaddr_in</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=n>serv_addr</span><span class=o>-&gt;</span><span class=n>sin_family</span> <span class=o>=</span> <span class=n>AF_INET</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>serv_addr</span><span class=o>-&gt;</span><span class=n>sin_addr</span><span class=p>.</span><span class=n>s_addr</span> <span class=o>=</span> <span class=n>inet_addr</span><span class=p>(</span><span class=n>ip</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>serv_addr</span><span class=o>-&gt;</span><span class=n>sin_port</span> <span class=o>=</span> <span class=n>htons</span><span class=p>(</span><span class=n>port</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>bind_socket</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>ip</span><span class=p>,</span> <span class=k>const</span> <span class=kt>int</span> <span class=o>&amp;</span><span class=n>port</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>sock</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>sockaddr_in</span> <span class=n>serv_addr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>init_socket</span><span class=p>(</span><span class=o>&amp;</span><span class=n>sock</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>serv_addr</span><span class=p>,</span> <span class=n>ip</span><span class=p>,</span> <span class=n>port</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>bind</span><span class=p>(</span><span class=n>sock</span><span class=p>,</span> <span class=p>(</span><span class=k>struct</span> <span class=n>sockaddr</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>serv_addr</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>serv_addr</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>sock</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>connect_socket</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>ip</span><span class=p>,</span> <span class=k>const</span> <span class=kt>int</span> <span class=o>&amp;</span><span class=n>port</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>sock</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>sockaddr_in</span> <span class=n>serv_addr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>init_socket</span><span class=p>(</span><span class=o>&amp;</span><span class=n>sock</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>serv_addr</span><span class=p>,</span> <span class=n>ip</span><span class=p>,</span> <span class=n>port</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>connect</span><span class=p>(</span><span class=n>sock</span><span class=p>,</span> <span class=p>(</span><span class=k>struct</span> <span class=n>sockaddr</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>serv_addr</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>serv_addr</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>sock</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=server>server</h3><p>server主要是监听端口, 收到客户端请求并且返回后, 继续监听.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=c1>// server.cpp
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;arpa/inet.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/socket.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;netinet/in.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;utils.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span> <span class=o>**</span><span class=n>argv</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>serv_sock</span> <span class=o>=</span> <span class=n>bind_socket</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>atoi</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>2</span><span class=p>]));</span>
</span></span><span class=line><span class=cl>    <span class=n>listen</span><span class=p>(</span><span class=n>serv_sock</span><span class=p>,</span> <span class=mi>1024</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>sockaddr_in</span> <span class=n>clnt_addr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>socklen_t</span> <span class=n>clnt_addr_size</span> <span class=o>=</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>clnt_addr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>say</span><span class=p>[</span><span class=mi>1024</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>clnt_sock</span> <span class=o>=</span> <span class=n>accept</span><span class=p>(</span><span class=n>serv_sock</span><span class=p>,</span> <span class=p>(</span><span class=k>struct</span> <span class=n>sockaddr</span><span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>clnt_addr</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>clnt_addr_size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>memset</span><span class=p>(</span><span class=n>say</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>say</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=n>read</span><span class=p>(</span><span class=n>clnt_sock</span><span class=p>,</span> <span class=n>say</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>say</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=n>printf</span><span class=p>(</span><span class=s>&#34;%s say: %s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>inet_ntoa</span><span class=p>(</span><span class=n>clnt_addr</span><span class=p>.</span><span class=n>sin_addr</span><span class=p>),</span> <span class=n>say</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>memset</span><span class=p>(</span><span class=n>say</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>say</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=n>printf</span><span class=p>(</span><span class=s>&#34;you say: &#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=kt>char</span> <span class=o>*</span><span class=n>s</span> <span class=o>=</span> <span class=n>fgets</span><span class=p>(</span><span class=n>say</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>say</span><span class=p>),</span> <span class=n>stdin</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>say</span><span class=p>[</span><span class=n>strlen</span><span class=p>(</span><span class=n>s</span><span class=p>)</span> <span class=o>-</span> <span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=sc>&#39;\0&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>write</span><span class=p>(</span><span class=n>clnt_sock</span><span class=p>,</span> <span class=n>say</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>say</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>close</span><span class=p>(</span><span class=n>clnt_sock</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>close</span><span class=p>(</span><span class=n>serv_sock</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=client>client</h3><p>客户端尝试连接服务端, 给服务端发送请求并且收到服务端的返回后, 则尝试下一次连接.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=c1>// client.cpp
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;arpa/inet.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/socket.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;utils.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span> <span class=o>**</span><span class=n>argv</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>say</span><span class=p>[</span><span class=mi>1024</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>serv_sock</span> <span class=o>=</span> <span class=n>connect_socket</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>atoi</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>2</span><span class=p>]));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>memset</span><span class=p>(</span><span class=n>say</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>say</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=n>printf</span><span class=p>(</span><span class=s>&#34;you say: &#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=kt>char</span> <span class=o>*</span><span class=n>s</span> <span class=o>=</span> <span class=n>fgets</span><span class=p>(</span><span class=n>say</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>say</span><span class=p>),</span> <span class=n>stdin</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>say</span><span class=p>[</span><span class=n>strlen</span><span class=p>(</span><span class=n>s</span><span class=p>)</span> <span class=o>-</span> <span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=sc>&#39;\0&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>strcmp</span><span class=p>(</span><span class=n>say</span><span class=p>,</span> <span class=s>&#34;q&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>write</span><span class=p>(</span><span class=n>serv_sock</span><span class=p>,</span> <span class=n>say</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>say</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>memset</span><span class=p>(</span><span class=n>say</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>say</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=n>read</span><span class=p>(</span><span class=n>serv_sock</span><span class=p>,</span> <span class=n>say</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>say</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=n>printf</span><span class=p>(</span><span class=s>&#34;%s say: %s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>say</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>close</span><span class=p>(</span><span class=n>serv_sock</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=输出>输出</h3><p>首先启动server端</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl>$ ./server 127.0.0.1 <span class=m>7777</span>
</span></span><span class=line><span class=cl>127.0.0.1 say: hi
</span></span><span class=line><span class=cl>you say: hi, i got you
</span></span><span class=line><span class=cl>127.0.0.1 say: bye
</span></span><span class=line><span class=cl>you say: byebye
</span></span></code></pre></td></tr></table></div></div><p>然后启动client端</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl>$ ./client 127.0.0.1 <span class=m>7777</span>
</span></span><span class=line><span class=cl>you say: hi
</span></span><span class=line><span class=cl>127.0.0.1 say: hi, i got you
</span></span><span class=line><span class=cl>you say: bye
</span></span><span class=line><span class=cl>127.0.0.1 say: byebye
</span></span><span class=line><span class=cl>you say: q
</span></span></code></pre></td></tr></table></div></div><p>如果是同一局域网下的不同机器, 只要知道服务端的ip和监听端口就可以实现同一局域网不同机器之间的通信.</p><h2 id=socket>socket</h2><p><code>socket</code>函数返回的是一个<code>int</code>型, 一般可以知道这大概是一个fd, 下面我们来挖一挖<code>socket</code>函数.</p><p>glibc给我们提供的<code>socket</code>函数调用的是<code>__sys_socket</code>.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=n>SYSCALL_DEFINE3</span><span class=p>(</span><span class=n>socket</span><span class=p>,</span> <span class=kt>int</span><span class=p>,</span> <span class=n>family</span><span class=p>,</span> <span class=kt>int</span><span class=p>,</span> <span class=n>type</span><span class=p>,</span> <span class=kt>int</span><span class=p>,</span> <span class=n>protocol</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>__sys_socket</span><span class=p>(</span><span class=n>family</span><span class=p>,</span> <span class=n>type</span><span class=p>,</span> <span class=n>protocol</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>__sys_socket</code>大致可以分为三个部分:</p><ol><li>处理flag</li><li>创建<code>sock</code></li><li><code>sock</code>和<code>file</code>关联</li></ol><p>如下, 将处理flag部分暂时省略了, 这部分主要是一些mask的操作.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=kt>int</span> <span class=nf>__sys_socket</span><span class=p>(</span><span class=kt>int</span> <span class=n>family</span><span class=p>,</span> <span class=kt>int</span> <span class=n>type</span><span class=p>,</span> <span class=kt>int</span> <span class=n>protocol</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>retval</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>socket</span> <span class=o>*</span><span class=n>sock</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>flags</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=cm>/* Check the SOCK_* constants for consistency.  */</span>
</span></span><span class=line><span class=cl>	<span class=c1>//......
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=n>retval</span> <span class=o>=</span> <span class=n>sock_create</span><span class=p>(</span><span class=n>family</span><span class=p>,</span> <span class=n>type</span><span class=p>,</span> <span class=n>protocol</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>sock</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>retval</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=n>retval</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>sock_map_fd</span><span class=p>(</span><span class=n>sock</span><span class=p>,</span> <span class=n>flags</span> <span class=o>&amp;</span> <span class=p>(</span><span class=n>O_CLOEXEC</span> <span class=o>|</span> <span class=n>O_NONBLOCK</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>sock_create</code>创建了<code>sock</code>, 然后用<code>sock</code>和<code>file</code>关联, 并且返回一个fd. 下面继续看看<code>sock_create</code>和<code>sock_map_fd</code>.</p><h3 id=sock_create>sock_create</h3><p><code>sock_create</code>会调用一个更复杂的<code>__sock_create</code>, <code>__sock_create</code>可以区分是否是kernel的调用, 根据是否是kernel调用在创建<code>sock</code>的时候也会有区别.</p><h4 id=__sock_create>__sock_create</h4><p><code>__sock_create</code>大概可以分为两部分, <code>security_socket_create</code>和<code>sock_alloc</code>.</p><p><code>security_socket_create</code>会关联一个hook函数, 这里就没有继续追踪下去了(TODO).</p><p><code>sock_alloc</code>则会让<code>sock</code>和<code>inode</code>关联起来, 继续往下看.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=c1>// __sock_create
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=n>err</span> <span class=o>=</span> <span class=n>security_socket_create</span><span class=p>(</span><span class=n>family</span><span class=p>,</span> <span class=n>type</span><span class=p>,</span> <span class=n>protocol</span><span class=p>,</span> <span class=n>kern</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=n>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>err</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>	*	Allocate the socket and allow the family to set things up. if
</span></span></span><span class=line><span class=cl><span class=cm>	*	the protocol is 0, the family is instructed to select an appropriate
</span></span></span><span class=line><span class=cl><span class=cm>	*	default.
</span></span></span><span class=line><span class=cl><span class=cm>	*/</span>
</span></span><span class=line><span class=cl><span class=n>sock</span> <span class=o>=</span> <span class=n>sock_alloc</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=c1>// ......
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=n>rcu_read_lock</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=n>pf</span> <span class=o>=</span> <span class=n>rcu_dereference</span><span class=p>(</span><span class=n>net_families</span><span class=p>[</span><span class=n>family</span><span class=p>]);</span>
</span></span><span class=line><span class=cl><span class=c1>// ......
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/* Now protected by module ref count */</span>
</span></span><span class=line><span class=cl><span class=n>rcu_read_unlock</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=n>err</span> <span class=o>=</span> <span class=n>pf</span><span class=o>-&gt;</span><span class=n>create</span><span class=p>(</span><span class=n>net</span><span class=p>,</span> <span class=n>sock</span><span class=p>,</span> <span class=n>protocol</span><span class=p>,</span> <span class=n>kern</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=sock_alloc>sock_alloc</h4><p><code>sock_alloc</code>大概分为三部分:</p><ol><li>在vfs的<code>super block</code>创建一个新的<code>inode</code></li><li>将新的<code>inode</code>扩展为一个<code>sock</code>(这部分比较有意思)</li><li>对<code>inode</code>做一些初始化</li></ol><p>对<code>inode</code>的初始化以下就省略了.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=c1>// struct socket *sock_alloc(void)
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=n>inode</span> <span class=o>=</span> <span class=n>new_inode_pseudo</span><span class=p>(</span><span class=n>sock_mnt</span><span class=o>-&gt;</span><span class=n>mnt_sb</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>inode</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>sock</span> <span class=o>=</span> <span class=n>SOCKET_I</span><span class=p>(</span><span class=n>inode</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p><code>new_inode_pseudo</code>暂且认为通过vfs根结点申请了一个<code>inode</code>, 并且返回. 接下来将这个<code>inode</code>输入给<code>SOCKET_I</code>.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=k>static</span> <span class=kr>inline</span> <span class=k>struct</span> <span class=n>socket</span> <span class=o>*</span><span class=nf>SOCKET_I</span><span class=p>(</span><span class=k>struct</span> <span class=n>inode</span> <span class=o>*</span><span class=n>inode</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=o>&amp;</span><span class=n>container_of</span><span class=p>(</span><span class=n>inode</span><span class=p>,</span> <span class=k>struct</span> <span class=n>socket_alloc</span><span class=p>,</span> <span class=n>vfs_inode</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>socket</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=cm>/*****
</span></span></span><span class=line><span class=cl><span class=cm> * ({
</span></span></span><span class=line><span class=cl><span class=cm> *  void *__mptr = (void *)(socket);
</span></span></span><span class=line><span class=cl><span class=cm> *  ((struct socket_alloc *)(__mptr - __builtin_offsetof(struct socket_alloc, socket)));
</span></span></span><span class=line><span class=cl><span class=cm> * })
</span></span></span><span class=line><span class=cl><span class=cm>*****/</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>SOCKET_I</code>大概意思就是可以通过<code>inode</code>的地址得到<code>socket</code>的地址. 在这里<code>socket</code>和<code>inode</code>被放在同一个结构体<code>socket_alloc</code>下面, 所以可以通过<code>inode</code>找到<code>socket</code>是可以理解的.</p><p>目前遗留的问题是, 如果通过<code>inode</code>可以找到<code>socket</code>并且不发生内存越界, 这就意为着<code>socket</code>事先就已经分配好, 并且和<code>inode</code>放在一起了. 那么, <code>socket</code>是什么时候分配的呢? (TODO)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=k>struct</span> <span class=n>socket_alloc</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>socket</span> <span class=n>socket</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>inode</span>  <span class=n>vfs_inode</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><p>以上, 我们拿到了<code>socket</code>结构体, <code>socket</code>里面包含了什么? 如下:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=k>struct</span> <span class=n>socket</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>socket_state</span>			<span class=n>state</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>short</span>					<span class=n>type</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>long</span>			<span class=n>flags</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>socket_wq</span>		<span class=o>*</span><span class=n>wq</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>file</span>				<span class=o>*</span><span class=n>file</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>sock</span>				<span class=o>*</span><span class=n>sk</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>const</span> <span class=k>struct</span> <span class=n>proto_ops</span>	<span class=o>*</span><span class=n>ops</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><p>比较有意思的成员有三个: <code>file</code>/<code>sk</code>和<code>ops</code>.</p><ul><li><p><code>file</code>怎么和<code>socket</code>关联起来可以看下面的<a href=#sock_map_fd rel>sock_map_fd</a>.</p></li><li><p><code>sk</code>指向了一个更复杂的<code>struct sock</code>结构体.</p></li><li><p><code>ops</code>是sock的操作表, 规范了一些操作函数, 这种写法在最近的学习中已经见过很多次了. 如下是部分ops函数:</p></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=k>const</span> <span class=k>struct</span> <span class=n>proto_ops</span> <span class=n>inet_stream_ops</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=p>.</span><span class=n>family</span>		   <span class=o>=</span> <span class=n>PF_INET</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>.</span><span class=n>owner</span>		   <span class=o>=</span> <span class=n>THIS_MODULE</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>.</span><span class=n>release</span>	   <span class=o>=</span> <span class=n>inet_release</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>.</span><span class=n>bind</span>		   <span class=o>=</span> <span class=n>inet_bind</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>.</span><span class=n>connect</span>	   <span class=o>=</span> <span class=n>inet_stream_connect</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>.</span><span class=n>socketpair</span>	   <span class=o>=</span> <span class=n>sock_no_socketpair</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>.</span><span class=n>accept</span>		   <span class=o>=</span> <span class=n>inet_accept</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>.</span><span class=n>getname</span>	   <span class=o>=</span> <span class=n>inet_getname</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>.</span><span class=n>poll</span>		   <span class=o>=</span> <span class=n>tcp_poll</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>.</span><span class=n>ioctl</span>		   <span class=o>=</span> <span class=n>inet_ioctl</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>.</span><span class=n>listen</span>		   <span class=o>=</span> <span class=n>inet_listen</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>.</span><span class=n>shutdown</span>	   <span class=o>=</span> <span class=n>inet_shutdown</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=c1>// ......
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=sock_map_fd>sock_map_fd</h3><p><code>sock_map_fd</code>大概分为两部分:</p><ol><li>找到一个空闲的fd</li><li>生成一个新的<code>file</code>, 并且将fd和<code>file</code>关联</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=k>static</span> <span class=kt>int</span> <span class=nf>sock_map_fd</span><span class=p>(</span><span class=k>struct</span> <span class=n>socket</span> <span class=o>*</span><span class=n>sock</span><span class=p>,</span> <span class=kt>int</span> <span class=n>flags</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>file</span> <span class=o>*</span><span class=n>newfile</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>fd</span> <span class=o>=</span> <span class=n>get_unused_fd_flags</span><span class=p>(</span><span class=n>flags</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>unlikely</span><span class=p>(</span><span class=n>fd</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>sock_release</span><span class=p>(</span><span class=n>sock</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=n>fd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=n>newfile</span> <span class=o>=</span> <span class=n>sock_alloc_file</span><span class=p>(</span><span class=n>sock</span><span class=p>,</span> <span class=n>flags</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>likely</span><span class=p>(</span><span class=o>!</span><span class=n>IS_ERR</span><span class=p>(</span><span class=n>newfile</span><span class=p>)))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>fd_install</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=n>newfile</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=n>fd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=n>put_unused_fd</span><span class=p>(</span><span class=n>fd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>PTR_ERR</span><span class=p>(</span><span class=n>newfile</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=sock_alloc_file>sock_alloc_file</h4><p><code>sock_alloc_file</code>会创建一个新的<code>file</code>, 并且将<code>file</code>和<code>socket</code>关联:</p><ol><li>sock->file = file;</li><li>file->private_data = sock;</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=k>struct</span> <span class=n>file</span> <span class=o>*</span><span class=nf>sock_alloc_file</span><span class=p>(</span><span class=k>struct</span> <span class=n>socket</span> <span class=o>*</span><span class=n>sock</span><span class=p>,</span> <span class=kt>int</span> <span class=n>flags</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>dname</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>file</span> <span class=o>*</span><span class=n>file</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>dname</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>dname</span> <span class=o>=</span> <span class=n>sock</span><span class=o>-&gt;</span><span class=n>sk</span> <span class=o>?</span> <span class=n>sock</span><span class=o>-&gt;</span><span class=n>sk</span><span class=o>-&gt;</span><span class=n>sk_prot_creator</span><span class=o>-&gt;</span><span class=nl>name</span> <span class=p>:</span> <span class=s>&#34;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>file</span> <span class=o>=</span> <span class=n>alloc_file_pseudo</span><span class=p>(</span><span class=n>SOCK_INODE</span><span class=p>(</span><span class=n>sock</span><span class=p>),</span> <span class=n>sock_mnt</span><span class=p>,</span> <span class=n>dname</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=n>O_RDWR</span> <span class=o>|</span> <span class=p>(</span><span class=n>flags</span> <span class=o>&amp;</span> <span class=n>O_NONBLOCK</span><span class=p>),</span>
</span></span><span class=line><span class=cl>				<span class=o>&amp;</span><span class=n>socket_file_ops</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>IS_ERR</span><span class=p>(</span><span class=n>file</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>sock_release</span><span class=p>(</span><span class=n>sock</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=n>file</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=n>sock</span><span class=o>-&gt;</span><span class=n>file</span> <span class=o>=</span> <span class=n>file</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>file</span><span class=o>-&gt;</span><span class=n>private_data</span> <span class=o>=</span> <span class=n>sock</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>file</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>将<code>sock</code>和<code>file</code>关联, 就可以通过<code>file</code>找到对应的<code>sock</code>.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=k>struct</span> <span class=n>socket</span> <span class=o>*</span><span class=nf>sock_from_file</span><span class=p>(</span><span class=k>struct</span> <span class=n>file</span> <span class=o>*</span><span class=n>file</span><span class=p>,</span> <span class=kt>int</span> <span class=o>*</span><span class=n>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>file</span><span class=o>-&gt;</span><span class=n>f_op</span> <span class=o>==</span> <span class=o>&amp;</span><span class=n>socket_file_ops</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=n>file</span><span class=o>-&gt;</span><span class=n>private_data</span><span class=p>;</span>	<span class=cm>/* set in sock_map_fd */</span>
</span></span><span class=line><span class=cl>	<span class=o>*</span><span class=n>err</span> <span class=o>=</span> <span class=o>-</span><span class=n>ENOTSOCK</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=小结>小结</h3><p>在创建<code>socket</code>的时候, 同时会创建<code>inode</code>和<code>file</code>, 将<code>socket</code>和<code>inode</code>以及<code>file</code>关联. 这样, 通过fd就可以找到<code>file</code>, 进而找到对应的<code>socket</code>. 由此, 我们也可以说, 对<code>socket</code>的操作就是对文件的操作.</p><h2 id=bind>bind</h2><p><code>bind</code>调用的是<code>__sys_bind</code>.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=n>SYSCALL_DEFINE3</span><span class=p>(</span><span class=n>bind</span><span class=p>,</span> <span class=kt>int</span><span class=p>,</span> <span class=n>fd</span><span class=p>,</span> <span class=k>struct</span> <span class=n>sockaddr</span> <span class=n>__user</span> <span class=o>*</span><span class=p>,</span> <span class=n>umyaddr</span><span class=p>,</span> <span class=kt>int</span><span class=p>,</span> <span class=n>addrlen</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>__sys_bind</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=n>umyaddr</span><span class=p>,</span> <span class=n>addrlen</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>__sys_bind</code>大致可以分为三个部分:</p><ol><li>通过fd拿到<code>sock</code></li><li>将用户空间的参数移动到内核空间</li><li>hook调用监听<code>bind</code></li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=kt>int</span> <span class=nf>__sys_bind</span><span class=p>(</span><span class=kt>int</span> <span class=n>fd</span><span class=p>,</span> <span class=k>struct</span> <span class=n>sockaddr</span> <span class=n>__user</span> <span class=o>*</span><span class=n>umyaddr</span><span class=p>,</span> <span class=kt>int</span> <span class=n>addrlen</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>socket</span> <span class=o>*</span><span class=n>sock</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>sockaddr_storage</span> <span class=n>address</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>err</span><span class=p>,</span> <span class=n>fput_needed</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>sock</span> <span class=o>=</span> <span class=n>sockfd_lookup_light</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>err</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>fput_needed</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>sock</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>err</span> <span class=o>=</span> <span class=n>move_addr_to_kernel</span><span class=p>(</span><span class=n>umyaddr</span><span class=p>,</span> <span class=n>addrlen</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>address</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>err</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=n>err</span> <span class=o>=</span> <span class=n>security_socket_bind</span><span class=p>(</span><span class=n>sock</span><span class=p>,</span>
</span></span><span class=line><span class=cl>						   <span class=p>(</span><span class=k>struct</span> <span class=n>sockaddr</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>address</span><span class=p>,</span>
</span></span><span class=line><span class=cl>						   <span class=n>addrlen</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=n>err</span> <span class=o>=</span> <span class=n>sock</span><span class=o>-&gt;</span><span class=n>ops</span><span class=o>-&gt;</span><span class=n>bind</span><span class=p>(</span><span class=n>sock</span><span class=p>,</span>
</span></span><span class=line><span class=cl>						      <span class=p>(</span><span class=k>struct</span> <span class=n>sockaddr</span> <span class=o>*</span><span class=p>)</span>
</span></span><span class=line><span class=cl>						      <span class=o>&amp;</span><span class=n>address</span><span class=p>,</span> <span class=n>addrlen</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=n>fput_light</span><span class=p>(</span><span class=n>sock</span><span class=o>-&gt;</span><span class=n>file</span><span class=p>,</span> <span class=n>fput_needed</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>err</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=sockfd_lookup_light>sockfd_lookup_light</h3><p><code>sockfd_lookup_light</code>可以通过fd找到<code>sock</code>, 在<a href=/202105/process-ctracon4/ rel>进程控制和进程通信(四)</a>中, 我们已经学习了通过fd可以找到进程的<code>struct file</code>. 在上一节中, 我们又知道在创建<code>socket</code>的时候, <code>socket</code>和<code>file</code>已经关联起来, 所以通过<code>file</code>又可以找到<code>socket</code>.</p><p>下面就是通过fd找到<code>socket</code>的函数.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=k>static</span> <span class=k>struct</span> <span class=n>socket</span> <span class=o>*</span><span class=nf>sockfd_lookup_light</span><span class=p>(</span><span class=kt>int</span> <span class=n>fd</span><span class=p>,</span> <span class=kt>int</span> <span class=o>*</span><span class=n>err</span><span class=p>,</span> <span class=kt>int</span> <span class=o>*</span><span class=n>fput_needed</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>fd</span> <span class=n>f</span> <span class=o>=</span> <span class=n>fdget</span><span class=p>(</span><span class=n>fd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>socket</span> <span class=o>*</span><span class=n>sock</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=o>*</span><span class=n>err</span> <span class=o>=</span> <span class=o>-</span><span class=n>EBADF</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>f</span><span class=p>.</span><span class=n>file</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>sock</span> <span class=o>=</span> <span class=n>sock_from_file</span><span class=p>(</span><span class=n>f</span><span class=p>.</span><span class=n>file</span><span class=p>,</span> <span class=n>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=n>likely</span><span class=p>(</span><span class=n>sock</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=o>*</span><span class=n>fput_needed</span> <span class=o>=</span> <span class=n>f</span><span class=p>.</span><span class=n>flags</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=n>sock</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=n>fdput</span><span class=p>(</span><span class=n>f</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>通过<code>file</code>找到<code>socket</code>, 在上一节已经看过这个函数了.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=k>struct</span> <span class=n>socket</span> <span class=o>*</span><span class=nf>sock_from_file</span><span class=p>(</span><span class=k>struct</span> <span class=n>file</span> <span class=o>*</span><span class=n>file</span><span class=p>,</span> <span class=kt>int</span> <span class=o>*</span><span class=n>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>file</span><span class=o>-&gt;</span><span class=n>f_op</span> <span class=o>==</span> <span class=o>&amp;</span><span class=n>socket_file_ops</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=n>file</span><span class=o>-&gt;</span><span class=n>private_data</span><span class=p>;</span>	<span class=cm>/* set in sock_map_fd */</span>
</span></span><span class=line><span class=cl>	<span class=o>*</span><span class=n>err</span> <span class=o>=</span> <span class=o>-</span><span class=n>ENOTSOCK</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=move_addr_to_kernel>move_addr_to_kernel</h3><p>将用户空间参数移动到内核空间, 如果参数长度太大, 则会报错.</p><p>为什么需要从用户空间移动到内核空间呢?</p><p>可以参考下一节<a href=#listen rel>listen</a>. 我认为是因为<code>listen</code>是在内核空间的, 为了<strong>减少频繁的用户/内核的切换</strong>, 所以在<code>bind</code>的时候就将用户空间的参数先复制到内核空间了.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> *	move_addr_to_kernel	-	copy a socket address into kernel space
</span></span></span><span class=line><span class=cl><span class=cm> *	@uaddr: Address in user space
</span></span></span><span class=line><span class=cl><span class=cm> *	@kaddr: Address in kernel space
</span></span></span><span class=line><span class=cl><span class=cm> *	@ulen:  Length in user space
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> *	The address is copied into kernel space. If the provided address is
</span></span></span><span class=line><span class=cl><span class=cm> *	too long an error code of -EINVAL is returned. If the copy gives
</span></span></span><span class=line><span class=cl><span class=cm> *	invalid addresses -EFAULT is returned. On a success 0 is returned.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>move_addr_to_kernel</span><span class=p>(</span><span class=kt>void</span> <span class=n>__user</span> <span class=o>*</span><span class=n>uaddr</span><span class=p>,</span> <span class=kt>int</span> <span class=n>ulen</span><span class=p>,</span> <span class=k>struct</span> <span class=n>sockaddr_storage</span> <span class=o>*</span><span class=n>kaddr</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>ulen</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=o>||</span> <span class=n>ulen</span> <span class=o>&gt;</span> <span class=k>sizeof</span><span class=p>(</span><span class=k>struct</span> <span class=n>sockaddr_storage</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=o>-</span><span class=n>EINVAL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>ulen</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>copy_from_user</span><span class=p>(</span><span class=n>kaddr</span><span class=p>,</span> <span class=n>uaddr</span><span class=p>,</span> <span class=n>ulen</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=o>-</span><span class=n>EFAULT</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>audit_sockaddr</span><span class=p>(</span><span class=n>ulen</span><span class=p>,</span> <span class=n>kaddr</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=inet_bind>inet_bind</h3><p><code>bind</code>入参<code>struct sockaddr *uaddr</code>, 虽然写的是用户addr, 但是在上一小节的转换中, 这里的<code>uaddr</code>已经是内核空间的addr了.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=kt>int</span> <span class=nf>inet_bind</span><span class=p>(</span><span class=k>struct</span> <span class=n>socket</span> <span class=o>*</span><span class=n>sock</span><span class=p>,</span> <span class=k>struct</span> <span class=n>sockaddr</span> <span class=o>*</span><span class=n>uaddr</span><span class=p>,</span> <span class=kt>int</span> <span class=n>addr_len</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// ......
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=cm>/* If the socket has its own bind function then use it. (RAW) */</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>sk</span><span class=o>-&gt;</span><span class=n>sk_prot</span><span class=o>-&gt;</span><span class=n>bind</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=n>sk</span><span class=o>-&gt;</span><span class=n>sk_prot</span><span class=o>-&gt;</span><span class=n>bind</span><span class=p>(</span><span class=n>sk</span><span class=p>,</span> <span class=n>uaddr</span><span class=p>,</span> <span class=n>addr_len</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// ......
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>return</span> <span class=n>__inet_bind</span><span class=p>(</span><span class=n>sk</span><span class=p>,</span> <span class=n>uaddr</span><span class=p>,</span> <span class=n>addr_len</span><span class=p>,</span> <span class=nb>false</span><span class=p>,</span> <span class=nb>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=__inet_bind>__inet_bind</h4><p><code>__inet_bind</code>大概可以分为两个部分:</p><ol><li>校验</li><li>绑定</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=kt>int</span> <span class=nf>__inet_bind</span><span class=p>(</span><span class=k>struct</span> <span class=n>sock</span> <span class=o>*</span><span class=n>sk</span><span class=p>,</span> <span class=k>struct</span> <span class=n>sockaddr</span> <span class=o>*</span><span class=n>uaddr</span><span class=p>,</span> <span class=kt>int</span> <span class=n>addr_len</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=kt>bool</span> <span class=n>force_bind_address_no_port</span><span class=p>,</span> <span class=kt>bool</span> <span class=n>with_lock</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>sockaddr_in</span> <span class=o>*</span><span class=n>addr</span> 	<span class=o>=</span> <span class=p>(</span><span class=k>struct</span> <span class=n>sockaddr_in</span> <span class=o>*</span><span class=p>)</span><span class=n>uaddr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>inet_sock</span> <span class=o>*</span><span class=n>inet</span> 		<span class=o>=</span> <span class=n>inet_sk</span><span class=p>(</span><span class=n>sk</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>net</span> <span class=o>*</span><span class=n>net</span> 			<span class=o>=</span> <span class=n>sock_net</span><span class=p>(</span><span class=n>sk</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>short</span> 	<span class=n>snum</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> 			<span class=n>chk_addr_ret</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>u32</span> 			<span class=n>tb_id</span> <span class=o>=</span> <span class=n>RT_TABLE_LOCAL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=c1>// ......
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=c1>// 端口校验
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=n>snum</span> <span class=o>=</span> <span class=n>ntohs</span><span class=p>(</span><span class=n>addr</span><span class=o>-&gt;</span><span class=n>sin_port</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>err</span> <span class=o>=</span> <span class=o>-</span><span class=n>EACCES</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>snum</span> <span class=o>&amp;&amp;</span> <span class=n>snum</span> <span class=o>&lt;</span> <span class=n>inet_prot_sock</span><span class=p>(</span><span class=n>net</span><span class=p>)</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>	    <span class=o>!</span><span class=n>ns_capable</span><span class=p>(</span><span class=n>net</span><span class=o>-&gt;</span><span class=n>user_ns</span><span class=p>,</span> <span class=n>CAP_NET_BIND_SERVICE</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=k>goto</span> <span class=n>out</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=c1>// ......
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=c1>// 检查是否重复绑定
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=p>(</span><span class=n>sk</span><span class=o>-&gt;</span><span class=n>sk_state</span> <span class=o>!=</span> <span class=n>TCP_CLOSE</span> <span class=o>||</span> <span class=n>inet</span><span class=o>-&gt;</span><span class=n>inet_num</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>goto</span> <span class=n>out_release_sock</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=c1>// ......
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=c1>// 开始绑定
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=cm>/* Make sure we are allowed to bind here. */</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>snum</span> <span class=o>||</span> <span class=o>!</span><span class=p>(</span><span class=n>inet</span><span class=o>-&gt;</span><span class=n>bind_address_no_port</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>		      <span class=n>force_bind_address_no_port</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=n>sk</span><span class=o>-&gt;</span><span class=n>sk_prot</span><span class=o>-&gt;</span><span class=n>get_port</span><span class=p>(</span><span class=n>sk</span><span class=p>,</span> <span class=n>snum</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=n>inet</span><span class=o>-&gt;</span><span class=n>inet_saddr</span> <span class=o>=</span> <span class=n>inet</span><span class=o>-&gt;</span><span class=n>inet_rcv_saddr</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=n>err</span> <span class=o>=</span> <span class=o>-</span><span class=n>EADDRINUSE</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=k>goto</span> <span class=n>out_release_sock</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=n>err</span> <span class=o>=</span> <span class=n>BPF_CGROUP_RUN_PROG_INET4_POST_BIND</span><span class=p>(</span><span class=n>sk</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=n>err</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=n>inet</span><span class=o>-&gt;</span><span class=n>inet_saddr</span> <span class=o>=</span> <span class=n>inet</span><span class=o>-&gt;</span><span class=n>inet_rcv_saddr</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=k>goto</span> <span class=n>out_release_sock</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// ......
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>如上, 校验部分, 一是校验端口权限(端口ID很小时)和是否和法, 二是检查是否已经绑定过.</p><p>校验成功之后就开始执行绑定部分, 调用的是<code>get_port</code>函数. <code>get_port</code>根据不同的协议簇会调用不同的绑定函数, 大体是将<code>socket</code>信息加入到一个hash表. (TODO: 端口绑定到底是怎么回事?)</p><h3 id=小结-1>小结</h3><p><code>bind</code>将ip地址和端口与<code>socket</code>绑定, 不同的协议簇会执行不同绑定函数. 在绑定之前, 会将绑定参数从用户空间移动到内核空间, 然后会检查绑定参数, 比如ip地址是否合法(支持), 端口是否合且是否有对应的权限可以操作, 也会检查是否是重复绑定. 检查过后就会将端口和<code>socket</code>绑定, 端口绑定会将参数送入内核空间的一个hash表. 端口可以重复绑定, 需要修改hash表对应value的值, 也可以实现自动绑定, 内核可以随机一个可以绑定的端口给<code>socket</code>实现绑定.</p><h2 id=listen>listen</h2><p><code>listen</code>调用的是<code>__sys_listen</code>.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=n>SYSCALL_DEFINE2</span><span class=p>(</span><span class=n>listen</span><span class=p>,</span> <span class=kt>int</span><span class=p>,</span> <span class=n>fd</span><span class=p>,</span> <span class=kt>int</span><span class=p>,</span> <span class=n>backlog</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>__sys_listen</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=n>backlog</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>__sys_listen</code>大概可以分为三部分:</p><ol><li>通过fd找到<code>sock</code></li><li>设置<code>sock</code>连接的最大数</li><li>hook调用监听<code>sock</code></li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=kt>int</span> <span class=nf>__sys_listen</span><span class=p>(</span><span class=kt>int</span> <span class=n>fd</span><span class=p>,</span> <span class=kt>int</span> <span class=n>backlog</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>socket</span> <span class=o>*</span><span class=n>sock</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>err</span><span class=p>,</span> <span class=n>fput_needed</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>somaxconn</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>sock</span> <span class=o>=</span> <span class=n>sockfd_lookup_light</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>err</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>fput_needed</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>sock</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>somaxconn</span> <span class=o>=</span> <span class=n>sock_net</span><span class=p>(</span><span class=n>sock</span><span class=o>-&gt;</span><span class=n>sk</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>core</span><span class=p>.</span><span class=n>sysctl_somaxconn</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>((</span><span class=kt>unsigned</span> <span class=kt>int</span><span class=p>)</span><span class=n>backlog</span> <span class=o>&gt;</span> <span class=n>somaxconn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=n>backlog</span> <span class=o>=</span> <span class=n>somaxconn</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=n>err</span> <span class=o>=</span> <span class=n>security_socket_listen</span><span class=p>(</span><span class=n>sock</span><span class=p>,</span> <span class=n>backlog</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=n>err</span> <span class=o>=</span> <span class=n>sock</span><span class=o>-&gt;</span><span class=n>ops</span><span class=o>-&gt;</span><span class=n>listen</span><span class=p>(</span><span class=n>sock</span><span class=p>,</span> <span class=n>backlog</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=n>fput_light</span><span class=p>(</span><span class=n>sock</span><span class=o>-&gt;</span><span class=n>file</span><span class=p>,</span> <span class=n>fput_needed</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>err</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=inet_listen>inet_listen</h3><p><a href=https://blog.csdn.net/zhangskd/article/details/14446581 target=_blank rel="noopener noreffer"><code>listen</code>最终调用到<code>inet_listen</code></a>. 大致分为两部分:</p><ol><li>准备</li><li>开始监听</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=kt>int</span> <span class=nf>inet_listen</span><span class=p>(</span><span class=k>struct</span> <span class=n>socket</span> <span class=o>*</span><span class=n>sock</span><span class=p>,</span> <span class=kt>int</span> <span class=n>backlog</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>sock</span> <span class=o>*</span><span class=n>sk</span> <span class=o>=</span> <span class=n>sock</span><span class=o>-&gt;</span><span class=n>sk</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=c1>// ......
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=n>sk</span><span class=o>-&gt;</span><span class=n>sk_max_ack_backlog</span> <span class=o>=</span> <span class=n>backlog</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/* Really, if the socket is already in listen state
</span></span></span><span class=line><span class=cl><span class=cm>	 * we can only allow the backlog to be adjusted.
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>old_state</span> <span class=o>!=</span> <span class=n>TCP_LISTEN</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=cm>/* Enable TFO w/o requiring TCP_FASTOPEN socket option.
</span></span></span><span class=line><span class=cl><span class=cm>		 * Note that only TCP sockets (SOCK_STREAM) will reach here.
</span></span></span><span class=line><span class=cl><span class=cm>		 * Also fastopen backlog may already been set via the option
</span></span></span><span class=line><span class=cl><span class=cm>		 * because the socket was in TCP_LISTEN state previously but
</span></span></span><span class=line><span class=cl><span class=cm>		 * was shutdown() rather than close().
</span></span></span><span class=line><span class=cl><span class=cm>		 */</span>
</span></span><span class=line><span class=cl>		<span class=n>tcp_fastopen</span> <span class=o>=</span> <span class=n>sock_net</span><span class=p>(</span><span class=n>sk</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>ipv4</span><span class=p>.</span><span class=n>sysctl_tcp_fastopen</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>((</span><span class=n>tcp_fastopen</span> <span class=o>&amp;</span> <span class=n>TFO_SERVER_WO_SOCKOPT1</span><span class=p>)</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>		    <span class=p>(</span><span class=n>tcp_fastopen</span> <span class=o>&amp;</span> <span class=n>TFO_SERVER_ENABLE</span><span class=p>)</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>		    <span class=o>!</span><span class=n>inet_csk</span><span class=p>(</span><span class=n>sk</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>icsk_accept_queue</span><span class=p>.</span><span class=n>fastopenq</span><span class=p>.</span><span class=n>max_qlen</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=n>fastopen_queue_tune</span><span class=p>(</span><span class=n>sk</span><span class=p>,</span> <span class=n>backlog</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=n>tcp_fastopen_init_key_once</span><span class=p>(</span><span class=n>sock_net</span><span class=p>(</span><span class=n>sk</span><span class=p>));</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=n>err</span> <span class=o>=</span> <span class=n>inet_csk_listen_start</span><span class=p>(</span><span class=n>sk</span><span class=p>,</span> <span class=n>backlog</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=n>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>goto</span> <span class=n>out</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=n>tcp_call_bpf</span><span class=p>(</span><span class=n>sk</span><span class=p>,</span> <span class=n>BPF_SOCK_OPS_TCP_LISTEN_CB</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=n>err</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nl>out</span><span class=p>:</span>
</span></span><span class=line><span class=cl>	<span class=n>release_sock</span><span class=p>(</span><span class=n>sk</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>err</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=inet_csk_listen_start>inet_csk_listen_start</h4><p>开始监听时, 可以看到, 会将<code>sock</code>加入到一个hash表中. 后续调用不再追踪下去, 根据我们的<code>socket</code>应用可以看到, <code>listen</code>是不阻塞的, 所以<code>listen</code>在将<code>sock</code>塞入到hash表中之后, 就会返回. 那么结合上一节的结论, 我们基本可以知道, <strong>监听hash表被系统内核维护</strong>了.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=kt>int</span> <span class=nf>inet_csk_listen_start</span><span class=p>(</span><span class=k>struct</span> <span class=n>sock</span> <span class=o>*</span><span class=n>sk</span><span class=p>,</span> <span class=kt>int</span> <span class=n>backlog</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>inet_connection_sock</span> <span class=o>*</span><span class=n>icsk</span> <span class=o>=</span> <span class=n>inet_csk</span><span class=p>(</span><span class=n>sk</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>inet_sock</span> <span class=o>*</span><span class=n>inet</span> <span class=o>=</span> <span class=n>inet_sk</span><span class=p>(</span><span class=n>sk</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>err</span> <span class=o>=</span> <span class=o>-</span><span class=n>EADDRINUSE</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>reqsk_queue_alloc</span><span class=p>(</span><span class=o>&amp;</span><span class=n>icsk</span><span class=o>-&gt;</span><span class=n>icsk_accept_queue</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>sk</span><span class=o>-&gt;</span><span class=n>sk_ack_backlog</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>inet_csk_delack_init</span><span class=p>(</span><span class=n>sk</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=c1>// ......
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=n>inet_sk_state_store</span><span class=p>(</span><span class=n>sk</span><span class=p>,</span> <span class=n>TCP_LISTEN</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>sk</span><span class=o>-&gt;</span><span class=n>sk_prot</span><span class=o>-&gt;</span><span class=n>get_port</span><span class=p>(</span><span class=n>sk</span><span class=p>,</span> <span class=n>inet</span><span class=o>-&gt;</span><span class=n>inet_num</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>inet</span><span class=o>-&gt;</span><span class=n>inet_sport</span> <span class=o>=</span> <span class=n>htons</span><span class=p>(</span><span class=n>inet</span><span class=o>-&gt;</span><span class=n>inet_num</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=n>sk_dst_reset</span><span class=p>(</span><span class=n>sk</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=n>err</span> <span class=o>=</span> <span class=n>sk</span><span class=o>-&gt;</span><span class=n>sk_prot</span><span class=o>-&gt;</span><span class=n>hash</span><span class=p>(</span><span class=n>sk</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=n>likely</span><span class=p>(</span><span class=o>!</span><span class=n>err</span><span class=p>))</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=n>inet_sk_set_state</span><span class=p>(</span><span class=n>sk</span><span class=p>,</span> <span class=n>TCP_CLOSE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>err</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=小结-2>小结</h3><p><code>listen</code>首先通过fd拿到<code>sock</code>, 然后会根据系统设置以及用户设置确定连接的最大数. 根据<code>sock</code>的状态会决定是否进入监听, 以避免重复监听. 在监听时, 会将<code>sock</code>加入到一个监听hash表中, 并被内核维护.</p><h2 id=accept>accept</h2><p><code>accept</code>会调用<code>__sys_accept</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=n>SYSCALL_DEFINE3</span><span class=p>(</span><span class=n>accept</span><span class=p>,</span> <span class=kt>int</span><span class=p>,</span> <span class=n>fd</span><span class=p>,</span> <span class=k>struct</span> <span class=n>sockaddr</span> <span class=n>__user</span> <span class=o>*</span><span class=p>,</span> <span class=n>upeer_sockaddr</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=kt>int</span> <span class=n>__user</span> <span class=o>*</span><span class=p>,</span> <span class=n>upeer_addrlen</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>__sys_accept4</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=n>upeer_sockaddr</span><span class=p>,</span> <span class=n>upeer_addrlen</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>__sys_accept</code>先是通过fd拿到<code>sock</code>, 然后创建一个新的<code>sock</code>并且创建一个<code>struct file</code>与之关联, 最后调用<code>accept</code>. 分为三步:</p><ol><li>通过fd拿到<code>sock</code></li><li>创建新的<code>sock</code>和<code>struct file</code>, 并且关联两者</li><li>调用<code>accept</code></li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=c1>// __sys_accept4
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=n>sock</span> <span class=o>=</span> <span class=n>sockfd_lookup_light</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>err</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>fput_needed</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>// ......
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=n>newsock</span> <span class=o>=</span> <span class=n>sock_alloc</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>newsock</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>goto</span> <span class=n>out_put</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>newsock</span><span class=o>-&gt;</span><span class=n>type</span> <span class=o>=</span> <span class=n>sock</span><span class=o>-&gt;</span><span class=n>type</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>newsock</span><span class=o>-&gt;</span><span class=n>ops</span> <span class=o>=</span> <span class=n>sock</span><span class=o>-&gt;</span><span class=n>ops</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=c1>// ......
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=n>newfile</span> <span class=o>=</span> <span class=n>sock_alloc_file</span><span class=p>(</span><span class=n>newsock</span><span class=p>,</span> <span class=n>flags</span><span class=p>,</span> <span class=n>sock</span><span class=o>-&gt;</span><span class=n>sk</span><span class=o>-&gt;</span><span class=n>sk_prot_creator</span><span class=o>-&gt;</span><span class=n>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>// ......
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=n>err</span> <span class=o>=</span> <span class=n>security_socket_accept</span><span class=p>(</span><span class=n>sock</span><span class=p>,</span> <span class=n>newsock</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=n>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>goto</span> <span class=n>out_fd</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>err</span> <span class=o>=</span> <span class=n>sock</span><span class=o>-&gt;</span><span class=n>ops</span><span class=o>-&gt;</span><span class=n>accept</span><span class=p>(</span><span class=n>sock</span><span class=p>,</span> <span class=n>newsock</span><span class=p>,</span> <span class=n>sock</span><span class=o>-&gt;</span><span class=n>file</span><span class=o>-&gt;</span><span class=n>f_flags</span><span class=p>,</span> <span class=nb>false</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=n>err</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>goto</span> <span class=n>out_fd</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=c1>// ......
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nl>out_put</span><span class=p>:</span>
</span></span><span class=line><span class=cl>	<span class=n>fput_light</span><span class=p>(</span><span class=n>sock</span><span class=o>-&gt;</span><span class=n>file</span><span class=p>,</span> <span class=n>fput_needed</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nl>out</span><span class=p>:</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>err</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nl>out_fd</span><span class=p>:</span>
</span></span><span class=line><span class=cl>	<span class=n>fput</span><span class=p>(</span><span class=n>newfile</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>put_unused_fd</span><span class=p>(</span><span class=n>newfd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>goto</span> <span class=n>out_put</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=inet_accept>inet_accept</h3><p><code>accept</code>指向的是<code>inet_accept</code>函数.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=kt>int</span> <span class=nf>inet_accept</span><span class=p>(</span><span class=k>struct</span> <span class=n>socket</span> <span class=o>*</span><span class=n>sock</span><span class=p>,</span> <span class=k>struct</span> <span class=n>socket</span> <span class=o>*</span><span class=n>newsock</span><span class=p>,</span> <span class=kt>int</span> <span class=n>flags</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=kt>bool</span> <span class=n>kern</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>sock</span> <span class=o>*</span><span class=n>sk1</span> <span class=o>=</span> <span class=n>sock</span><span class=o>-&gt;</span><span class=n>sk</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>err</span> <span class=o>=</span> <span class=o>-</span><span class=n>EINVAL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>sock</span> <span class=o>*</span><span class=n>sk2</span> <span class=o>=</span> <span class=n>sk1</span><span class=o>-&gt;</span><span class=n>sk_prot</span><span class=o>-&gt;</span><span class=n>accept</span><span class=p>(</span><span class=n>sk1</span><span class=p>,</span> <span class=n>flags</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>err</span><span class=p>,</span> <span class=n>kern</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>sk2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>goto</span> <span class=n>do_err</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>lock_sock</span><span class=p>(</span><span class=n>sk2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>sock_rps_record_flow</span><span class=p>(</span><span class=n>sk2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>WARN_ON</span><span class=p>(</span><span class=o>!</span><span class=p>((</span><span class=mi>1</span> <span class=o>&lt;&lt;</span> <span class=n>sk2</span><span class=o>-&gt;</span><span class=n>sk_state</span><span class=p>)</span> <span class=o>&amp;</span>
</span></span><span class=line><span class=cl>		  <span class=p>(</span><span class=n>TCPF_ESTABLISHED</span> <span class=o>|</span> <span class=n>TCPF_SYN_RECV</span> <span class=o>|</span>
</span></span><span class=line><span class=cl>		  <span class=n>TCPF_CLOSE_WAIT</span> <span class=o>|</span> <span class=n>TCPF_CLOSE</span><span class=p>)));</span>
</span></span><span class=line><span class=cl>	<span class=n>sock_graft</span><span class=p>(</span><span class=n>sk2</span><span class=p>,</span> <span class=n>newsock</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>newsock</span><span class=o>-&gt;</span><span class=n>state</span> <span class=o>=</span> <span class=n>SS_CONNECTED</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>err</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>release_sock</span><span class=p>(</span><span class=n>sk2</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nl>do_err</span><span class=p>:</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>err</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=小结-3>小结</h3><p><code>accept</code>会创建一个新的<code>sock</code>和<code>struct file</code>, 并且让两个关联起来. 尽管没有继续追踪下去, 但是也可以知道, <code>accept</code>返回的与之连接的<code>sock</code>就是这里创建的<code>sock</code>. 这里我甚至猜想会涉及到一些信号函数, 继续往下看.</p><h2 id=connect>connect</h2><p><code>connect</code>调用的是<code>__sys_connect</code>.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=n>SYSCALL_DEFINE3</span><span class=p>(</span><span class=n>connect</span><span class=p>,</span> <span class=kt>int</span><span class=p>,</span> <span class=n>fd</span><span class=p>,</span> <span class=k>struct</span> <span class=n>sockaddr</span> <span class=n>__user</span> <span class=o>*</span><span class=p>,</span> <span class=n>uservaddr</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=kt>int</span><span class=p>,</span> <span class=n>addrlen</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>__sys_connect</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=n>uservaddr</span><span class=p>,</span> <span class=n>addrlen</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>__sys_connect基本可以分为三步:</p><ol><li>通过fd拿到<code>sock</code></li><li>将用户参数用用户空间复制到内核空间</li><li>调用<code>connect</code></li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=kt>int</span> <span class=nf>__sys_connect</span><span class=p>(</span><span class=kt>int</span> <span class=n>fd</span><span class=p>,</span> <span class=k>struct</span> <span class=n>sockaddr</span> <span class=n>__user</span> <span class=o>*</span><span class=n>uservaddr</span><span class=p>,</span> <span class=kt>int</span> <span class=n>addrlen</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>socket</span> <span class=o>*</span><span class=n>sock</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>sockaddr_storage</span> <span class=n>address</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>err</span><span class=p>,</span> <span class=n>fput_needed</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>sock</span> <span class=o>=</span> <span class=n>sockfd_lookup_light</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>err</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>fput_needed</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>sock</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>goto</span> <span class=n>out</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>err</span> <span class=o>=</span> <span class=n>move_addr_to_kernel</span><span class=p>(</span><span class=n>uservaddr</span><span class=p>,</span> <span class=n>addrlen</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>address</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>err</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>goto</span> <span class=n>out_put</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>err</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>	    <span class=n>security_socket_connect</span><span class=p>(</span><span class=n>sock</span><span class=p>,</span> <span class=p>(</span><span class=k>struct</span> <span class=n>sockaddr</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>address</span><span class=p>,</span> <span class=n>addrlen</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>goto</span> <span class=n>out_put</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>err</span> <span class=o>=</span> <span class=n>sock</span><span class=o>-&gt;</span><span class=n>ops</span><span class=o>-&gt;</span><span class=n>connect</span><span class=p>(</span><span class=n>sock</span><span class=p>,</span> <span class=p>(</span><span class=k>struct</span> <span class=n>sockaddr</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>address</span><span class=p>,</span> <span class=n>addrlen</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				 <span class=n>sock</span><span class=o>-&gt;</span><span class=n>file</span><span class=o>-&gt;</span><span class=n>f_flags</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nl>out_put</span><span class=p>:</span>
</span></span><span class=line><span class=cl>	<span class=n>fput_light</span><span class=p>(</span><span class=n>sock</span><span class=o>-&gt;</span><span class=n>file</span><span class=p>,</span> <span class=n>fput_needed</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nl>out</span><span class=p>:</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>err</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=inet_stream_connect>inet_stream_connect</h3><p><code>connect</code>会调用到<code>inet_stream_connect</code>最终到<code>__inet_stream_connect</code>.</p><p>不同的协议簇有不同的<code>connect</code>实现, 这里是公共调用部分, 大概分为以下几步:</p><ol><li>预连接, 不同协议簇有不同实现</li><li>等待连接</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=kt>int</span> <span class=nf>__inet_stream_connect</span><span class=p>(</span><span class=k>struct</span> <span class=n>socket</span> <span class=o>*</span><span class=n>sock</span><span class=p>,</span> <span class=k>struct</span> <span class=n>sockaddr</span> <span class=o>*</span><span class=n>uaddr</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			  <span class=kt>int</span> <span class=n>addr_len</span><span class=p>,</span> <span class=kt>int</span> <span class=n>flags</span><span class=p>,</span> <span class=kt>int</span> <span class=n>is_sendmsg</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>sock</span> <span class=o>*</span><span class=n>sk</span> <span class=o>=</span> <span class=n>sock</span><span class=o>-&gt;</span><span class=n>sk</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=c1>// ......
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=k>switch</span> <span class=p>(</span><span class=n>sock</span><span class=o>-&gt;</span><span class=n>state</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// ......
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=nl>SS_UNCONNECTED</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=n>err</span> <span class=o>=</span> <span class=o>-</span><span class=n>EISCONN</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=n>sk</span><span class=o>-&gt;</span><span class=n>sk_state</span> <span class=o>!=</span> <span class=n>TCP_CLOSE</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>goto</span> <span class=n>out</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=n>BPF_CGROUP_PRE_CONNECT_ENABLED</span><span class=p>(</span><span class=n>sk</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=n>err</span> <span class=o>=</span> <span class=n>sk</span><span class=o>-&gt;</span><span class=n>sk_prot</span><span class=o>-&gt;</span><span class=n>pre_connect</span><span class=p>(</span><span class=n>sk</span><span class=p>,</span> <span class=n>uaddr</span><span class=p>,</span> <span class=n>addr_len</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>(</span><span class=n>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=k>goto</span> <span class=n>out</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=n>err</span> <span class=o>=</span> <span class=n>sk</span><span class=o>-&gt;</span><span class=n>sk_prot</span><span class=o>-&gt;</span><span class=n>connect</span><span class=p>(</span><span class=n>sk</span><span class=p>,</span> <span class=n>uaddr</span><span class=p>,</span> <span class=n>addr_len</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=n>err</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>goto</span> <span class=n>out</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=n>sock</span><span class=o>-&gt;</span><span class=n>state</span> <span class=o>=</span> <span class=n>SS_CONNECTING</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=c1>// ......
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=n>timeo</span> <span class=o>=</span> <span class=n>sock_sndtimeo</span><span class=p>(</span><span class=n>sk</span><span class=p>,</span> <span class=n>flags</span> <span class=o>&amp;</span> <span class=n>O_NONBLOCK</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>((</span><span class=mi>1</span> <span class=o>&lt;&lt;</span> <span class=n>sk</span><span class=o>-&gt;</span><span class=n>sk_state</span><span class=p>)</span> <span class=o>&amp;</span> <span class=p>(</span><span class=n>TCPF_SYN_SENT</span> <span class=o>|</span> <span class=n>TCPF_SYN_RECV</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=kt>int</span> <span class=n>writebias</span> <span class=o>=</span> <span class=p>(</span><span class=n>sk</span><span class=o>-&gt;</span><span class=n>sk_protocol</span> <span class=o>==</span> <span class=n>IPPROTO_TCP</span><span class=p>)</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>				<span class=n>tcp_sk</span><span class=p>(</span><span class=n>sk</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>fastopen_req</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>				<span class=n>tcp_sk</span><span class=p>(</span><span class=n>sk</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>fastopen_req</span><span class=o>-&gt;</span><span class=n>data</span> <span class=o>?</span> <span class=mi>1</span> <span class=o>:</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=cm>/* Error code is set above */</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>timeo</span> <span class=o>||</span> <span class=o>!</span><span class=n>inet_wait_for_connect</span><span class=p>(</span><span class=n>sk</span><span class=p>,</span> <span class=n>timeo</span><span class=p>,</span> <span class=n>writebias</span><span class=p>))</span>
</span></span><span class=line><span class=cl>			<span class=k>goto</span> <span class=n>out</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=n>err</span> <span class=o>=</span> <span class=n>sock_intr_errno</span><span class=p>(</span><span class=n>timeo</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=n>signal_pending</span><span class=p>(</span><span class=n>current</span><span class=p>))</span>
</span></span><span class=line><span class=cl>			<span class=k>goto</span> <span class=n>out</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/* Connection was closed by RST, timeout, ICMP error
</span></span></span><span class=line><span class=cl><span class=cm>	 * or another process disconnected us.
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>sk</span><span class=o>-&gt;</span><span class=n>sk_state</span> <span class=o>==</span> <span class=n>TCP_CLOSE</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>goto</span> <span class=n>sock_error</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=c1>// ......
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=小结-4>小结</h3><p><code>connect</code>和<code>bind</code>有点像, 在demo部分我们也可以看到, <code>conncet</code>和<code>bind</code>是在相同的顺序下调用, 即创建<code>socket</code>之后调用. 但是<code>connect</code>是用来连接服务端, 也会将用户参数从用户空间复制到内核空间, 然后根据不同的协议簇调用不同的连接参数. 通过函数名<code>inet_wait_for_connect</code>, 也大概可以知道, <code>connect</code>是阻塞的, 直到连接成功. 此外, <code>connect</code>中可以看到几处<code>signal_pending</code>调用, 猜测是因为<code>connect</code>是阻塞的以及<code>timeout</code>的存在, 所以可能需要临时处理一些信号函数.</p><h2 id=总结>总结</h2><p>这篇文章的内容比较浅, 主要目的还是补齐进程通信的最后一个方法, socket通信.</p><p>不过总归是有收获的. 对于我这种非科班人员, 是第一次接触socket编程, 通过学习和撰写这篇文章, 大概可以了解socket编程的大概方式:</p><ol><li>服务端需要绑定和监听</li><li>客户端则需要连接服务端</li></ol><p>通过尽量的接触源码, 一是习惯了这种学习方式, 虽然源码挖的不是很深, 但是基本会养成看源码的习惯. 二是看这些源码, 也学习到了linux编程的一些思路, 比如操作表. 三是养成举证的习惯, 下的一些结论尽量在代码里找到证据, 当然有一些结论基本也可以通过已知条件推断出来.</p><p>本文以及进程通信系列的文章还遗留了很多TODO, 这些都还是需要我去了解的, 但是优先级不是很高. 最近的目的还是先了解全貌, 再去看看一些细节.</p></div><div class=post-footer id=post-footer><div class=orlike-box></div><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2021-06-07</span></div><div class=post-info-license><span><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></div><div class=post-info-more><section><i class="fas fa-fw fa-th"></i>&nbsp;<a href=/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/>操作系统</a></section><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/%E8%BF%9B%E7%A8%8B/>进程</a>,&nbsp;<a href=/tags/%E8%BF%9B%E7%A8%8B%E9%80%9A%E4%BF%A1/>进程通信</a>,&nbsp;<a href=/tags/socket/>socket</a>,&nbsp;<a href=/tags/linux/>Linux</a></section></div><div class=post-nav><a href=/202106/fopen-deep/ class=prev rel=prev title=glibc-fopen源码阅读><i class="fas fa-angle-left fa-fw"></i>glibc-fopen源码阅读</a>
<a href=/202106/algo-encrypter-rc4/ class=next rel=next title=RC4加密算法>RC4加密算法<i class="fas fa-angle-right fa-fw"></i></a></div></div><div id=my-random-posts><div class=loadingThree><span></span>
<span></span>
<span></span>
<span></span>
<span></span></div></div><div id=comments><div id=giscus class=comment></div><script src=https://giscus.app/client.js data-repo=caibingcheng/comment data-repo-id=R_kgDOHgda4w data-category=Announcements data-category-id=DIC_kwDOHgda484CTfDe data-mapping=og:title data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=/css/giscus.css data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script><noscript>Please enable JavaScript to view the comments powered by <a href=https://giscus.app/>giscus</a>.</noscript></div></article></div></main><footer class=footer><hr style=opacity:.2><div class=footer-container><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2020 - 2024</span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span><span class=icp-splitter>&nbsp;|&nbsp;</span><br class=icp-br><span class=icp><a href="https://icp.gov.moe/?keyword=20222231" target=_blank>萌ICP备20222231号</a></span></div><div class=footer-line><a href=https://wiki.imcbc.cn target=_blank rel=noopener title="Bing's Wiki">Wiki</a>
&nbsp;|&nbsp;
<a href=https://rssblog.cn target=_blank rel=noopener title=RSSBlog>RSSBlog</a>
&nbsp;|&nbsp;
<a href=https://travellings.link target=_blank rel=noopener title=开往-友链接力>开往-友链接力</a>
&nbsp;|&nbsp;
<a href=https://www.foreverblog.cn/go.html target=_blank>穿梭虫洞</a></div><div class=footer-line><script>var build_date="2024-03-05T21:35:51+08:00"</script>已运行
<span id=run-time></span>
&nbsp;|&nbsp;
构建于
<span id=build-time></span>&nbsp;前</div><div class=footer-line><script async src=https://npm.elemecdn.com/penndu@1.0.0/bsz.js></script>
共计
<span id=busuanzi_value_site_uv></span>&nbsp;访客
&nbsp;|&nbsp;
<span id=busuanzi_value_site_pv></span>&nbsp;访问
&nbsp;|&nbsp;
256K&nbsp;字</div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw"></i>
</a><a id=reader-button class=fixed-button title=阅读模式><i class="fa fa-book fa-fw"></i></a></div><link rel=stylesheet href=https://fastly.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/css/lightgallery.min.css><link rel=stylesheet href=https://fastly.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css><link rel=stylesheet href=https://fastly.jsdelivr.net/npm/katex@0.11.1/dist/contrib/copy-tex.min.css><script type=text/javascript src=https://cdn.staticfile.org/jquery/3.6.0/jquery.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/npm/autocomplete.js@0.37.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/npm/algoliasearch@4.2.0/dist/algoliasearch-lite.umd.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/js/lightgallery.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/npm/lg-thumbnail.js@1.2.0/dist/lg-thumbnail.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/npm/lg-zoom.js@1.2.0/dist/lg-zoom.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/npm/katex@0.11.1/dist/contrib/copy-tex.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/npm/katex@0.11.1/dist/contrib/mhchem.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/gh/Albejr/jquery-albe-timeline/jquery-albe-timeline.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/gh/caibingcheng/orlike@client/orlike.min.js></script><script type=text/javascript src=/js/custom.js></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:50},comment:{},lightGallery:{actualSize:!1,exThumbImage:"data-thumbnail",hideBarsDelay:2e3,selector:".lightgallery",speed:400,thumbContHeight:80,thumbWidth:80,thumbnail:!0},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{algoliaAppID:"JMTHQS1VUU",algoliaIndex:"blog-bbing",algoliaSearchKey:"0dd43732743475449c844c0d0f21366a",highlightTag:"em",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:50,type:"algolia"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>