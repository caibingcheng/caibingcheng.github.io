<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>C,C++安全指南 - Bing's Blog</title><meta name=keywords content="[Life bbing bing hugo Blog C++ LoveIt]"><meta name=Description content="个人技术博客"><meta property="og:title" content="C,C++安全指南"><meta property="og:description" content="目录 1 通用安全指南 I. C/C++使用错误 1.1 不得直接使用无长度限制的字符拷贝函数 1.2 创建进程类的函数的安全规范 1.3 尽量减少使用 _alloca 和可变长度数组 1.4 pr"><meta property="og:type" content="article"><meta property="og:url" content="https://imcbc.cn/202108/secguide_c_tc/"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/caibingcheng/resources@main/images/13bOkrO.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-08-19T19:47:04+08:00"><meta property="article:modified_time" content="2021-08-19T19:47:10+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://cdn.jsdelivr.net/gh/caibingcheng/resources@main/images/13bOkrO.png"><meta name=twitter:title content="C,C++安全指南"><meta name=twitter:description content="目录 1 通用安全指南 I. C/C++使用错误 1.1 不得直接使用无长度限制的字符拷贝函数 1.2 创建进程类的函数的安全规范 1.3 尽量减少使用 _alloca 和可变长度数组 1.4 pr"><meta name=application-name content="Bing's Blog"><meta name=apple-mobile-web-app-title content="Bing's Blog"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://imcbc.cn/202108/secguide_c_tc/><link rel=prev href=https://imcbc.cn/202108/sicp-python-read1/><link rel=next href=https://imcbc.cn/202108/sicp-python-read2/><link rel=stylesheet href=https://fastly.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=https://fastly.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.0/css/all.min.css><link rel=stylesheet href=https://fastly.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css><link rel=stylesheet href=https://fastly.jsdelivr.net/gh/Albejr/jquery-albe-timeline/templates/simple/style-albe-timeline.css><link rel=stylesheet href=https://fastly.jsdelivr.net/gh/caibingcheng/orlike@client/orlike.min.css><link rel=stylesheet href=/css/custom.css><meta name=google-site-verification content="xy1bCgQPV_H3_o2XD34o2mIByQxmzkV3GPOfhXg_mTM"><meta name=msvalidate.01 content="c81a65b6344571786df543a56c7bbe18"><meta name=baidu-site-verification content="code-WcyzWjgFYo"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"C,C++安全指南","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/imcbc.cn\/202108\/secguide_c_tc\/"},"image":["https:\/\/imcbc.cn\/android-chrome-192x192.png"],"genre":"posts","keywords":"Cpp, C","wordcount":13429,"url":"https:\/\/imcbc.cn\/202108\/secguide_c_tc\/","datePublished":"2021-08-19T19:47:04+08:00","dateModified":"2021-08-19T19:47:10+08:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"Bing","logo":"https:\/\/imcbc.cn\/android-chrome-192x192.png"},"author":{"@type":"Person","name":"Tencent"},"description":""}</script></head><body header-desktop=normal header-mobile=normal><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><a href=https://github.com/caibingcheng/ class=github-corner aria-label="View source on GitHub"><svg width="3.5rem" height="3.5rem" viewBox="0 0 250 250" style="fill:#151513;color:#fff;position:absolute;top:0;border:0;left:0;transform:scale(-1,1)" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><div class=header-title><a href=/ title="Bing's Blog">Bing's Blog</a></div><div class=menu><div class=menu-inner><div class=dropdown><a href=/posts/ class="menu-item menu-more dropbtn" title><i class='fas fa fa-archive'></i> 归档</a><div class="menu-more-content dropdown-content"><a href=/tags/ title><i class='fas fa fa-tag'></i> 标签 </a><a href=/categories/ title><i class='fas fa fa-th'></i> 分类</a></div></div><a class=menu-item href=/friends/><i class='fas fa fa-users'></i> 友链</a><div class=dropdown><a href=javascript:void(0); class="menu-item menu-more dropbtn" title><i class='fas fa fa-angle-double-down'></i> 更多</a><div class="menu-more-content dropdown-content"><a href=/tools/ title><i class='fas fa fa-cubes'></i> 工具 </a><a href=/about/ title><i class='fas fa fa-address-card'></i> 关于 </a><a href=/timeline/ title><i class='fas fa fa-building'></i> 建站 </a><a href=/index.xml/ title><i class='fas fa fa-rss'></i> RSS</a></div></div><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=搜索文章内容 id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin"></i></span>
</span><a href=https://travellings.link target=_blank class=menu-item rel=noopener title=开往-友链接力><i class='fas fa-fw fa-subway'></i></a>
<a href=https://rssblog.cn/bbing class=menu-item target=_blank rel=noopener title=RSSBlog><i class='fas fa-fw fa-inbox'></i></a>
<a href=https://www.foreverblog.cn/go.html class=menu-item target=_blank rel=noopener title=穿梭虫洞><i class="fas fa-fw fa-life-ring" title=穿梭虫洞-随机访问十年之约友链博客></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Bing's Blog">Bing's Blog</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章内容 id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></div><a href=/posts/ class=menu-item title><i class='fas fa fa-archive'></i> 归档</a>
<a href=/tags/ class=menu-item title><i class='fas fa fa-tag'></i> 标签</a>
<a href=/categories/ class=menu-item title><i class='fas fa fa-th'></i> 分类</a>
<a class=menu-item href=/friends/><i class='fas fa fa-users'></i> 友链</a>
<a href=/tools/ class=menu-item title><i class='fas fa fa-cubes'></i> 工具</a>
<a href=/about/ class=menu-item title><i class='fas fa fa-address-card'></i> 关于</a>
<a href=/timeline/ class=menu-item title><i class='fas fa fa-building'></i> 建站</a>
<a href=/index.xml/ class=menu-item title><i class='fas fa fa-rss'></i> RSS</a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class=single-title>[转载]C,C++安全指南<sup>
<a id=reader-button-title title=阅读模式><i class="fa fa-book fa-fw"></i></a></sup></h1><div class=post-meta><div class=post-meta-line></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2021-08-19>2021-08-19</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 13429 字&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 27 分钟&nbsp;</div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#通用安全指南>通用安全指南</a><ul><li><a href=#1-cc使用错误>1 C/C++使用错误</a><ul><li><a href=#11--必须不得直接使用无长度限制的字符拷贝函数>1.1 【必须】不得直接使用无长度限制的字符拷贝函数</a></li><li><a href=#12--必须创建进程类的函数的安全规范>1.2 【必须】创建进程类的函数的安全规范</a></li><li><a href=#13--必须尽量减少使用-_alloca-和可变长度数组>1.3 【必须】尽量减少使用 _alloca 和可变长度数组</a></li><li><a href=#14--必须printf系列参数必须对应>1.4 【必须】printf系列参数必须对应</a></li><li><a href=#15--必须防止泄露指针包括p的值>1.5 【必须】防止泄露指针（包括%p）的值</a></li><li><a href=#16--必须不应当把用户可修改的字符串作为printf系列函数的format参数>1.6 【必须】不应当把用户可修改的字符串作为printf系列函数的“format”参数</a></li><li><a href=#17-必须对数组delete时需要使用delete>1.7 【必须】对数组delete时需要使用delete[]</a></li><li><a href=#18必须注意隐式符号转换>1.8【必须】注意隐式符号转换</a></li><li><a href=#19必须注意八进制问题>1.9【必须】注意八进制问题</a></li></ul></li><li><a href=#2-不推荐的编程习惯>2 不推荐的编程习惯</a><ul><li><a href=#21-必须switch中应有default>2.1 【必须】switch中应有default</a></li><li><a href=#22-必须不应当在debug或错误信息中提供过多内容>2.2 【必须】不应当在Debug或错误信息中提供过多内容</a></li><li><a href=#23-必须不应该在客户端代码中硬编码对称加密秘钥>2.3 【必须】不应该在客户端代码中硬编码对称加密秘钥</a></li><li><a href=#24-必须返回栈上变量的地址>2.4 【必须】返回栈上变量的地址</a></li><li><a href=#25-必须有逻辑联系的数组必须仔细检查>2.5 【必须】有逻辑联系的数组必须仔细检查</a></li><li><a href=#26-必须避免函数的声明和实现不同>2.6 【必须】避免函数的声明和实现不同</a></li><li><a href=#27-必须检查复制粘贴的重复代码相同代码通常代表错误>2.7 【必须】检查复制粘贴的重复代码（相同代码通常代表错误）</a></li><li><a href=#28--必须左右一致的重复判断永远为真或假的判断通常代表错误>2.8 【必须】左右一致的重复判断/永远为真或假的判断（通常代表错误）</a></li><li><a href=#29-必须函数每个分支都应有返回值>2.9 【必须】函数每个分支都应有返回值</a></li><li><a href=#210-必须不得使用栈上未初始化的变量>2.10 【必须】不得使用栈上未初始化的变量</a></li><li><a href=#211--建议不得直接使用刚分配的未初始化的内存如realloc>2.11 【建议】不得直接使用刚分配的未初始化的内存（如realloc）</a></li><li><a href=#212-必须校验内存相关函数的返回值>2.12 【必须】校验内存相关函数的返回值</a></li><li><a href=#213-必须不要在if里面赋值>2.13 【必须】不要在if里面赋值</a></li><li><a href=#214-建议确认if里面的按位操作>2.14 【建议】确认if里面的按位操作</a></li></ul></li><li><a href=#3----多线程>3 多线程</a><ul><li><a href=#31--必须变量应确保线程安全性>3.1 【必须】变量应确保线程安全性</a></li><li><a href=#32-必须注意signal-handler导致的条件竞争>3.2 【必须】注意signal handler导致的条件竞争</a></li><li><a href=#33-建议注意time-of-check-time-of-use-toctou-条件竞争>3.3 【建议】注意Time-of-check Time-of-use (TOCTOU) 条件竞争</a></li></ul></li><li><a href=#4----加密解密>4 加密解密</a><ul><li><a href=#41--必须不得明文存储用户密码等敏感数据>4.1 【必须】不得明文存储用户密码等敏感数据</a></li><li><a href=#42--必须内存中的用户密码等敏感数据应该安全抹除>4.2 【必须】内存中的用户密码等敏感数据应该安全抹除</a></li><li><a href=#43--必须rand-类函数应正确初始化>4.3 【必须】rand() 类函数应正确初始化</a></li><li><a href=#44--必须在需要高强度安全加密时不应使用弱prng函数>4.4 【必须】在需要高强度安全加密时不应使用弱PRNG函数</a></li><li><a href=#45--必须自己实现的rand范围不应过小>4.5 【必须】自己实现的rand范围不应过小</a></li></ul></li><li><a href=#5----文件操作>5 文件操作</a><ul><li><a href=#51--必须避免路径穿越问题>5.1 【必须】避免路径穿越问题</a></li><li><a href=#52--必须避免相对路径导致的安全问题dllexe劫持等问题>5.2 【必须】避免相对路径导致的安全问题（DLL、EXE劫持等问题）</a></li><li><a href=#53--必须文件权限控制>5.3 【必须】文件权限控制</a></li></ul></li><li><a href=#6-内存操作>6 内存操作</a><ul><li><a href=#61-必须防止各种越界写向前向后>6.1 【必须】防止各种越界写（向前/向后）</a></li><li><a href=#62-必须防止任意地址写>6.2 【必须】防止任意地址写</a></li></ul></li><li><a href=#7-数字操作>7 数字操作</a><ul><li><a href=#71-必须防止整数溢出>7.1 【必须】防止整数溢出</a></li><li><a href=#72-必须防止off-by-one>7.2 【必须】防止Off-By-One</a></li><li><a href=#73-必须避免大小端错误>7.3 【必须】避免大小端错误</a></li><li><a href=#74-必须检查除以零异常>7.4 【必须】检查除以零异常</a></li><li><a href=#75-必须防止数字类型的错误强转>7.5 【必须】防止数字类型的错误强转</a></li><li><a href=#76-必须比较数据大小时加上最小最大值的校验>7.6 【必须】比较数据大小时加上最小/最大值的校验</a></li></ul></li><li><a href=#8----指针操作>8 指针操作</a><ul><li><a href=#81-建议检查在pointer上使用sizeof>8.1 【建议】检查在pointer上使用sizeof</a></li><li><a href=#82-必须检查直接将数组和0比较的代码>8.2 【必须】检查直接将数组和0比较的代码</a></li><li><a href=#83-必须不应当向指针赋予写死的地址>8.3 【必须】不应当向指针赋予写死的地址</a></li><li><a href=#84-必须检查空指针>8.4 【必须】检查空指针</a></li><li><a href=#85-必须释放完后置空指针>8.5 【必须】释放完后置空指针</a></li><li><a href=#86-必须防止错误的类型转换type-confusion>8.6 【必须】防止错误的类型转换（type confusion）</a></li><li><a href=#87-必须智能指针使用安全>8.7 【必须】智能指针使用安全</a></li></ul></li></ul></li></ul></nav></div></div><div class=content id=content><details markdown=1><summary>目录</summary><ul><li><a href=#1 rel>1 通用安全指南</a><ul><li><a href=#1.1 rel>I. C/C++使用错误</a><ul><li><a href=#1.1.1 rel>1.1 不得直接使用无长度限制的字符拷贝函数</a></li><li><a href=#1.1.2 rel>1.2 创建进程类的函数的安全规范</a></li><li><a href=#1.1.3 rel>1.3 尽量减少使用 _alloca 和可变长度数组</a></li><li><a href=#1.1.4 rel>1.4 printf系列参数必须对应</a></li><li><a href=#1.1.5 rel>1.5 防止泄露指针（包括%p）的值</a></li><li><a href=#1.1.6 rel>1.6 不应当把用户可修改的字符串作为printf系列函数的“format”参数</a></li><li><a href=#1.1.7 rel>1.7 对数组delete时需要使用delete[]</a></li><li><a href=#1.1.8 rel>1.8 注意隐式符号转换</a></li><li><a href=#1.1.9 rel>1.9 注意八进制问题</a></li></ul></li><li><a href=#1.2 rel>II. 不推荐的编程习惯</a><ul><li><a href=#1.2.1 rel>2.1 switch中应有default</a></li><li><a href=#1.2.2 rel>2.2 不应当在Debug或错误信息中提供过多内容</a></li><li><a href=#1.2.3 rel>2.3 不应该在客户端代码中硬编码对称加密秘钥</a></li><li><a href=#1.2.4 rel>2.4 返回栈上变量的地址</a></li><li><a href=#1.2.5 rel>2.5 有逻辑联系的数组必须仔细检查</a></li><li><a href=#1.2.6 rel>2.6 避免函数的声明和实现不同</a></li><li><a href=#1.2.7 rel>2.7 检查复制粘贴的重复代码</a></li><li><a href=#1.2.8 rel>2.8 左右一致的重复判断/永远为真或假的判断</a></li><li><a href=#1.2.9 rel>2.9 函数每个分支都应有返回值</a></li><li><a href=#1.2.10 rel>2.10 不得使用栈上未初始化的变量</a></li><li><a href=#1.2.11 rel>2.11 不得直接使用刚分配的未初始化的内存（如realloc）</a></li><li><a href=#1.2.12 rel>2.12 校验内存相关函数的返回值</a></li><li><a href=#1.2.13 rel>2.13 不要在if里面赋值</a></li><li><a href=#1.2.14 rel>2.14 确认if里面的按位操作</a></li></ul></li><li><a href=#1.3 rel>III. 多线程</a><ul><li><a href=#1.3.1 rel>3.1 变量应确保线程安全性</a></li><li><a href=#1.3.2 rel>3.2 注意signal handler导致的条件竞争</a></li><li><a href=#1.3.3 rel>3.3 注意Time-of-check Time-of-use条件竞争</a></li></ul></li><li><a href=#1.4 rel>IV. 加密解密</a><ul><li><a href=#1.4.1 rel>4.1 不得明文存储用户密码等敏感数据</a></li><li><a href=#1.4.2 rel>4.2 内存中的用户密码等敏感数据应该安全抹除</a></li><li><a href=#1.4.3 rel>4.3 rand() 类函数应正确初始化</a></li><li><a href=#1.4.4 rel>4.4 在需要高强度安全加密时不应使用弱PRNG函数</a></li><li><a href=#1.4.5 rel>4.5 自己实现的rand范围不应过小</a></li></ul></li><li><a href=#1.5 rel>V. 文件操作</a><ul><li><a href=#1.5.1 rel>5.1 避免路径穿越问题</a></li><li><a href=#1.5.2 rel>5.2 避免相对路径导致的安全问题</a></li><li><a href=#1.5.3 rel>5.3 文件权限控制</a></li></ul></li><li><a href=#1.6 rel>Ⅵ. 内存操作</a><ul><li><a href=#1.6.1 rel>6.1 防止各种越界写</a></li><li><a href=#1.6.2 rel>6.2 防止任意地址写</a></li></ul></li><li><a href=#1.7 rel>Ⅶ. 数字操作</a><ul><li><a href=#1.7.1 rel>7.1 防止整数溢出</a></li><li><a href=#1.7.2 rel>7.2 防止Off-By-One</a></li><li><a href=#1.7.3 rel>7.3 避免大小端错误</a></li><li><a href=#1.7.4 rel>7.4 检查除以零异常</a></li><li><a href=#1.7.5 rel>7.5 防止数字类型的错误强转</a></li><li><a href=#1.7.6 rel>7.6 比较数据大小时加上最小/最大值的校验</a></li></ul></li><li><a href=#1.8 rel>Ⅷ. 指针操作</a><ul><li><a href=#1.8.1 rel>8.1 检查在pointer上使用sizeof</a></li><li><a href=#1.8.2 rel>8.2 检查直接将数组和0比较的代码</a></li><li><a href=#1.8.3 rel>8.3 不应当向指针赋予写死的地址</a></li><li><a href=#1.8.4 rel>8.4 检查空指针</a></li><li><a href=#1.8.5 rel>8.5 释放完后置空指针</a></li><li><a href=#1.8.6 rel>8.6 防止错误的类型转换</a></li><li><a href=#1.8.7 rel>8.7 智能指针使用安全</a></li></ul></li></ul></li></ul></details><p><a id=1></a></p><h2 id=通用安全指南>通用安全指南</h2><p><a id=1.1></a></p><h3 id=1-cc使用错误>1 C/C++使用错误</h3><p><a id=1.1.1></a></p><h4 id=11--必须不得直接使用无长度限制的字符拷贝函数>1.1 【必须】不得直接使用无长度限制的字符拷贝函数</h4><p>不应直接使用legacy的字符串拷贝、输入函数，如strcpy、strcat、sprintf、wcscpy、mbscpy等，这些函数的特征是：可以输出一长串字符串，而不限制长度。如果环境允许，应当使用其_s安全版本替代，或者使用n版本函数（如：snprintf，vsnprintf）。</p><p>若使用形如sscanf之类的函数时，在处理字符串输入时应当通过%10s这样的方式来严格限制字符串长度，同时确保字符串末尾有\0。如果环境允许，应当使用_s安全版本。</p><p>但是注意，虽然MSVC 2015时默认引入结尾为0版本的<code>snprintf</code>（行为等同于C99定义的<code>snprintf</code>）。但更早期的版本中，MSVC的<code>snprintf</code>可能是<code>_snprintf</code>的宏。而<code>_snprintf</code>是不保证\0结尾的（见本节后半部分）。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=err>（</span><span class=n>MSVC</span><span class=err>）</span>
</span></span><span class=line><span class=cl><span class=n>Beginning</span> <span class=n>with</span> <span class=n>the</span> <span class=n>UCRT</span> <span class=n>in</span> <span class=n>Visual</span> <span class=n>Studio</span> <span class=mi>2015</span> <span class=n>and</span> <span class=n>Windows</span> <span class=mi>10</span><span class=p>,</span> <span class=n>snprintf</span> <span class=n>is</span> <span class=n>no</span> <span class=n>longer</span> <span class=n>identical</span> <span class=n>to</span> <span class=n>_snprintf</span><span class=p>.</span> <span class=n>The</span> <span class=n>snprintf</span> <span class=n>function</span> <span class=n>behavior</span> <span class=n>is</span> <span class=n>now</span> <span class=n>C99</span> <span class=n>standard</span> <span class=n>compliant</span><span class=p>.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>从</span><span class=n>Visual</span> <span class=n>Studio</span> <span class=mi>2015</span><span class=err>和</span><span class=n>Windows</span> <span class=mi>10</span><span class=err>中的</span><span class=n>UCRT开始</span><span class=err>，</span><span class=n>snprintf不再与_snprintf相同</span><span class=err>。</span><span class=n>snprintf函数行为现在符合C99标准</span><span class=err>。</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>请参考：</span><span class=nl>https</span><span class=p>:</span><span class=c1>//docs.microsoft.com/en-us/cpp/c-runtime-library/reference/snprintf-snprintf-snprintf-l-snwprintf-snwprintf-l?redirectedfrom=MSDN&amp;view=vs-2019
</span></span></span></code></pre></td></tr></table></div></div><p>因此，在使用n系列拷贝函数时，要确保正确计算缓冲区长度，同时，如果你不确定是否代码在各个编译器下都能确保末尾有0时，建议可以适当增加1字节输入缓冲区，并将其置为\0，以保证输出的字符串结尾一定有\0。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=c1>// Good
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>char</span> <span class=n>buf</span><span class=p>[</span><span class=mi>101</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span><span class=mi>0</span><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=n>snprintf</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>buf</span><span class=p>)</span> <span class=o>-</span> <span class=mi>1</span><span class=p>,</span> <span class=s>&#34;foobar ...&#34;</span><span class=p>,</span> <span class=p>...);</span>
</span></span></code></pre></td></tr></table></div></div><p>一些需要注意的函数，例如<code>strncpy</code>和<code>_snprintf</code>是不安全的。 <code>strncpy</code>不应当被视为<code>strcpy</code>的n系列函数，它只是恰巧与其他n系列函数名字很像而已。<code>strncpy</code>在复制时，如果复制的长度超过n，不会在结尾补\0。</p><p>同样，MSVC <code>_snprintf</code>系列函数在超过或等于n时也不会以0结尾。如果后续使用非0结尾的字符串，可能泄露相邻的内容或者导致程序崩溃。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=c1>// Bad
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>char</span> <span class=n>a</span><span class=p>[</span><span class=mi>4</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span><span class=mi>0</span><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=n>_snprintf</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=s>&#34;%s&#34;</span><span class=p>,</span> <span class=s>&#34;AAAA&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>foo</span> <span class=o>=</span> <span class=n>strlen</span><span class=p>(</span><span class=n>a</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>上述代码在MSVC中执行后， a[4] == &lsquo;A&rsquo;，因此字符串未以0结尾。a的内容是"AAAA"，调用<code>strlen(a)</code>则会越界访问。因此，正确的操作举例如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=c1>// Good
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>char</span> <span class=n>a</span><span class=p>[</span><span class=mi>4</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span><span class=mi>0</span><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=n>_snprintf</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>a</span><span class=p>),</span> <span class=s>&#34;%s&#34;</span><span class=p>,</span> <span class=s>&#34;AAAA&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>a</span><span class=p>[</span><span class=k>sizeof</span><span class=p>(</span><span class=n>a</span><span class=p>)</span> <span class=o>-</span> <span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=sc>&#39;\0&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>foo</span> <span class=o>=</span> <span class=n>strlen</span><span class=p>(</span><span class=n>a</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>在 C++ 中，强烈建议用 <code>string</code>、<code>vector</code> 等更高封装层次的基础组件代替原始指针和动态数组，对提高代码的可读性和安全性都有很大的帮助。</p><p>关联漏洞:</p><p><code>中风险-信息泄露</code></p><p><code>低风险-拒绝服务</code></p><p><code>高风险-缓冲区溢出</code></p><p><a id=1.1.2></a></p><h4 id=12--必须创建进程类的函数的安全规范>1.2 【必须】创建进程类的函数的安全规范</h4><p>system、WinExec、CreateProcess、ShellExecute等启动进程类的函数，需要严格检查其参数。</p><p>启动进程需要加上双引号，错误例子：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=c1>// Bad
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>WinExec</span><span class=p>(</span><span class=s>&#34;D:</span><span class=se>\\</span><span class=s>program files</span><span class=se>\\</span><span class=s>my folder</span><span class=se>\\</span><span class=s>foobar.exe&#34;</span><span class=p>,</span> <span class=n>SW_SHOW</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>当存在<code>D:\program files\my.exe</code>的时候，my.exe会被启动。而foobar.exe不会启动。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=c1>// Good
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>WinExec</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\&#34;</span><span class=s>D:</span><span class=se>\\</span><span class=s>program files</span><span class=se>\\</span><span class=s>my folder</span><span class=se>\\</span><span class=s>foobar.exe</span><span class=se>\&#34;</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>SW_SHOW</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>另外，如果启动时从用户输入、环境变量读取组合命令行时，还需要注意是否可能存在命令注入。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=c1>// Bad
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>std</span><span class=o>::</span><span class=n>string</span> <span class=n>cmdline</span> <span class=o>=</span> <span class=s>&#34;calc &#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>cmdline</span> <span class=o>+=</span> <span class=n>user_input</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>system</span><span class=p>(</span><span class=n>cmdline</span><span class=p>.</span><span class=n>c_str</span><span class=p>());</span>
</span></span></code></pre></td></tr></table></div></div><p>比如，当用户输入<code>1+1 && ls</code>时，执行的实际上是calc 1+1和ls 两个命令，导致命令注入。</p><p>需要检查用户输入是否含有非法数据。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=c1>// Good
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>std</span><span class=o>::</span><span class=n>string</span> <span class=n>cmdline</span> <span class=o>=</span> <span class=s>&#34;ls &#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>cmdline</span> <span class=o>+=</span> <span class=n>user_input</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span><span class=p>(</span><span class=n>cmdline</span><span class=p>.</span><span class=n>find_first_not_of</span><span class=p>(</span><span class=s>&#34;1234567890.+-*/e &#34;</span><span class=p>)</span> <span class=o>==</span> <span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>::</span><span class=n>npos</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=n>system</span><span class=p>(</span><span class=n>cmdline</span><span class=p>.</span><span class=n>c_str</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=k>else</span>
</span></span><span class=line><span class=cl>  <span class=nf>warning</span><span class=p>(...);</span>
</span></span></code></pre></td></tr></table></div></div><p>关联漏洞:</p><p><code>高风险-代码执行</code></p><p><code>高风险-权限提升</code></p><p><a id=1.1.3></a></p><h4 id=13--必须尽量减少使用-_alloca-和可变长度数组>1.3 【必须】尽量减少使用 _alloca 和可变长度数组</h4><p>_alloca 和<a href=https://zh.wikipedia.org/wiki/%E5%8F%AF%E5%8F%98%E9%95%BF%E6%95%B0%E7%BB%84 target=_blank rel="noopener noreffer">可变长度数组</a>使用的内存量在编译期间不可知。尤其是在循环中使用时，根据编译器的实现不同，可能会导致：（1）栈溢出，即拒绝服务； （2）缺少栈内存测试的编译器实现可能导致申请到非栈内存，并导致内存损坏。这在栈比较小的程序上，例如IoT设备固件上影响尤为大。对于 C++，可变长度数组也属于非标准扩展，在代码规范中禁止使用。</p><p>错误示例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=c1>// Bad
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>100000</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span><span class=o>*</span> <span class=n>foo</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=n>_alloca</span><span class=p>(</span><span class=mh>0x10000</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>..</span><span class=k>do</span> <span class=n>something</span> <span class=n>with</span> <span class=n>foo</span> <span class=p>..;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>Foo</span><span class=p>(</span><span class=kt>int</span> <span class=n>size</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=n>msg</span><span class=p>[</span><span class=n>size</span><span class=p>];</span> <span class=c1>// 不可控的栈溢出风险！
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>正确示例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=c1>// Good
</span></span></span><span class=line><span class=cl><span class=c1>// 改用动态分配的堆内存
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>100000</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=o>*</span> <span class=n>foo</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=n>malloc</span><span class=p>(</span><span class=mh>0x10000</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>..</span><span class=k>do</span> <span class=n>something</span> <span class=n>with</span> <span class=n>foo</span> <span class=p>..;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>foo_is_no_longer_needed</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>free</span><span class=p>(</span><span class=n>foo</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>foo</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>Foo</span><span class=p>(</span><span class=kt>int</span> <span class=n>size</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>std</span><span class=o>::</span><span class=n>string</span> <span class=n>msg</span><span class=p>(</span><span class=n>size</span><span class=p>,</span> <span class=sc>&#39;\0&#39;</span><span class=p>);</span>  <span class=c1>// C++
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>char</span><span class=o>*</span> <span class=n>msg</span> <span class=o>=</span> <span class=n>malloc</span><span class=p>(</span><span class=n>size</span><span class=p>);</span>  <span class=c1>// C
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>关联漏洞:</p><p><code>低风险-拒绝服务</code></p><p><code>高风险-内存破坏</code></p><p><a id=1.1.4></a></p><h4 id=14--必须printf系列参数必须对应>1.4 【必须】printf系列参数必须对应</h4><p>所有printf系列函数，如sprintf，snprintf，vprintf等必须对应控制符号和参数。</p><p>错误示例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=c1>// Bad
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>const</span> <span class=kt>int</span> <span class=n>buf_size</span> <span class=o>=</span> <span class=mi>1000</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>char</span> <span class=n>buffer_send_to_remote_client</span><span class=p>[</span><span class=n>buf_size</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span><span class=mi>0</span><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>snprintf</span><span class=p>(</span><span class=n>buffer_send_to_remote_client</span><span class=p>,</span> <span class=n>buf_size</span><span class=p>,</span> <span class=s>&#34;%d: %p&#34;</span><span class=p>,</span> <span class=n>id</span><span class=p>,</span> <span class=n>some_string</span><span class=p>);</span>  <span class=c1>// %p 应为 %s
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=n>buffer_send_to_remote_client</span><span class=p>[</span><span class=n>buf_size</span> <span class=o>-</span> <span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=sc>&#39;\0&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>send_to_remote</span><span class=p>(</span><span class=n>buffer_send_to_remote_client</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>正确示例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=c1>// Good
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>const</span> <span class=kt>int</span> <span class=n>buf_size</span> <span class=o>=</span> <span class=mi>1000</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>char</span> <span class=n>buffer_send_to_remote_client</span><span class=p>[</span><span class=n>buf_size</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span><span class=mi>0</span><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>snprintf</span><span class=p>(</span><span class=n>buffer_send_to_remote_client</span><span class=p>,</span> <span class=n>buf_size</span><span class=p>,</span> <span class=s>&#34;%d: %s&#34;</span><span class=p>,</span> <span class=n>id</span><span class=p>,</span> <span class=n>some_string</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>buffer_send_to_remote_client</span><span class=p>[</span><span class=n>buf_size</span> <span class=o>-</span> <span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=sc>&#39;\0&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>send_to_remote</span><span class=p>(</span><span class=n>buffer_send_to_remote_client</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>前者可能会让client的攻击者获取部分服务器的原始指针地址，可以用于破坏ASLR保护。</p><p>关联漏洞:</p><p><code>中风险-信息泄露</code></p><p><a id=1.1.5></a></p><h4 id=15--必须防止泄露指针包括p的值>1.5 【必须】防止泄露指针（包括%p）的值</h4><p>所有printf系列函数，要防止格式化完的字符串泄露程序布局信息。例如，如果将带有%p的字符串泄露给程序，则可能会破坏ASLR的防护效果。使得攻击者更容易攻破程序。</p><p>%p的值只应当在程序内使用，而不应当输出到外部或被外部以某种方式获取。</p><p>错误示例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=c1>// Bad
</span></span></span><span class=line><span class=cl><span class=c1>// 如果这是暴露给客户的一个API：
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>uint64_t</span> <span class=nf>GetUniqueObjectId</span><span class=p>(</span><span class=k>const</span> <span class=n>Foo</span><span class=o>*</span> <span class=n>pobject</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>(</span><span class=kt>uint64_t</span><span class=p>)</span><span class=n>pobject</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>正确示例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=c1>// Good
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>uint64_t</span> <span class=n>g_object_id</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=n>Foo</span><span class=o>::</span><span class=n>Foo</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>this</span><span class=o>-&gt;</span><span class=n>object_id_</span> <span class=o>=</span> <span class=n>g_object_id</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 如果这是暴露给客户的一个API：
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>uint64_t</span> <span class=nf>GetUniqueObjectId</span><span class=p>(</span><span class=k>const</span> <span class=n>Foo</span><span class=o>*</span> <span class=n>object</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>object</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>object</span><span class=o>-&gt;</span><span class=n>object_id_</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=n>error</span><span class=p>(...);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>关联漏洞:</p><p><code>中风险-信息泄露</code></p><p><a id=1.1.6></a></p><h4 id=16--必须不应当把用户可修改的字符串作为printf系列函数的format参数>1.6 【必须】不应当把用户可修改的字符串作为printf系列函数的“format”参数</h4><p>如果用户可以控制字符串，则通过 %n %p 等内容，最坏情况下可以直接执行任意恶意代码。</p><p>在以下情况尤其需要注意： WIFI名，设备名……</p><p>错误：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=n>snprintf</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>buf</span><span class=p>),</span> <span class=n>wifi_name</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>正确：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=n>snprinf</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>buf</span><span class=p>),</span> <span class=s>&#34;%s&#34;</span><span class=p>,</span> <span class=n>wifi_name</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>关联漏洞:</p><p><code>高风险-代码执行</code></p><p><code>高风险-内存破坏</code></p><p><code>中风险-信息泄露</code></p><p><code>低风险-拒绝服务</code></p><p><a id=1.1.7></a></p><h4 id=17-必须对数组delete时需要使用delete>1.7 【必须】对数组delete时需要使用delete[]</h4><p>delete []操作符用于删除数组。delete操作符用于删除非数组对象。它们分别调用operator delete[]和operator delete。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=c1>// Bad
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>Foo</span><span class=o>*</span> <span class=n>b</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Foo</span><span class=p>[</span><span class=mi>5</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=k>delete</span> <span class=n>b</span><span class=p>;</span>  <span class=c1>// trigger assert in DEBUG mode
</span></span></span></code></pre></td></tr></table></div></div><p>在new[]返回的指针上调用delete将是取决于编译器的未定义行为。代码中存在对未定义行为的依赖是错误的。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=c1>// Good
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>Foo</span><span class=o>*</span> <span class=n>b</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Foo</span><span class=p>[</span><span class=mi>5</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=k>delete</span><span class=p>[]</span> <span class=n>b</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>在 C++ 代码中，使用 <code>string</code>、<code>vector</code>、智能指针（比如<a href=https://zh.cppreference.com/w/cpp/memory/unique_ptr target=_blank rel="noopener noreffer">std::unique_ptr&lt;T[]></a>）等可以消除绝大多数 <code>delete[]</code> 的使用场景，并且代码更清晰。</p><p>关联漏洞:</p><p><code>高风险-内存破坏</code></p><p><code>中风险-逻辑漏洞</code></p><p><code>低风险-内存泄漏</code></p><p><code>低风险-拒绝服务</code></p><p><a id=1.1.8></a></p><h4 id=18必须注意隐式符号转换>1.8【必须】注意隐式符号转换</h4><p>两个无符号数相减为负数时，结果应当为一个很大的无符号数，但是小于int的无符号数在运算时可能会有预期外的隐式符号转换。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=c1>// 1
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>unsigned</span> <span class=kt>char</span> <span class=n>a</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>unsigned</span> <span class=kt>char</span> <span class=n>b</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=n>a</span> <span class=o>-</span> <span class=n>b</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>  <span class=c1>// a - b = -1 (signed int)
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>a</span> <span class=o>=</span> <span class=mi>6</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>else</span>
</span></span><span class=line><span class=cl>  <span class=n>a</span> <span class=o>=</span> <span class=mi>8</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 2
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>unsigned</span> <span class=kt>char</span> <span class=n>a</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>unsigned</span> <span class=kt>short</span> <span class=n>b</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=n>a</span> <span class=o>-</span> <span class=n>b</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>  <span class=c1>// a - b = -1 (signed int)
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>a</span> <span class=o>=</span> <span class=mi>6</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>else</span>
</span></span><span class=line><span class=cl>  <span class=n>a</span> <span class=o>=</span> <span class=mi>8</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>上述结果均为a=6</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=c1>// 3
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>a</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>unsigned</span> <span class=kt>short</span> <span class=n>b</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=n>a</span> <span class=o>-</span> <span class=n>b</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>  <span class=c1>// a - b = 0xffffffff (unsigned int)
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>a</span> <span class=o>=</span> <span class=mi>6</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>else</span>
</span></span><span class=line><span class=cl>  <span class=n>a</span> <span class=o>=</span> <span class=mi>8</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 4
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>a</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>b</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=n>a</span> <span class=o>-</span> <span class=n>b</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>  <span class=c1>// a - b = 0xffffffff (unsigned int)
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>a</span> <span class=o>=</span> <span class=mi>6</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>else</span>
</span></span><span class=line><span class=cl>  <span class=n>a</span> <span class=o>=</span> <span class=mi>8</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>上述结果均为a=8</p><p>如果预期为8，则错误代码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=c1>// Bad
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>unsigned</span> <span class=kt>short</span> <span class=n>a</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>unsigned</span> <span class=kt>short</span> <span class=n>b</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=n>a</span> <span class=o>-</span> <span class=n>b</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>  <span class=c1>// a - b = -1 (signed int)
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>a</span> <span class=o>=</span> <span class=mi>6</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>else</span>
</span></span><span class=line><span class=cl>  <span class=n>a</span> <span class=o>=</span> <span class=mi>8</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>正确代码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=c1>// Good
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>unsigned</span> <span class=kt>short</span> <span class=n>a</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>unsigned</span> <span class=kt>short</span> <span class=n>b</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>((</span><span class=kt>unsigned</span> <span class=kt>int</span><span class=p>)</span><span class=n>a</span> <span class=o>-</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>int</span><span class=p>)</span><span class=n>b</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>  <span class=c1>// a - b = 0xffff (unsigned short)
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>a</span> <span class=o>=</span> <span class=mi>6</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>else</span>
</span></span><span class=line><span class=cl>  <span class=n>a</span> <span class=o>=</span> <span class=mi>8</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>关联漏洞:</p><p><code>中风险-逻辑漏洞</code></p><p><a id=1.1.9></a></p><h4 id=19必须注意八进制问题>1.9【必须】注意八进制问题</h4><p>代码对齐时应当使用空格或者编辑器自带的对齐功能，谨慎在数字前使用0来对齐代码，以免不当将某些内容转换为八进制。</p><p>例如，如果预期为20字节长度的缓冲区，则下列代码存在错误。buf2为020（OCT）长度，实际只有16（DEC）长度，在memcpy后越界：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=c1>// Bad
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>char</span> <span class=n>buf1</span><span class=p>[</span><span class=mi>1024</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span><span class=mi>0</span><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=kt>char</span> <span class=n>buf2</span><span class=p>[</span><span class=mo>0020</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span><span class=mi>0</span><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>memcpy</span><span class=p>(</span><span class=n>buf2</span><span class=p>,</span> <span class=n>somebuf</span><span class=p>,</span> <span class=mi>19</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>应当在使用8进制时明确注明这是八进制。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=c1>// Good
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>int</span> <span class=n>access_mask</span> <span class=o>=</span> <span class=mo>0777</span><span class=p>;</span>  <span class=c1>// oct, rwxrwxrwx
</span></span></span></code></pre></td></tr></table></div></div><p>关联漏洞:</p><p><code>中风险-逻辑漏洞</code></p><p><a id=1.2></a></p><h3 id=2-不推荐的编程习惯>2 不推荐的编程习惯</h3><p><a id=1.2.1></a></p><h4 id=21-必须switch中应有default>2.1 【必须】switch中应有default</h4><p>switch中应该有default，以处理各种预期外的情况。这可以确保switch接受用户输入，或者后期在其他开发者修改函数后确保switch仍可以覆盖到所有情况，并确保逻辑正常运行。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=c1>// Bad
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>int</span> <span class=nf>Foo</span><span class=p>(</span><span class=kt>int</span> <span class=n>bar</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>switch</span> <span class=p>(</span><span class=n>bar</span> <span class=o>&amp;</span> <span class=mi>7</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=mi>0</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>Foobar</span><span class=p>(</span><span class=n>bar</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=mi>1</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>Foobar</span><span class=p>(</span><span class=n>bar</span> <span class=o>*</span> <span class=mi>2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>例如上述代码switch的取值可能从0～7，所以应当有default：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=c1>// Good
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>int</span> <span class=nf>Foo</span><span class=p>(</span><span class=kt>int</span> <span class=n>bar</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>switch</span> <span class=p>(</span><span class=n>bar</span> <span class=o>&amp;</span> <span class=mi>7</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=mi>0</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>Foobar</span><span class=p>(</span><span class=n>bar</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=mi>1</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>Foobar</span><span class=p>(</span><span class=n>bar</span> <span class=o>*</span> <span class=mi>2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>关联漏洞:</p><p><code>中风险-逻辑漏洞</code></p><p><code>中风险-内存泄漏</code></p><p><a id=1.2.2></a></p><h4 id=22-必须不应当在debug或错误信息中提供过多内容>2.2 【必须】不应当在Debug或错误信息中提供过多内容</h4><p>包含过多信息的Debug消息不应当被用户获取到。Debug信息可能会泄露一些值，例如内存数据、内存地址等内容，这些内容可以帮助攻击者在初步控制程序后，更容易地攻击程序。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=c1>// Bad
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>int</span> <span class=nf>Foo</span><span class=p>(</span><span class=kt>int</span><span class=o>*</span> <span class=n>bar</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>bar</span> <span class=o>&amp;&amp;</span> <span class=o>*</span><span class=n>bar</span> <span class=o>==</span> <span class=mi>5</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>OutputDebugInfoToUser</span><span class=p>(</span><span class=s>&#34;Wrong value for bar %p = %d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>bar</span><span class=p>,</span> <span class=o>*</span><span class=n>bar</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>而应该：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=c1>// Good
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>int</span> <span class=nf>foo</span><span class=p>(</span><span class=kt>int</span><span class=o>*</span> <span class=n>bar</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#ifdef DEBUG
</span></span></span><span class=line><span class=cl><span class=cp></span>  <span class=k>if</span> <span class=p>(</span><span class=n>bar</span> <span class=o>&amp;&amp;</span> <span class=o>*</span><span class=n>bar</span> <span class=o>==</span> <span class=mi>5</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>OutputDebugInfo</span><span class=p>(</span><span class=s>&#34;Wrong value for bar.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>bar</span><span class=p>,</span> <span class=o>*</span><span class=n>bar</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>关联漏洞:</p><p><code>中风险-信息泄漏</code></p><p><a id=1.2.3></a></p><h4 id=23-必须不应该在客户端代码中硬编码对称加密秘钥>2.3 【必须】不应该在客户端代码中硬编码对称加密秘钥</h4><p>不应该在客户端代码中硬编码对称加密秘钥。例如：不应在客户端代码使用硬编码的 AES/ChaCha20-Poly1305/SM1 密钥，使用固定密钥的程序基本和没有加密一样。</p><p>如果业务需求是认证加密数据传输，应优先考虑直接用 HTTPS 协议。</p><p>如果是其它业务需求，可考虑由服务器端生成对称秘钥，客户端通过 HTTPS 等认证加密通信渠道从服务器拉取。</p><p>或者根据用户特定的会话信息，比如登录认证过程可以根据用户名用户密码业务上下文等信息，使用 HKDF 等算法衍生出对称秘钥。</p><p>又或者使用 RSA/ECDSA + ECDHE 等进行认证秘钥协商，生成对称秘钥。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=c1>// Bad
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>char</span> <span class=n>g_aes_key</span><span class=p>[]</span> <span class=o>=</span> <span class=p>{...};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>Foo</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=p>....</span>
</span></span><span class=line><span class=cl>  <span class=n>AES_func</span><span class=p>(</span><span class=n>g_aes_key</span><span class=p>,</span> <span class=n>input_data</span><span class=p>,</span> <span class=n>output_data</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可以考虑在线为每个用户获取不同的密钥：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=c1>// Good
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>char</span><span class=o>*</span> <span class=n>g_aes_key</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>Foo</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=p>....</span>
</span></span><span class=line><span class=cl>  <span class=n>AES_encrypt</span><span class=p>(</span><span class=n>g_aes_key</span><span class=p>,</span> <span class=n>input_data</span><span class=p>,</span> <span class=n>output_data</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>Init</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>g_aes_key</span> <span class=o>=</span> <span class=n>get_key_from_https</span><span class=p>(</span><span class=n>user_id</span><span class=p>,</span> <span class=p>...);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>关联漏洞:</p><p><code>中风险-信息泄露</code></p><p><a id=1.2.4></a></p><h4 id=24-必须返回栈上变量的地址>2.4 【必须】返回栈上变量的地址</h4><p>函数不可以返回栈上的变量的地址，其内容在函数返回后就会失效。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=c1>// Bad
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>char</span><span class=o>*</span> <span class=nf>Foo</span><span class=p>(</span><span class=kt>char</span><span class=o>*</span> <span class=n>sz</span><span class=p>,</span> <span class=kt>int</span> <span class=n>len</span><span class=p>){</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=n>a</span><span class=p>[</span><span class=mi>300</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span><span class=mi>0</span><span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>len</span> <span class=o>&gt;</span> <span class=mi>100</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>memcpy</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>sz</span><span class=p>,</span> <span class=mi>100</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=n>a</span><span class=p>[</span><span class=n>len</span><span class=p>]</span> <span class=o>=</span> <span class=sc>&#39;\0&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>a</span><span class=p>;</span>  <span class=c1>// WRONG
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>而应当使用堆来传递非简单类型变量。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=c1>// Good
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>char</span><span class=o>*</span> <span class=nf>Foo</span><span class=p>(</span><span class=kt>char</span><span class=o>*</span> <span class=n>sz</span><span class=p>,</span> <span class=kt>int</span> <span class=n>len</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span><span class=o>*</span> <span class=n>a</span> <span class=o>=</span> <span class=k>new</span> <span class=kt>char</span><span class=p>[</span><span class=mi>300</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>len</span> <span class=o>&gt;</span> <span class=mi>100</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>memcpy</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>sz</span><span class=p>,</span> <span class=mi>100</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>a</span><span class=p>[</span><span class=n>len</span><span class=p>]</span> <span class=o>=</span> <span class=sc>&#39;\0&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>a</span><span class=p>;</span>  <span class=c1>// OK
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>对于 C++ 程序来说，强烈建议返回 <code>string</code>、<code>vector</code> 等类型，会让代码更加简单和安全。</p><p>关联漏洞:</p><p><code>高风险-内存破坏</code></p><p><a id=1.2.5></a></p><h4 id=25-必须有逻辑联系的数组必须仔细检查>2.5 【必须】有逻辑联系的数组必须仔细检查</h4><p>例如下列程序将字符串转换为week day，但是两个数组并不一样长，导致程序可能会越界读一个int。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=c1>// Bad
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>int</span> <span class=n>nWeekdays</span><span class=p>[]</span> <span class=o>=</span> <span class=p>{</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>5</span><span class=p>,</span> <span class=mi>6</span><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>sWeekdays</span><span class=p>[]</span> <span class=o>=</span> <span class=p>{</span><span class=s>&#34;Mon&#34;</span><span class=p>,</span> <span class=s>&#34;Tue&#34;</span><span class=p>,</span> <span class=s>&#34;Wed&#34;</span><span class=p>,</span> <span class=s>&#34;Thu&#34;</span><span class=p>,</span> <span class=s>&#34;Fri&#34;</span><span class=p>,</span> <span class=s>&#34;Sat&#34;</span><span class=p>,</span> <span class=s>&#34;Sun&#34;</span><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>x</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>x</span> <span class=o>&lt;</span> <span class=n>ARRAY_SIZE</span><span class=p>(</span><span class=n>sWeekdays</span><span class=p>);</span> <span class=n>x</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>strcmp</span><span class=p>(</span><span class=n>sWeekdays</span><span class=p>[</span><span class=n>x</span><span class=p>],</span> <span class=n>input</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>nWeekdays</span><span class=p>[</span><span class=n>x</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>应当确保有关联的nWeekdays和sWeekdays数据统一。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=c1>// Good
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>const</span> <span class=kt>int</span> <span class=n>nWeekdays</span><span class=p>[]</span> <span class=o>=</span> <span class=p>{</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>5</span><span class=p>,</span> <span class=mi>6</span><span class=p>,</span> <span class=mi>7</span><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>sWeekdays</span><span class=p>[]</span> <span class=o>=</span> <span class=p>{</span><span class=s>&#34;Mon&#34;</span><span class=p>,</span> <span class=s>&#34;Tue&#34;</span><span class=p>,</span> <span class=s>&#34;Wed&#34;</span><span class=p>,</span> <span class=s>&#34;Thu&#34;</span><span class=p>,</span> <span class=s>&#34;Fri&#34;</span><span class=p>,</span> <span class=s>&#34;Sat&#34;</span><span class=p>,</span> <span class=s>&#34;Sun&#34;</span><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=n>assert</span><span class=p>(</span><span class=n>ARRAY_SIZE</span><span class=p>(</span><span class=n>nWeekdays</span><span class=p>)</span> <span class=o>==</span> <span class=n>ARRAY_SIZE</span><span class=p>(</span><span class=n>sWeekdays</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>x</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>x</span> <span class=o>&lt;</span> <span class=n>ARRAY_SIZE</span><span class=p>(</span><span class=n>sWeekdays</span><span class=p>);</span> <span class=n>x</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>strcmp</span><span class=p>(</span><span class=n>sWeekdays</span><span class=p>[</span><span class=n>x</span><span class=p>],</span> <span class=n>input</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>nWeekdays</span><span class=p>[</span><span class=n>x</span><span class=p>];</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>关联漏洞:</p><p><code>高风险-内存破坏</code></p><p><a id=1.2.6></a></p><h4 id=26-必须避免函数的声明和实现不同>2.6 【必须】避免函数的声明和实现不同</h4><p>在头文件、源代码、文档中列举的函数声明应当一致，不应当出现定义内容错位的情况。</p><p>错误：</p><p>foo.h</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=kt>int</span> <span class=nf>CalcArea</span><span class=p>(</span><span class=kt>int</span> <span class=n>width</span><span class=p>,</span> <span class=kt>int</span> <span class=n>height</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>foo.cc</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=kt>int</span> <span class=nf>CalcArea</span><span class=p>(</span><span class=kt>int</span> <span class=n>height</span><span class=p>,</span> <span class=kt>int</span> <span class=n>width</span><span class=p>)</span> <span class=p>{</span>  <span class=c1>// Different from foo.h
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=n>height</span> <span class=o>&gt;</span> <span class=n>real_height</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>height</span> <span class=o>*</span> <span class=n>width</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>正确：
foo.h</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=kt>int</span> <span class=nf>CalcArea</span><span class=p>(</span><span class=kt>int</span> <span class=n>height</span><span class=p>,</span> <span class=kt>int</span> <span class=n>width</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>foo.cc</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=kt>int</span> <span class=nf>CalcArea</span> <span class=p>(</span><span class=kt>int</span> <span class=n>height</span><span class=p>,</span> <span class=kt>int</span> <span class=n>width</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>height</span> <span class=o>&gt;</span> <span class=n>real_height</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>height</span> <span class=o>*</span> <span class=n>width</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>关联漏洞:</p><p><code>中风险-逻辑问题</code></p><p><a id=1.2.7></a></p><h4 id=27-必须检查复制粘贴的重复代码相同代码通常代表错误>2.7 【必须】检查复制粘贴的重复代码（相同代码通常代表错误）</h4><p>当开发中遇到较长的句子时，如果你选择了复制粘贴语句，请记得检查每一行代码，不要出现上下两句一模一样的情况，这通常代表代码哪里出现了错误：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=c1>// Bad
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=nf>Foobar</span><span class=p>(</span><span class=n>SomeStruct</span><span class=o>&amp;</span> <span class=n>foobase</span><span class=p>,</span> <span class=n>SomeStruct</span><span class=o>&amp;</span> <span class=n>foo1</span><span class=p>,</span> <span class=n>SomeStruct</span><span class=o>&amp;</span> <span class=n>foo2</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>foo1</span><span class=p>.</span><span class=n>bar</span> <span class=o>=</span> <span class=p>(</span><span class=n>foo1</span><span class=p>.</span><span class=n>bar</span> <span class=o>&amp;</span> <span class=mh>0xffff</span><span class=p>)</span> <span class=o>|</span> <span class=p>(</span><span class=n>foobase</span><span class=p>.</span><span class=n>base</span> <span class=o>&amp;</span> <span class=mh>0xffff0000</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>foo1</span><span class=p>.</span><span class=n>bar</span> <span class=o>=</span> <span class=p>(</span><span class=n>foo1</span><span class=p>.</span><span class=n>bar</span> <span class=o>&amp;</span> <span class=mh>0xffff</span><span class=p>)</span> <span class=o>|</span> <span class=p>(</span><span class=n>foobase</span><span class=p>.</span><span class=n>base</span> <span class=o>&amp;</span> <span class=mh>0xffff0000</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>如上例，通常可能是：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=c1>// Good
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=nf>Foobar</span><span class=p>(</span><span class=n>SomeStruct</span><span class=o>&amp;</span> <span class=n>foobase</span><span class=p>,</span> <span class=n>SomeStruct</span><span class=o>&amp;</span> <span class=n>foo1</span><span class=p>,</span> <span class=n>SomeStruct</span><span class=o>&amp;</span> <span class=n>foo2</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>foo1</span><span class=p>.</span><span class=n>bar</span> <span class=o>=</span> <span class=p>(</span><span class=n>foo1</span><span class=p>.</span><span class=n>bar</span> <span class=o>&amp;</span> <span class=mh>0xffff</span><span class=p>)</span> <span class=o>|</span> <span class=p>(</span><span class=n>foobase</span><span class=p>.</span><span class=n>base</span> <span class=o>&amp;</span> <span class=mh>0xffff0000</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>foo2</span><span class=p>.</span><span class=n>bar</span> <span class=o>=</span> <span class=p>(</span><span class=n>foo2</span><span class=p>.</span><span class=n>bar</span> <span class=o>&amp;</span> <span class=mh>0xffff</span><span class=p>)</span> <span class=o>|</span> <span class=p>(</span><span class=n>foobase</span><span class=p>.</span><span class=n>base</span> <span class=o>&amp;</span> <span class=mh>0xffff0000</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>最好是把重复的代码片段提取成函数，如果函数比较短，可以考虑定义为 <code>inline</code> 函数，在减少冗余的同时也能确保不会影响性能。</p><p>关联漏洞:</p><p><code>中风险-逻辑问题</code></p><p><a id=1.2.8></a></p><h4 id=28--必须左右一致的重复判断永远为真或假的判断通常代表错误>2.8 【必须】左右一致的重复判断/永远为真或假的判断（通常代表错误）</h4><p>这通常是由于自动完成或例如Visual Assistant X之类的补全插件导致的问题。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=c1>// Bad
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>if</span> <span class=p>(</span><span class=n>foo1</span><span class=p>.</span><span class=n>bar</span> <span class=o>==</span> <span class=n>foo1</span><span class=p>.</span><span class=n>bar</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=err>…</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可能是：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=c1>// Good
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>if</span> <span class=p>(</span><span class=n>foo1</span><span class=p>.</span><span class=n>bar</span> <span class=o>==</span> <span class=n>foo2</span><span class=p>.</span><span class=n>bar</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=err>…</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>关联漏洞:</p><p><code>中风险-逻辑问题</code></p><p><a id=1.2.9></a></p><h4 id=29-必须函数每个分支都应有返回值>2.9 【必须】函数每个分支都应有返回值</h4><p>函数的每个分支都应该有返回值，否则如果函数走到无返回值的分支，其结果是未知的。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=c1>// Bad
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>int</span> <span class=nf>Foo</span><span class=p>(</span><span class=kt>int</span> <span class=n>bar</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>bar</span> <span class=o>&gt;</span> <span class=mi>100</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>10</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>bar</span> <span class=o>&gt;</span> <span class=mi>10</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>上述例子当bar&lt;10时，其结果是未知的值。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=c1>// Good
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>int</span> <span class=nf>Foo</span><span class=p>(</span><span class=kt>int</span> <span class=n>bar</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>bar</span> <span class=o>&gt;</span> <span class=mi>100</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>10</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>bar</span> <span class=o>&gt;</span> <span class=mi>10</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>开启适当级别的警告（GCC 中为 <code>-Wreturn-type</code> 并已包含在 <code>-Wall</code> 中）并设置为错误，可以在编译阶段发现这类错误。</p><p>关联漏洞:</p><p><code>中风险-逻辑问题</code></p><p><code>中风险-信息泄漏</code></p><p><a id=1.2.10></a></p><h4 id=210-必须不得使用栈上未初始化的变量>2.10 【必须】不得使用栈上未初始化的变量</h4><p>在栈上声明的变量要注意是否在使用它之前已经初始化了</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=c1>// Bad
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=nf>Foo</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>foo</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>Bar</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>foo</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=n>Foobar</span><span class=p>(</span><span class=n>foo</span><span class=p>);</span> <span class=c1>// foo可能没有初始化
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>最好在声明的时候就立刻初始化变量，或者确保每个分支都初始化它。开启相应的编译器警告（GCC 中为 <code>-Wuninitialized</code>），并把设置为错误级别，可以在编译阶段发现这类错误。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=c1>// Good
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=nf>Foo</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>foo</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>Bar</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>foo</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=n>Foobar</span><span class=p>(</span><span class=n>foo</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>关联漏洞:</p><p><code>中风险-逻辑问题</code></p><p><code>中风险-信息泄漏</code></p><p><a id=1.2.11></a></p><h4 id=211--建议不得直接使用刚分配的未初始化的内存如realloc>2.11 【建议】不得直接使用刚分配的未初始化的内存（如realloc）</h4><p>一些刚申请的内存通常是直接从堆上分配的，可能包含有旧数据的，直接使用它们而不初始化，可能会导致安全问题。例如，CVE-2019-13751。应确保初始化变量，或者确保未初始化的值不会泄露给用户。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=c1>// Bad
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>char</span><span class=o>*</span> <span class=nf>Foo</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span><span class=o>*</span> <span class=n>a</span> <span class=o>=</span> <span class=k>new</span> <span class=kt>char</span><span class=p>[</span><span class=mi>100</span><span class=p>];</span>
</span></span><span class=line><span class=cl>  <span class=n>a</span><span class=p>[</span><span class=mi>99</span><span class=p>]</span> <span class=o>=</span> <span class=sc>&#39;\0&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>memcpy</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=s>&#34;char&#34;</span><span class=p>,</span> <span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>a</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=c1>// Good
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>char</span><span class=o>*</span> <span class=nf>Foo</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span><span class=o>*</span> <span class=n>a</span> <span class=o>=</span> <span class=k>new</span> <span class=kt>char</span><span class=p>[</span><span class=mi>100</span><span class=p>];</span>
</span></span><span class=line><span class=cl>  <span class=n>memcpy</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=s>&#34;char&#34;</span><span class=p>,</span> <span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>a</span><span class=p>[</span><span class=mi>4</span><span class=p>]</span> <span class=o>=</span> <span class=sc>&#39;\0&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>a</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>在 C++ 中，再次强烈推荐用 <code>string</code>、<code>vector</code> 代替手动内存分配。</p><p>关联漏洞:</p><p><code>中风险-逻辑问题</code></p><p><code>中风险-信息泄漏</code></p><p><a id=1.2.12></a></p><h4 id=212-必须校验内存相关函数的返回值>2.12 【必须】校验内存相关函数的返回值</h4><p>与内存分配相关的函数需要检查其返回值是否正确，以防导致程序崩溃或逻辑错误。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=c1>// Bad
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=nf>Foo</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span><span class=o>*</span> <span class=n>bar</span> <span class=o>=</span> <span class=n>mmap</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mh>0x800000</span><span class=p>,</span> <span class=p>.....);</span>
</span></span><span class=line><span class=cl>  <span class=o>*</span><span class=p>(</span><span class=n>bar</span> <span class=o>+</span> <span class=mh>0x400000</span><span class=p>)</span> <span class=o>=</span> <span class=sc>&#39;\x88&#39;</span><span class=p>;</span> <span class=c1>// Wrong
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>如上例mmap如果失败，bar的值将是0xffffffff (ffffffff)，第二行将会往0x3ffffff写入字符，导致越界写。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=c1>// Good
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=nf>Foo</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span><span class=o>*</span> <span class=n>bar</span> <span class=o>=</span> <span class=n>mmap</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mh>0x800000</span><span class=p>,</span> <span class=p>.....);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span><span class=p>(</span><span class=n>bar</span> <span class=o>==</span> <span class=n>MAP_FAILED</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=o>*</span><span class=p>(</span><span class=n>bar</span> <span class=o>+</span> <span class=mh>0x400000</span><span class=p>)</span> <span class=o>=</span> <span class=sc>&#39;\x88&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>关联漏洞:</p><p><code>中风险-逻辑问题</code></p><p><code>高风险-越界操作</code></p><p><a id=1.2.13></a></p><h4 id=213-必须不要在if里面赋值>2.13 【必须】不要在if里面赋值</h4><p>if里赋值通常代表代码存在错误。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=c1>// Bad
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=nf>Foo</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>bar</span> <span class=o>=</span> <span class=mh>0x99</span><span class=p>)</span> <span class=p>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>通常应该是：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=c1>// Good
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=nf>Foo</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>bar</span> <span class=o>==</span> <span class=mh>0x99</span><span class=p>)</span> <span class=p>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>建议在构建系统中开启足够的编译器警告（GCC 中为 <code>-Wparentheses</code> 并已包含在 <code>-Wall</code> 中），并把该警告设置为错误。</p><p>关联漏洞:</p><p><code>中风险-逻辑问题</code></p><p><a id=1.2.14></a></p><h4 id=214-建议确认if里面的按位操作>2.14 【建议】确认if里面的按位操作</h4><p>if里，非bool类型和非bool类型的按位操作可能代表代码存在错误。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=c1>// Bad
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=nf>Foo</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>bar</span> <span class=o>=</span> <span class=mh>0x1</span><span class=p>;</span>     <span class=c1>// binary 01
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>int</span> <span class=n>foobar</span> <span class=o>=</span> <span class=mh>0x2</span><span class=p>;</span>    <span class=c1>// binary 10
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>foobar</span> <span class=o>&amp;</span> <span class=n>bar</span><span class=p>)</span>     <span class=c1>// result = 00, false
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>上述代码可能应该是：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=c1>// Good
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=nf>foo</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span>   <span class=n>bar</span> <span class=o>=</span> <span class=mh>0x1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>foobar</span> <span class=o>=</span> <span class=mh>0x2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>foobar</span> <span class=o>&amp;&amp;</span> <span class=n>bar</span><span class=p>)</span>  <span class=c1>// result : true
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>关联漏洞:</p><p><code>中风险-逻辑问题</code></p><p><a id=1.3></a></p><h3 id=3----多线程>3 多线程</h3><p><a id=1.3.1></a></p><h4 id=31--必须变量应确保线程安全性>3.1 【必须】变量应确保线程安全性</h4><p>当一个变量可能被多个线程使用时，应当使用原子操作或加锁操作。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=c1>// Bad
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>char</span>  <span class=n>g_somechar</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>foo_thread1</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>g_somechar</span> <span class=o>+=</span> <span class=mi>3</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>foo_thread2</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>g_somechar</span> <span class=o>+=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>对于可以使用原子操作的，应当使用一些可以确保内存安全的操作，如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=c1>// Good
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>volatile</span> <span class=kt>char</span> <span class=n>g_somechar</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>foo_thread1</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>__sync_fetch_and_add</span><span class=p>(</span><span class=o>&amp;</span><span class=n>g_somechar</span><span class=p>,</span> <span class=mi>3</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>foo_thread2</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>__sync_fetch_and_add</span><span class=p>(</span><span class=o>&amp;</span><span class=n>g_somechar</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>对于 C 代码，<code>C11</code> 后推荐使用 <a href=https://en.cppreference.com/w/c/atomic target=_blank rel="noopener noreffer">atomic</a> 标准库。
对于 C++代码，<code>C++11</code> 后，推荐使用 <a href=https://zh.cppreference.com/w/cpp/atomic/atomic target=_blank rel="noopener noreffer"><code>std::atomic</code></a>。</p><p>关联漏洞:</p><p><code>高风险-内存破坏</code></p><p><code>中风险-逻辑问题</code></p><p><a id=1.3.2></a></p><h4 id=32-必须注意signal-handler导致的条件竞争>3.2 【必须】注意signal handler导致的条件竞争</h4><p>竞争条件经常出现在信号处理程序中，因为信号处理程序支持异步操作。攻击者能够利用信号处理程序争用条件导致软件状态损坏，从而可能导致拒绝服务甚至代码执行。</p><ol><li>当信号处理程序中发生不可重入函数或状态敏感操作时，就会出现这些问题。因为信号处理程序中随时可以被调用。比如，当在信号处理程序中调用<code>free</code>时，通常会出现另一个信号争用条件，从而导致双重释放。即使给定指针在释放后设置为<code>NULL</code>，在释放内存和将指针设置为<code>NULL</code>之间仍然存在竞争的可能。</li><li>为多个信号设置了相同的信号处理程序，这尤其有问题——因为这意味着信号处理程序本身可能会重新进入。例如，malloc()和free()是不可重入的，因为它们可能使用全局或静态数据结构来管理内存，并且它们被syslog()等看似无害的函数间接使用；这些函数可能会导致内存损坏和代码执行。</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=c1>// Bad
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>char</span> <span class=o>*</span><span class=n>log_message</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>Handler</span><span class=p>(</span><span class=kt>int</span> <span class=n>signum</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>syslog</span><span class=p>(</span><span class=n>LOG_NOTICE</span><span class=p>,</span> <span class=s>&#34;%s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>log_m_essage</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>free</span><span class=p>(</span><span class=n>log_message</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>sleep</span><span class=p>(</span><span class=mi>10</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span> <span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span><span class=o>*</span> <span class=n>argv</span><span class=p>[])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>log_message</span> <span class=o>=</span> <span class=n>strdup</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>  <span class=n>signal</span><span class=p>(</span><span class=n>SIGHUP</span><span class=p>,</span> <span class=n>Handler</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>signal</span><span class=p>(</span><span class=n>SIGTERM</span><span class=p>,</span> <span class=n>Handler</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>sleep</span><span class=p>(</span><span class=mi>10</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可以借由下列操作规避问题：</p><ol><li>避免在多个处理函数中共享某些变量。</li><li>在信号处理程序中使用同步操作。</li><li>屏蔽不相关的信号，从而提供原子性。</li><li>避免在信号处理函数中调用不满足<a href=https://www.man7.org/linux/man-pages/man7/signal-safety.7.html target=_blank rel="noopener noreffer">异步信号安全</a>的函数。</li></ol><p>关联漏洞:</p><p><code>高风险-内存破坏</code></p><p><code>中风险-逻辑问题</code></p><p><a id=1.3.3></a></p><h4 id=33-建议注意time-of-check-time-of-use-toctou-条件竞争>3.3 【建议】注意Time-of-check Time-of-use (TOCTOU) 条件竞争</h4><p>TOCTOU： 软件在使用某个资源之前检查该资源的状态，但是该资源的状态可以在检查和使用之间更改，从而使检查结果无效。当资源处于这种意外状态时，这可能会导致软件执行错误操作。</p><p>当攻击者可以影响检查和使用之间的资源状态时，此问题可能与安全相关。这可能发生在共享资源(如<strong>文件、内存</strong>，甚至多线程程序中的<strong>变量</strong>)上。在编程时需要注意避免出现TOCTOU问题。</p><p>例如，下面的例子中，该文件可能已经在检查和lstat之间进行了更新，特别是因为printf有延迟。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=k>struct</span> <span class=nc>stat</span> <span class=o>*</span><span class=n>st</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>lstat</span><span class=p>(</span><span class=s>&#34;...&#34;</span><span class=p>,</span> <span class=n>st</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>printf</span><span class=p>(</span><span class=s>&#34;foo&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=n>st</span><span class=o>-&gt;</span><span class=n>st_mtimespec</span> <span class=o>==</span> <span class=p>...)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>printf</span><span class=p>(</span><span class=s>&#34;Now updating things</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>UpdateThings</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>TOCTOU难以修复，但是有以下缓解方案：</p><ol><li>限制对来自多个进程的文件的交叉操作。</li><li>如果必须在多个进程或线程之间共享对资源的访问，那么请尝试限制”检查“（CHECK）和”使用“（USE）资源之间的时间量，使他们相距尽量不要太远。这不会从根本上解决问题，但可能会使攻击更难成功。</li><li>在Use调用之后重新检查资源，以验证是否正确执行了操作。</li><li>确保一些环境锁定机制能够被用来有效保护资源。但要确保锁定是检查之前进行的，而不是在检查之后进行的，以便检查时的资源与使用时的资源相同。</li></ol><p>关联漏洞:</p><p><code>高风险-内存破坏</code></p><p><code>中风险-逻辑问题</code></p><p><a id=1.4></a></p><h3 id=4----加密解密>4 加密解密</h3><p><a id=1.4.1></a></p><h4 id=41--必须不得明文存储用户密码等敏感数据>4.1 【必须】不得明文存储用户密码等敏感数据</h4><p>用户密码应该使用 Argon2, scrypt, bcrypt, pbkdf2 等算法做哈希之后再存入存储系统, <a href=https://password-hashing.net/ target=_blank rel="noopener noreffer">https://password-hashing.net/</a></p><p><a href=https://libsodium.gitbook.io/doc/password_hashing/default_phf#example-2-password-storage target=_blank rel="noopener noreffer">https://libsodium.gitbook.io/doc/password_hashing/default_phf#example-2-password-storage</a></p><p>用户敏感数据，应该做到传输过程中加密，存储状态下加密
传输过程中加密，可以使用 HTTPS 等认证加密通信协议</p><p>存储状态下加密，可以使用 SQLCipher 等类似方案。</p><p><a id=1.4.2></a></p><h4 id=42--必须内存中的用户密码等敏感数据应该安全抹除>4.2 【必须】内存中的用户密码等敏感数据应该安全抹除</h4><p>例如用户密码等，即使是临时使用，也应在使用完成后应当将内容彻底清空。</p><p>错误：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;openssl/crypto.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=p>...</span>
</span></span><span class=line><span class=cl>        <span class=n>string</span> <span class=n>user_password</span><span class=p>(</span><span class=mi>100</span><span class=p>,</span> <span class=sc>&#39;\0&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>snprintf</span><span class=p>(</span><span class=o>&amp;</span><span class=n>user_password</span><span class=p>,</span> <span class=s>&#34;password: %s&#34;</span><span class=p>,</span> <span class=n>user_password</span><span class=p>.</span><span class=n>size</span><span class=p>(),</span> <span class=n>password_from_input</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>...</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>正确：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=p>...</span>
</span></span><span class=line><span class=cl>        <span class=n>string</span> <span class=n>user_password</span><span class=p>(</span><span class=mi>100</span><span class=p>,</span> <span class=sc>&#39;\0&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>snprintf</span><span class=p>(</span><span class=o>&amp;</span><span class=n>user_password</span><span class=p>,</span> <span class=s>&#34;password: %s&#34;</span><span class=p>,</span> <span class=n>user_password</span><span class=p>.</span><span class=n>size</span><span class=p>(),</span> <span class=n>password_from_input</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>...</span>
</span></span><span class=line><span class=cl>        <span class=n>OPENSSL_cleanse</span><span class=p>(</span><span class=o>&amp;</span><span class=n>user_password</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>user_password</span><span class=p>.</span><span class=n>size</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>关联漏洞:</p><p><code>高风险-敏感信息泄露</code></p><p><a id=1.4.3></a></p><h4 id=43--必须rand-类函数应正确初始化>4.3 【必须】rand() 类函数应正确初始化</h4><p>rand类函数的随机性并不高。而且在使用前需要使用srand()来初始化。未初始化的随机数可能导致某些内容可预测。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=c1>// Bad
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>foo</span> <span class=o>=</span> <span class=n>rand</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>上述代码执行完成后，foo的值是固定的。它等效于 <code>srand(1); rand();</code>。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=c1>// Good
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>srand</span><span class=p>(</span><span class=n>time</span><span class=p>(</span><span class=mi>0</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>foo</span> <span class=o>=</span> <span class=n>rand</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>关联漏洞:</p><p><code>高风险-逻辑漏洞</code></p><p><a id=1.4.4></a></p><h4 id=44--必须在需要高强度安全加密时不应使用弱prng函数>4.4 【必须】在需要高强度安全加密时不应使用弱PRNG函数</h4><p>在需要生成 AES/SM1/HMAC 等算法的密钥/IV/Nonce， RSA/ECDSA/ECDH 等算法的私钥，这类需要高安全性的业务场景，必须使用密码学安全的随机数生成器 (Cryptographically Secure PseudoRandom Number Generator (CSPRNG) ), 不得使用 <code>rand()</code> 等无密码学安全性保证的普通随机数生成器。</p><p>推荐使用的 CSPRNG 有：</p><ol><li><p>OpenSSL 中的 <code>RAND_bytes()</code> 函数, <a href=https://www.openssl.org/docs/man1.1.1/man3/RAND_bytes.html target=_blank rel="noopener noreffer">https://www.openssl.org/docs/man1.1.1/man3/RAND_bytes.html</a></p></li><li><p>libsodium 中的 <code>randombytes_buf()</code> 函数</p></li><li><p>Linux kernel 的 <code>getrandom()</code> 系统调用, <a href=https://man7.org/linux/man-pages/man2/getrandom.2.html target=_blank rel="noopener noreffer">https://man7.org/linux/man-pages/man2/getrandom.2.html</a> .
或者读 /dev/urandom 文件, 或者 /dev/random 文件。</p></li><li><p>Apple IOS 的 <code>SecRandomCopyBytes()</code>, <a href=https://developer.apple.com/documentation/security/1399291-secrandomcopybytes target=_blank rel="noopener noreffer">https://developer.apple.com/documentation/security/1399291-secrandomcopybytes</a></p></li><li><p>Windows 下的 <code>BCryptGenRandom()</code>, <code>CryptGenRandom()</code>, <code>RtlGenRandom()</code></p></li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;openssl/aes.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;openssl/crypto.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;openssl/rand.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>unsigned</span> <span class=kt>char</span> <span class=n>key</span><span class=p>[</span><span class=mi>16</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=mi>1</span> <span class=o>!=</span> <span class=n>RAND_bytes</span><span class=p>(</span><span class=o>&amp;</span><span class=n>key</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>key</span><span class=p>)))</span> <span class=p>{</span>  <span class=c1>//... 错误处理
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>AES_KEY</span> <span class=n>aes_key</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=mi>0</span> <span class=o>!=</span> <span class=n>AES_set_encrypt_key</span><span class=p>(</span><span class=o>&amp;</span><span class=n>key</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>key</span><span class=p>)</span> <span class=o>*</span> <span class=mi>8</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>aes_key</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// ... 错误处理
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=p>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>OPENSSL_cleanse</span><span class=p>(</span><span class=o>&amp;</span><span class=n>key</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>key</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>rand()</code>类函数的随机性并不高。敏感操作时，如设计加密算法时，不得使用rand()或者类似的简单线性同余伪随机数生成器来作为随机数发生器。符合该定义的比特序列的特点是，序列中“1”的数量约等于“0”的数量；同理，“01”、“00”、“10”、“11”的数量大致相同，以此类推。</p><p>例如 C 标准库中的 <code>rand()</code> 的实现只是简单的<a href="https://sourceware.org/git/?p=glibc.git;a=blob;f=stdlib/random_r.c;hb=glibc-2.28#l353" target=_blank rel="noopener noreffer">线性同余算法</a>，生成的伪随机数具有较强的可预测性。</p><p>当需要实现高强度加密，例如涉及通信安全时，不应当使用 <code>rand()</code> 作为随机数发生器。</p><p>实际应用中，<a href="https://docs.microsoft.com/en-us/cpp/standard-library/random-device-class?redirectedfrom=MSDN&view=vs-2019#remarks" target=_blank rel="noopener noreffer"> C++11 标准提供的<code>random_device</code>保证加密的安全性和随机性</a>
但是 <a href=https://stackoverflow.com/questions/44867500/is-stdrandom-device-cryptographic-secure target=_blank rel="noopener noreffer">C++ 标准并不保证这一点</a>。跨平台的代码可以考虑用 <a href=https://wiki.openssl.org/index.php/Random_Numbers target=_blank rel="noopener noreffer">OpenSSL</a> 等保证密码学安全的库里的随机数发生器。</p><p>关联漏洞:</p><p><code>高风险-敏感数据泄露</code></p><p><a id=1.4.5></a></p><h4 id=45--必须自己实现的rand范围不应过小>4.5 【必须】自己实现的rand范围不应过小</h4><p>如果在弱安全场景相关的算法中自己实现了PRNG，请确保rand出来的随机数不会很小或可预测。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=c1>// Bad
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>int32_t</span> <span class=n>val</span> <span class=o>=</span> <span class=p>((</span><span class=n>state</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>*</span> <span class=mi>1103515245U</span><span class=p>)</span> <span class=o>+</span> <span class=mi>12345U</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mi>999999</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>上述例子可能想生成0~999999共100万种可能的随机数，但是999999的二进制是11110100001000111111，与&运算后，0位一直是0，所以生成出的范围明显会小于100万种。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=c1>// Good
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>int32_t</span> <span class=n>val</span> <span class=o>=</span> <span class=p>((</span><span class=n>state</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>*</span> <span class=mi>1103515245U</span><span class=p>)</span> <span class=o>+</span> <span class=mi>12345U</span><span class=p>)</span> <span class=o>%</span> <span class=mi>1000000</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Good
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>int32_t</span> <span class=n>val</span> <span class=o>=</span> <span class=p>((</span><span class=n>state</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>*</span> <span class=mi>1103515245U</span><span class=p>)</span> <span class=o>+</span> <span class=mi>12345U</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0x7fffffff</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>关联漏洞:</p><p><code>高风险-逻辑漏洞</code></p><p><a id=1.5></a></p><h3 id=5----文件操作>5 文件操作</h3><p><a id=1.5.1></a></p><h4 id=51--必须避免路径穿越问题>5.1 【必须】避免路径穿越问题</h4><p>在进行文件操作时，需要判断外部传入的文件名是否合法，如果文件名中包含 <code>../</code> 等特殊字符，则会造成路径穿越，导致任意文件的读写。</p><p>错误：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=kt>void</span> <span class=nf>Foo</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=n>file_path</span><span class=p>[</span><span class=n>PATH_MAX</span><span class=p>]</span> <span class=o>=</span> <span class=s>&#34;/home/user/code/&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 如果传入的文件名包含../可导致路径穿越
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// 例如&#34;../file.txt&#34;，则可以读取到上层目录的file.txt文件
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>char</span> <span class=n>name</span><span class=p>[</span><span class=mi>20</span><span class=p>]</span> <span class=o>=</span> <span class=s>&#34;../file.txt&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>memcpy</span><span class=p>(</span><span class=n>file_path</span> <span class=o>+</span> <span class=n>strlen</span><span class=p>(</span><span class=n>file_path</span><span class=p>),</span> <span class=n>name</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>name</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>fd</span> <span class=o>=</span> <span class=n>open</span><span class=p>(</span><span class=n>file_path</span><span class=p>,</span> <span class=n>O_RDONLY</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>fd</span> <span class=o>!=</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>data</span><span class=p>[</span><span class=mi>100</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span><span class=mi>0</span><span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>num</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>memset</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>data</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=n>num</span> <span class=o>=</span> <span class=n>read</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>data</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>num</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>write</span><span class=p>(</span><span class=n>STDOUT_FILENO</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>num</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>close</span><span class=p>(</span><span class=n>fd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>正确：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=kt>void</span> <span class=nf>Foo</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=n>file_path</span><span class=p>[</span><span class=n>PATH_MAX</span><span class=p>]</span> <span class=o>=</span> <span class=s>&#34;/home/user/code/&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=n>name</span><span class=p>[</span><span class=mi>20</span><span class=p>]</span> <span class=o>=</span> <span class=s>&#34;../file.txt&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 判断传入的文件名是否非法，例如&#34;../file.txt&#34;中包含非法字符../，直接返回
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=n>strstr</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=s>&#34;..&#34;</span><span class=p>)</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 包含非法字符
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=n>memcpy</span><span class=p>(</span><span class=n>file_path</span> <span class=o>+</span> <span class=n>strlen</span><span class=p>(</span><span class=n>file_path</span><span class=p>),</span> <span class=n>name</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>name</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>fd</span> <span class=o>=</span> <span class=n>open</span><span class=p>(</span><span class=n>file_path</span><span class=p>,</span> <span class=n>O_RDONLY</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>fd</span> <span class=o>!=</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>data</span><span class=p>[</span><span class=mi>100</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span><span class=mi>0</span><span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>num</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>memset</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>data</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=n>num</span> <span class=o>=</span> <span class=n>read</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>data</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>num</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>write</span><span class=p>(</span><span class=n>STDOUT_FILENO</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>num</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>close</span><span class=p>(</span><span class=n>fd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>关联漏洞:</p><p><code>高风险-逻辑漏洞</code></p><p><a id=1.5.2></a></p><h4 id=52--必须避免相对路径导致的安全问题dllexe劫持等问题>5.2 【必须】避免相对路径导致的安全问题（DLL、EXE劫持等问题）</h4><p>在程序中，使用相对路径可能导致一些安全风险，例如DLL、EXE劫持等问题。</p><p>例如以下代码，可能存在劫持问题：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=kt>int</span> <span class=nf>Foo</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 传入的是dll文件名，如果当前目录下被写入了恶意的同名dll，则可能导致dll劫持
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>HINSTANCE</span> <span class=n>hinst</span> <span class=o>=</span> <span class=o>::</span><span class=n>LoadLibrary</span><span class=p>(</span><span class=s>&#34;dll_nolib.dll&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>hinst</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>cout</span><span class=o>&lt;&lt;</span><span class=s>&#34;dll loaded!&#34;</span> <span class=o>&lt;&lt;</span> <span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>针对DLL劫持的安全编码的规范：</p><p>1）调用LoadLibrary，LoadLibraryEx，CreateProcess，ShellExecute等进行模块加载的函数时，指明模块的完整（全）路径，禁止使用相对路径，这样就可避免从其它目录加载DLL。
2）在应用程序的开头调用SetDllDirectory(TEXT("")); 从而将当前目录从DLL的搜索列表中删除。结合SetDefaultDllDirectories，AddDllDirectory，RemoveDllDirectory这几个API配合使用，可以有效的规避DLL劫持问题。这些API只能在打了KB2533623补丁的Windows7，2008上使用。</p><p>关联漏洞:</p><p><code>中风险-逻辑漏洞</code></p><p><a id=1.5.3></a></p><h4 id=53--必须文件权限控制>5.3 【必须】文件权限控制</h4><p>在创建文件时，需要根据文件的敏感级别设置不同的访问权限，以防止敏感数据被其他恶意程序读取或写入。</p><p>错误：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=kt>int</span> <span class=nf>Foo</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 不要设置为777权限，以防止被其他恶意程序操作
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=n>creat</span><span class=p>(</span><span class=s>&#34;file.txt&#34;</span><span class=p>,</span> <span class=mo>0777</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;文件创建失败！</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;文件创建成功！</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>关联漏洞:</p><p><code>中风险-逻辑漏洞</code></p><p><a id=1.6></a></p><h3 id=6-内存操作>6 内存操作</h3><p><a id=1.6.1></a></p><h4 id=61-必须防止各种越界写向前向后>6.1 【必须】防止各种越界写（向前/向后）</h4><p>错误1：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=kt>int</span> <span class=n>a</span><span class=p>[</span><span class=mi>5</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=n>a</span><span class=p>[</span><span class=mi>5</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>错误2：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=kt>int</span> <span class=n>a</span><span class=p>[</span><span class=mi>5</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>b</span> <span class=o>=</span> <span class=n>user_controlled_value</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>a</span><span class=p>[</span><span class=n>b</span><span class=p>]</span> <span class=o>=</span> <span class=mi>3</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>关联漏洞:</p><p><code>高风险-内存破坏</code></p><p><a id=1.6.2></a></p><h4 id=62-必须防止任意地址写>6.2 【必须】防止任意地址写</h4><p>任意地址写会导致严重的安全隐患，可能导致代码执行。因此，在编码时必须校验写入的地址。</p><p>错误：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=kt>void</span> <span class=nf>Write</span><span class=p>(</span><span class=n>MyStruct</span> <span class=n>dst_struct</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=n>payload</span><span class=p>[</span><span class=mi>10</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span> <span class=mi>0</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=n>memcpy</span><span class=p>(</span><span class=n>dst_struct</span><span class=p>.</span><span class=n>buf</span><span class=p>,</span> <span class=n>payload</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>payload</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>MyStruct</span> <span class=n>dst_stuct</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>dst_stuct</span><span class=p>.</span><span class=n>buf</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span><span class=o>*</span><span class=p>)</span><span class=n>user_controlled_value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>Write</span><span class=p>(</span><span class=n>dst_stuct</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>关联漏洞:</p><p><code>高风险-内存破坏</code></p><p><a id=1.7></a></p><h3 id=7-数字操作>7 数字操作</h3><p><a id=1.7.1></a></p><h4 id=71-必须防止整数溢出>7.1 【必须】防止整数溢出</h4><p>在计算时需要考虑整数溢出的可能，尤其在进行内存操作时，需要对分配、拷贝等大小进行合法校验，防止整数溢出导致的漏洞。</p><p>错误（该例子在计算时产生整数溢出）</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=k>const</span> <span class=kt>int</span> <span class=n>kMicLen</span> <span class=o>=</span> <span class=mi>4</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=c1>// 整数溢出
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=nf>Foo</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>len</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=n>payload</span><span class=p>[</span><span class=mi>10</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span> <span class=mi>0</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=n>dst</span><span class=p>[</span><span class=mi>10</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span> <span class=mi>0</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Bad, 由于len小于4，导致计算拷贝长度时，整数溢出
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// len - kMicLen == 0xfffffffd
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>memcpy</span><span class=p>(</span><span class=n>dst</span><span class=p>,</span> <span class=n>payload</span><span class=p>,</span> <span class=n>len</span> <span class=o>-</span> <span class=n>kMicLen</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>正确例子</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=kt>void</span> <span class=nf>Foo</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>len</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=n>payload</span><span class=p>[</span><span class=mi>10</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span> <span class=mi>0</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=n>dst</span><span class=p>[</span><span class=mi>10</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span> <span class=mi>0</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>size</span> <span class=o>=</span> <span class=n>len</span> <span class=o>-</span> <span class=n>kMicLen</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 拷贝前对长度进行判断
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=n>size</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=n>size</span> <span class=o>&lt;</span> <span class=mi>10</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>memcpy</span><span class=p>(</span><span class=n>dst</span><span class=p>,</span> <span class=n>payload</span><span class=p>,</span> <span class=n>size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;memcpy good</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>关联漏洞:</p><p><code>高风险-内存破坏</code></p><p><a id=1.7.2></a></p><h4 id=72-必须防止off-by-one>7.2 【必须】防止Off-By-One</h4><p>在进行计算或者操作时，如果使用的最大值或最小值不正确，使得该值比正确值多1或少1，可能导致安全风险。</p><p>错误：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=kt>char</span> <span class=n>firstname</span><span class=p>[</span><span class=mi>20</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=kt>char</span> <span class=n>lastname</span><span class=p>[</span><span class=mi>20</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=kt>char</span> <span class=n>fullname</span><span class=p>[</span><span class=mi>40</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>fullname</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=sc>&#39;\0&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>strncat</span><span class=p>(</span><span class=n>fullname</span><span class=p>,</span> <span class=n>firstname</span><span class=p>,</span> <span class=mi>20</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>// 第二次调用strncat()可能会追加另外20个字符。如果这20个字符没有终止空字符，则存在安全问题
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>strncat</span><span class=p>(</span><span class=n>fullname</span><span class=p>,</span> <span class=n>lastname</span><span class=p>,</span> <span class=mi>20</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>正确：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=kt>char</span> <span class=n>firstname</span><span class=p>[</span><span class=mi>20</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=kt>char</span> <span class=n>lastname</span><span class=p>[</span><span class=mi>20</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=kt>char</span> <span class=n>fullname</span><span class=p>[</span><span class=mi>40</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>fullname</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=sc>&#39;\0&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 当使用像strncat()函数时，必须在缓冲区的末尾为终止空字符留下一个空字节，避免off-by-one
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>strncat</span><span class=p>(</span><span class=n>fullname</span><span class=p>,</span> <span class=n>firstname</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>fullname</span><span class=p>)</span> <span class=o>-</span> <span class=n>strlen</span><span class=p>(</span><span class=n>fullname</span><span class=p>)</span> <span class=o>-</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>strncat</span><span class=p>(</span><span class=n>fullname</span><span class=p>,</span> <span class=n>lastname</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>fullname</span><span class=p>)</span> <span class=o>-</span> <span class=n>strlen</span><span class=p>(</span><span class=n>fullname</span><span class=p>)</span> <span class=o>-</span> <span class=mi>1</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>对于 C++ 代码，再次强烈建议使用 <code>string</code>、<code>vector</code> 等组件代替原始指针和数组操作。</p><p>关联漏洞:</p><p><code>高风险-内存破坏</code></p><p><a id=1.7.3></a></p><h4 id=73-必须避免大小端错误>7.3 【必须】避免大小端错误</h4><p>在一些涉及大小端数据处理的场景，需要进行大小端判断，例如从大端设备取出的值，要以大端进行处理，避免端序错误使用。</p><p>关联漏洞:</p><p><code>中风险-逻辑漏洞</code></p><p><a id=1.7.4></a></p><h4 id=74-必须检查除以零异常>7.4 【必须】检查除以零异常</h4><p>在进行除法运算时，需要判断被除数是否为零，以防导致程序不符合预期或者崩溃。</p><p>错误：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=kt>int</span> <span class=nf>divide</span><span class=p>(</span><span class=kt>int</span> <span class=n>x</span><span class=p>,</span> <span class=kt>int</span> <span class=n>y</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>x</span> <span class=o>/</span> <span class=n>y</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>正确：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=kt>int</span> <span class=nf>divide</span><span class=p>(</span><span class=kt>int</span> <span class=n>x</span><span class=p>,</span> <span class=kt>int</span> <span class=n>y</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>y</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>throw</span> <span class=n>DivideByZero</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>x</span> <span class=o>/</span> <span class=n>y</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>关联漏洞:</p><p><code>低风险-拒绝服务</code></p><p><a id=1.7.5></a></p><h4 id=75-必须防止数字类型的错误强转>7.5 【必须】防止数字类型的错误强转</h4><p>在有符号和无符号数字参与的运算中，需要注意类型强转可能导致的逻辑错误，建议指定参与计算时数字的类型或者统一类型参与计算。</p><p>错误例子</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=kt>int</span> <span class=nf>Foo</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>len</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>size</span> <span class=o>=</span> <span class=mi>9</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 1 &lt; 9 - 10 ? 由于运算中无符号和有符号混用，导致计算结果以无符号计算
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=n>len</span> <span class=o>&lt;</span> <span class=n>size</span> <span class=o>-</span> <span class=mi>10</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;Bad</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;Good</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>正确例子</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=kt>void</span> <span class=nf>Foo</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 统一两者计算类型为有符号
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>int</span> <span class=n>len</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>size</span> <span class=o>=</span> <span class=mi>9</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>len</span> <span class=o>&lt;</span> <span class=n>size</span> <span class=o>-</span> <span class=mi>10</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;Bad</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;Good</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>关联漏洞:</p><p><code>高风险-内存破坏</code></p><p><code>中风险-逻辑漏洞</code></p><p><a id=1.7.6></a></p><h4 id=76-必须比较数据大小时加上最小最大值的校验>7.6 【必须】比较数据大小时加上最小/最大值的校验</h4><p>在进行数据大小比较时，要合理地校验数据的区间范围，建议根据数字类型，对其进行最大和最小值的判断，以防止非预期错误。</p><p>错误：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=kt>void</span> <span class=nf>Foo</span><span class=p>(</span><span class=kt>int</span> <span class=n>index</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>a</span><span class=p>[</span><span class=mi>30</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span><span class=mi>0</span><span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 此处index是int型，只考虑了index小于数组大小，但是并未判断是否大于等于0
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=n>index</span> <span class=o>&lt;</span> <span class=mi>30</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 如果index为负数，则越界
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>a</span><span class=p>[</span><span class=n>index</span><span class=p>]</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>正确：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=kt>void</span> <span class=nf>Foo</span><span class=p>(</span><span class=kt>int</span> <span class=n>index</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>a</span><span class=p>[</span><span class=mi>30</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span><span class=mi>0</span><span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 判断index的最大最小值
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=n>index</span> <span class=o>&gt;=</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=n>index</span> <span class=o>&lt;</span> <span class=mi>30</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>a</span><span class=p>[</span><span class=n>index</span><span class=p>]</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>关联漏洞:</p><p><code>高风险-内存破坏</code></p><p><a id=1.8></a></p><h3 id=8----指针操作>8 指针操作</h3><p><a id=1.8.1></a></p><h4 id=81-建议检查在pointer上使用sizeof>8.1 【建议】检查在pointer上使用sizeof</h4><p>除了测试当前指针长度，否则一般不会在pointer上使用sizeof。</p><p>正确：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=n>size_t</span> <span class=n>pointer_length</span> <span class=o>=</span> <span class=k>sizeof</span><span class=p>(</span><span class=kt>void</span><span class=o>*</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>可能错误：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=n>size_t</span> <span class=n>structure_length</span> <span class=o>=</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>Foo</span><span class=o>*</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>可能是：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=n>size_t</span> <span class=n>structure_length</span> <span class=o>=</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>Foo</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>关联漏洞:</p><p><code>中风险-逻辑漏洞</code></p><p><a id=1.8.2></a></p><h4 id=82-必须检查直接将数组和0比较的代码>8.2 【必须】检查直接将数组和0比较的代码</h4><p>错误：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=kt>int</span> <span class=n>a</span><span class=p>[</span><span class=mi>3</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=p>...;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=n>a</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>...;</span>
</span></span></code></pre></td></tr></table></div></div><p>该判断永远为真，等价于:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=kt>int</span> <span class=n>a</span><span class=p>[</span><span class=mi>3</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=p>...;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=o>&amp;</span><span class=n>a</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
</span></span><span class=line><span class=cl>  <span class=p>...;</span>
</span></span></code></pre></td></tr></table></div></div><p>可能是：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=kt>int</span> <span class=n>a</span><span class=p>[</span><span class=mi>3</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=p>...;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span><span class=p>(</span><span class=n>a</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>...;</span>
</span></span></code></pre></td></tr></table></div></div><p>开启足够的编译器警告（GCC 中为 <code>-Waddress</code>，并已包含在 <code>-Wall</code> 中），并设置为错误，可以在编译期间发现该问题。</p><p>关联漏洞:</p><p><code>中风险-逻辑漏洞</code></p><p><a id=1.8.3></a></p><h4 id=83-必须不应当向指针赋予写死的地址>8.3 【必须】不应当向指针赋予写死的地址</h4><p>特殊情况需要特殊对待（比如开发硬件固件时可能需要写死）</p><p>但是如果是系统驱动开发之类的，写死可能会导致后续的问题。</p><p>关联漏洞:</p><p><code>高风险-内存破坏</code></p><p><a id=1.8.4></a></p><h4 id=84-必须检查空指针>8.4 【必须】检查空指针</h4><p>错误：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=o>*</span><span class=n>foo</span> <span class=o>=</span> <span class=mi>100</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>foo</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>ERROR</span><span class=p>(</span><span class=s>&#34;foobar&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>正确：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>foo</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>ERROR</span><span class=p>(</span><span class=s>&#34;foobar&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>*</span><span class=n>foo</span> <span class=o>=</span> <span class=mi>100</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>错误：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=kt>void</span> <span class=nf>Foo</span><span class=p>(</span><span class=kt>char</span><span class=o>*</span> <span class=n>bar</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=o>*</span><span class=n>bar</span> <span class=o>=</span> <span class=sc>&#39;\0&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>正确：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=kt>void</span> <span class=nf>Foo</span><span class=p>(</span><span class=kt>char</span><span class=o>*</span> <span class=n>bar</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span><span class=p>(</span><span class=n>bar</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>*</span><span class=n>bar</span> <span class=o>=</span> <span class=sc>&#39;\0&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=p>...;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>关联漏洞:</p><p><code>低风险-拒绝服务</code></p><p><a id=1.8.5></a></p><h4 id=85-必须释放完后置空指针>8.5 【必须】释放完后置空指针</h4><p>在对指针进行释放后，需要将该指针设置为NULL，以防止后续free指针的误用，导致UAF等其他内存破坏问题。尤其是在结构体、类里面存储的原始指针。</p><p>错误：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=kt>void</span> <span class=nf>foo</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span><span class=o>*</span> <span class=n>p</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span><span class=o>*</span><span class=p>)</span><span class=n>malloc</span><span class=p>(</span><span class=mi>100</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>memcpy</span><span class=p>(</span><span class=n>p</span><span class=p>,</span> <span class=s>&#34;hello&#34;</span><span class=p>,</span> <span class=mi>6</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>printf</span><span class=p>(</span><span class=s>&#34;%s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>p</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>free</span><span class=p>(</span><span class=n>p</span><span class=p>);</span> <span class=c1>// 此时p所指向的内存已被释放，但是p所指的地址仍然不变
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// 未设置为NULL，可能导致UAF等内存错误
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>p</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span> <span class=p>{</span>  <span class=c1>// 没有起到防错作用
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;%s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>p</span><span class=p>);</span> <span class=c1>// 错误使用已经释放的内存
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>正确：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=kt>void</span> <span class=nf>foo</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span><span class=o>*</span> <span class=n>p</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span><span class=o>*</span><span class=p>)</span><span class=n>malloc</span><span class=p>(</span><span class=mi>100</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>memcpy</span><span class=p>(</span><span class=n>p</span><span class=p>,</span> <span class=s>&#34;hello&#34;</span><span class=p>,</span> <span class=mi>6</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 此时p所指向的内存已被释放，但是p所指的地址仍然不变
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>printf</span><span class=p>(</span><span class=s>&#34;%s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>p</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>free</span><span class=p>(</span><span class=n>p</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>//释放后将指针赋值为空
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>p</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>p</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span>  <span class=p>{</span> <span class=c1>// 没有起到防错作用
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;%s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>p</span><span class=p>);</span> <span class=c1>// 错误使用已经释放的内存
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>对于 C++ 代码，使用 string、vector、智能指针等代替原始内存管理机制，可以大量减少这类错误。</p><p>关联漏洞:</p><p><code>高风险-内存破坏</code></p><p><a id=1.8.6></a></p><h4 id=86-必须防止错误的类型转换type-confusion>8.6 【必须】防止错误的类型转换（type confusion）</h4><p>在对指针、对象或变量进行操作时，需要能够正确判断所操作对象的原始类型。如果使用了与原始类型不兼容的类型进行访问，则存在安全隐患。</p><p>错误：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=k>const</span> <span class=kt>int</span> <span class=n>NAME_TYPE</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=kt>int</span> <span class=n>ID_TYPE</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 该类型根据 msg_type 进行区分，如果在对MessageBuffer进行操作时没有判断目标对象，则存在类型混淆
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>struct</span> <span class=nc>MessageBuffer</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>msg_type</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>union</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>name_id</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>Foo</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=nc>MessageBuffer</span> <span class=n>buf</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>default_message</span> <span class=o>=</span> <span class=s>&#34;Hello World&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 设置该消息类型为 NAME_TYPE，因此buf预期的类型为 msg_type + name
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>buf</span><span class=p>.</span><span class=n>msg_type</span> <span class=o>=</span> <span class=n>NAME_TYPE</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>buf</span><span class=p>.</span><span class=n>name</span> <span class=o>=</span> <span class=n>default_message</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>printf</span><span class=p>(</span><span class=s>&#34;Pointer of buf.name is %p</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>buf</span><span class=p>.</span><span class=n>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 没有判断目标消息类型是否为ID_TYPE，直接修改nameID，导致类型混淆
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>buf</span><span class=p>.</span><span class=n>name_id</span> <span class=o>=</span> <span class=n>user_controlled_value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>buf</span><span class=p>.</span><span class=n>msg_type</span> <span class=o>==</span> <span class=n>NAME_TYPE</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;Pointer of buf.name is now %p</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>buf</span><span class=p>.</span><span class=n>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 以NAME_TYPE作为类型操作，可能导致非法内存读写
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;Message: %s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>buf</span><span class=p>.</span><span class=n>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;Message: Use ID %d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>buf</span><span class=p>.</span><span class=n>name_id</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>正确（判断操作的目标是否是预期类型）：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=kt>void</span> <span class=nf>Foo</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=nc>MessageBuffer</span> <span class=n>buf</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>default_message</span> <span class=o>=</span> <span class=s>&#34;Hello World&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 设置该消息类型为 NAME_TYPE，因此buf预期的类型为 msg_type + name
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>buf</span><span class=p>.</span><span class=n>msg_type</span> <span class=o>=</span> <span class=n>NAME_TYPE</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>buf</span><span class=p>.</span><span class=n>name</span> <span class=o>=</span> <span class=n>default_msessage</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>printf</span><span class=p>(</span><span class=s>&#34;Pointer of buf.name is %p</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>buf</span><span class=p>.</span><span class=n>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 判断目标消息类型是否为 ID_TYPE，不是预期类型则做对应操作
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=n>buf</span><span class=p>.</span><span class=n>msg_type</span> <span class=o>==</span> <span class=n>ID_TYPE</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>buf</span><span class=p>.</span><span class=n>name_id</span> <span class=o>=</span> <span class=n>user_controlled_value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>buf</span><span class=p>.</span><span class=n>msg_type</span> <span class=o>==</span> <span class=n>NAME_TYPE</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;Pointer of buf.name is now %p</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>buf</span><span class=p>.</span><span class=n>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;Message: %s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>buf</span><span class=p>.</span><span class=n>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;Message: Use ID %d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>buf</span><span class=p>.</span><span class=n>name_id</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>关联漏洞:</p><p><code>高风险-内存破坏</code></p><p><a id=1.8.7></a></p><h4 id=87-必须智能指针使用安全>8.7 【必须】智能指针使用安全</h4><p>在使用智能指针时，防止其和原始指针的混用，否则可能导致对象生命周期问题，例如 UAF 等安全风险。</p><p>错误例子：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=k>class</span> <span class=nc>Foo</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=k>public</span><span class=o>:</span>
</span></span><span class=line><span class=cl>  <span class=k>explicit</span> <span class=n>Foo</span><span class=p>(</span><span class=kt>int</span> <span class=n>num</span><span class=p>)</span> <span class=p>{</span> <span class=n>data_</span> <span class=o>=</span> <span class=n>num</span><span class=p>;</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>Function</span><span class=p>()</span> <span class=p>{</span> <span class=n>printf</span><span class=p>(</span><span class=s>&#34;Obj is %p, data = %d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=k>this</span><span class=p>,</span> <span class=n>data_</span><span class=p>);</span> <span class=p>};</span>
</span></span><span class=line><span class=cl> <span class=k>private</span><span class=o>:</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>data_</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>std</span><span class=o>::</span><span class=n>unique_ptr</span><span class=o>&lt;</span><span class=n>Foo</span><span class=o>&gt;</span> <span class=n>fool_u_ptr</span> <span class=o>=</span> <span class=k>nullptr</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>Foo</span><span class=o>*</span> <span class=n>pfool_raw_ptr</span> <span class=o>=</span> <span class=k>nullptr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>Risk</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>fool_u_ptr</span> <span class=o>=</span> <span class=n>make_unique</span><span class=o>&lt;</span><span class=n>Foo</span><span class=o>&gt;</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 从独占智能指针中获取原始指针,&lt;Foo&gt;(1)
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>pfool_raw_ptr</span> <span class=o>=</span> <span class=n>fool_u_ptr</span><span class=p>.</span><span class=n>get</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 调用&lt;Foo&gt;(1)的函数
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>pfool_raw_ptr</span><span class=o>-&gt;</span><span class=n>Function</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 独占智能指针重新赋值后会释放内存
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>fool_u_ptr</span> <span class=o>=</span> <span class=n>make_unique</span><span class=o>&lt;</span><span class=n>Foo</span><span class=o>&gt;</span><span class=p>(</span><span class=mi>2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 通过原始指针操作会导致UAF，pfool_raw_ptr指向的对象已经释放
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>pfool_raw_ptr</span><span class=o>-&gt;</span><span class=n>Function</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 输出：
</span></span></span><span class=line><span class=cl><span class=c1>// Obj is 0000027943087B80, data = 1
</span></span></span><span class=line><span class=cl><span class=c1>// Obj is 0000027943087B80, data = -572662307
</span></span></span></code></pre></td></tr></table></div></div><p>正确，通过智能指针操作:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=kt>void</span> <span class=nf>Safe</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>fool_u_ptr</span> <span class=o>=</span> <span class=n>make_unique</span><span class=o>&lt;</span><span class=n>Foo</span><span class=o>&gt;</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 调用&lt;Foo&gt;(1)的函数
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>fool_u_ptr</span><span class=o>-&gt;</span><span class=n>Function</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>fool_u_ptr</span> <span class=o>=</span> <span class=n>make_unique</span><span class=o>&lt;</span><span class=n>Foo</span><span class=o>&gt;</span><span class=p>(</span><span class=mi>2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 调用&lt;Foo&gt;(2)的函数
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>fool_u_ptr</span><span class=o>-&gt;</span><span class=n>Function</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 输出：
</span></span></span><span class=line><span class=cl><span class=c1>// Obj is 000002C7BB550830, data = 1
</span></span></span><span class=line><span class=cl><span class=c1>// Obj is 000002C7BB557AF0, data = 2
</span></span></span></code></pre></td></tr></table></div></div><p>关联漏洞:</p><p><code>高风险-内存破坏</code></p></div><div class=post-footer id=post-footer><div class=orlike-box></div><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2021-08-19</span></div><div class=post-info-license><span><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></div><div class=post-info-more><section><i class="fas fa-fw fa-th"></i>&nbsp;<a href=/categories/cpp/>Cpp</a></section><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/cpp/>Cpp</a>,&nbsp;<a href=/tags/c/>C</a></section></div><div class=post-nav><a href=/202108/sicp-python-read1/ class=prev rel=prev title="《UCB CS61a SICP Python 中文》一周目笔记(一)"><i class="fas fa-angle-left fa-fw"></i>《UCB CS61a SICP Python 中文》一周目笔记(一)</a>
<a href=/202108/sicp-python-read2/ class=next rel=next title="《UCB CS61a SICP Python 中文》一周目笔记(二)">《UCB CS61a SICP Python 中文》一周目笔记(二)<i class="fas fa-angle-right fa-fw"></i></a></div></div><div id=my-random-posts><div class=loadingThree><span></span>
<span></span>
<span></span>
<span></span>
<span></span></div></div><div id=comments><div id=giscus class=comment></div><script src=https://giscus.app/client.js data-repo=caibingcheng/comment data-repo-id=R_kgDOHgda4w data-category=Announcements data-category-id=DIC_kwDOHgda484CTfDe data-mapping=og:title data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=/css/giscus.css data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script><noscript>Please enable JavaScript to view the comments powered by <a href=https://giscus.app/>giscus</a>.</noscript></div></article></div></main><footer class=footer><hr style=opacity:.2><div class=footer-container><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2020 - 2024</span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span><span class=icp-splitter>&nbsp;|&nbsp;</span><br class=icp-br><span class=icp><a href="https://icp.gov.moe/?keyword=20222231" target=_blank>萌ICP备20222231号</a></span></div><div class=footer-line><a href=https://wiki.imcbc.cn target=_blank rel=noopener title="Bing's Wiki">Wiki</a>
&nbsp;|&nbsp;
<a href=https://rssblog.cn target=_blank rel=noopener title=RSSBlog>RSSBlog</a>
&nbsp;|&nbsp;
<a href=https://travellings.link target=_blank rel=noopener title=开往-友链接力>开往-友链接力</a>
&nbsp;|&nbsp;
<a href=https://www.foreverblog.cn/go.html target=_blank>穿梭虫洞</a></div><div class=footer-line><script>var build_date="2024-03-05T21:35:50+08:00"</script>已运行
<span id=run-time></span>
&nbsp;|&nbsp;
构建于
<span id=build-time></span>&nbsp;前</div><div class=footer-line><script async src=https://npm.elemecdn.com/penndu@1.0.0/bsz.js></script>
共计
<span id=busuanzi_value_site_uv></span>&nbsp;访客
&nbsp;|&nbsp;
<span id=busuanzi_value_site_pv></span>&nbsp;访问
&nbsp;|&nbsp;
256K&nbsp;字</div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw"></i>
</a><a id=reader-button class=fixed-button title=阅读模式><i class="fa fa-book fa-fw"></i></a></div><link rel=stylesheet href=https://fastly.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/css/lightgallery.min.css><link rel=stylesheet href=https://fastly.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css><link rel=stylesheet href=https://fastly.jsdelivr.net/npm/katex@0.11.1/dist/contrib/copy-tex.min.css><script type=text/javascript src=https://cdn.staticfile.org/jquery/3.6.0/jquery.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/npm/autocomplete.js@0.37.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/npm/algoliasearch@4.2.0/dist/algoliasearch-lite.umd.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/js/lightgallery.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/npm/lg-thumbnail.js@1.2.0/dist/lg-thumbnail.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/npm/lg-zoom.js@1.2.0/dist/lg-zoom.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/npm/katex@0.11.1/dist/contrib/copy-tex.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/npm/katex@0.11.1/dist/contrib/mhchem.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/gh/Albejr/jquery-albe-timeline/jquery-albe-timeline.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/gh/caibingcheng/orlike@client/orlike.min.js></script><script type=text/javascript src=/js/custom.js></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:50},comment:{},lightGallery:{actualSize:!1,exThumbImage:"data-thumbnail",hideBarsDelay:2e3,selector:".lightgallery",speed:400,thumbContHeight:80,thumbWidth:80,thumbnail:!0},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{algoliaAppID:"JMTHQS1VUU",algoliaIndex:"blog-bbing",algoliaSearchKey:"0dd43732743475449c844c0d0f21366a",highlightTag:"em",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:50,type:"algolia"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>