<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>glibc-read/write源码阅读 - Bing's Blog</title><meta name=keywords content="[Life bbing bing hugo Blog C++ LoveIt]"><meta name=Description content="个人技术博客"><meta property="og:title" content="glibc-read/write源码阅读"><meta property="og:description" content="Linux文件系统可以分为两层，虚拟文件系统(VFS)和驱动。VFS主要和驱动对接，以实现对不同文件系统的适配和管理。本文阅读的read/write函数是VFS层面的，源码如下：https://codebrowser.dev/linux/linux/fs/read_write.c.html"><meta property="og:type" content="article"><meta property="og:url" content="https://imcbc.cn/202301/glibc-read-write/"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/caibingcheng/resources@main/images/13bOkrO.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-01-08T09:40:09+08:00"><meta property="article:modified_time" content="2023-01-08T09:40:09+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://cdn.jsdelivr.net/gh/caibingcheng/resources@main/images/13bOkrO.png"><meta name=twitter:title content="glibc-read/write源码阅读"><meta name=twitter:description content="Linux文件系统可以分为两层，虚拟文件系统(VFS)和驱动。VFS主要和驱动对接，以实现对不同文件系统的适配和管理。本文阅读的read/write函数是VFS层面的，源码如下：https://codebrowser.dev/linux/linux/fs/read_write.c.html"><meta name=application-name content="Bing's Blog"><meta name=apple-mobile-web-app-title content="Bing's Blog"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://imcbc.cn/202301/glibc-read-write/><link rel=prev href=https://imcbc.cn/202212/2022-summary/><link rel=next href=https://imcbc.cn/202301/robomaster-experience/><link rel=stylesheet href=https://fastly.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=https://fastly.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.0/css/all.min.css><link rel=stylesheet href=https://fastly.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css><link rel=stylesheet href=https://fastly.jsdelivr.net/gh/Albejr/jquery-albe-timeline/templates/simple/style-albe-timeline.css><link rel=stylesheet href=https://fastly.jsdelivr.net/gh/caibingcheng/orlike@client/orlike.min.css><link rel=stylesheet href=/css/custom.css><meta name=google-site-verification content="xy1bCgQPV_H3_o2XD34o2mIByQxmzkV3GPOfhXg_mTM"><meta name=msvalidate.01 content="c81a65b6344571786df543a56c7bbe18"><meta name=baidu-site-verification content="code-WcyzWjgFYo"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"glibc-read/write源码阅读","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/imcbc.cn\/202301\/glibc-read-write\/"},"image":["https:\/\/imcbc.cn\/android-chrome-192x192.png"],"genre":"posts","keywords":"Linux, glibc","wordcount":2842,"url":"https:\/\/imcbc.cn\/202301\/glibc-read-write\/","datePublished":"2023-01-08T09:40:09+08:00","dateModified":"2023-01-08T09:40:09+08:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"Bing","logo":"https:\/\/imcbc.cn\/android-chrome-192x192.png"},"author":{"@type":"Person","name":"bbing"},"description":""}</script></head><body header-desktop=normal header-mobile=normal><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><a href=https://github.com/caibingcheng/ class=github-corner aria-label="View source on GitHub"><svg width="3.5rem" height="3.5rem" viewBox="0 0 250 250" style="fill:#151513;color:#fff;position:absolute;top:0;border:0;left:0;transform:scale(-1,1)" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><div class=header-title><a href=/ title="Bing's Blog">Bing's Blog</a></div><div class=menu><div class=menu-inner><div class=dropdown><a href=/posts/ class="menu-item menu-more dropbtn" title><i class='fas fa fa-archive'></i> 归档</a><div class="menu-more-content dropdown-content"><a href=/tags/ title><i class='fas fa fa-tag'></i> 标签 </a><a href=/categories/ title><i class='fas fa fa-th'></i> 分类</a></div></div><a class=menu-item href=/friends/><i class='fas fa fa-users'></i> 友链</a><div class=dropdown><a href=javascript:void(0); class="menu-item menu-more dropbtn" title><i class='fas fa fa-angle-double-down'></i> 更多</a><div class="menu-more-content dropdown-content"><a href=/tools/ title><i class='fas fa fa-cubes'></i> 工具 </a><a href=/about/ title><i class='fas fa fa-address-card'></i> 关于 </a><a href=/timeline/ title><i class='fas fa fa-building'></i> 建站 </a><a href=/index.xml/ title><i class='fas fa fa-rss'></i> RSS</a></div></div><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=搜索文章内容 id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin"></i></span>
</span><a href=https://travellings.link target=_blank class=menu-item rel=noopener title=开往-友链接力><i class='fas fa-fw fa-subway'></i></a>
<a href=https://rssblog.cn/bbing class=menu-item target=_blank rel=noopener title=RSSBlog><i class='fas fa-fw fa-inbox'></i></a>
<a href=https://www.foreverblog.cn/go.html class=menu-item target=_blank rel=noopener title=穿梭虫洞><i class="fas fa-fw fa-life-ring" title=穿梭虫洞-随机访问十年之约友链博客></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Bing's Blog">Bing's Blog</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章内容 id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></div><a href=/posts/ class=menu-item title><i class='fas fa fa-archive'></i> 归档</a>
<a href=/tags/ class=menu-item title><i class='fas fa fa-tag'></i> 标签</a>
<a href=/categories/ class=menu-item title><i class='fas fa fa-th'></i> 分类</a>
<a class=menu-item href=/friends/><i class='fas fa fa-users'></i> 友链</a>
<a href=/tools/ class=menu-item title><i class='fas fa fa-cubes'></i> 工具</a>
<a href=/about/ class=menu-item title><i class='fas fa fa-address-card'></i> 关于</a>
<a href=/timeline/ class=menu-item title><i class='fas fa fa-building'></i> 建站</a>
<a href=/index.xml/ class=menu-item title><i class='fas fa fa-rss'></i> RSS</a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class=single-title>glibc-read/write源码阅读<sup>
<a id=reader-button-title title=阅读模式><i class="fa fa-book fa-fw"></i></a></sup></h1><div class=post-meta><div class=post-meta-line></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2023-01-08>2023-01-08</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 2842 字&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 6 分钟&nbsp;</div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#read>read</a><ul><li><a href=#小结>小结</a></li></ul></li><li><a href=#write>write</a></li></ul></nav></div></div><div class=content id=content><p>Linux文件系统可以分为两层，虚拟文件系统(VFS)和驱动。VFS主要和驱动对接，以实现对不同文件系统的适配和管理。本文阅读的<code>read/write</code>函数是VFS层面的，源码如下：<a href=https://codebrowser.dev/linux/linux/fs/read_write.c.html target=_blank rel="noopener noreffer">https://codebrowser.dev/linux/linux/fs/read_write.c.html</a></p><p>大致结构如下，当然以下所指的设备不一定是真实的物理设备。</p><p><figure><a class=lightgallery href=https://bu.dusays.com/2023/01/08/63ba3fb60141e.png title=VFS-驱动 data-thumbnail=https://bu.dusays.com/2023/01/08/63ba3fb60141e.png data-sub-html="<h2>VFS-驱动</h2><p>VFS-驱动</p>"><img class=lazyload src=/svg/loading.min.svg data-src=https://bu.dusays.com/2023/01/08/63ba3fb60141e.png data-srcset="https://bu.dusays.com/2023/01/08/63ba3fb60141e.png, https://bu.dusays.com/2023/01/08/63ba3fb60141e.png 1.5x, https://bu.dusays.com/2023/01/08/63ba3fb60141e.png 2x" data-sizes=auto alt=https://bu.dusays.com/2023/01/08/63ba3fb60141e.png></a><figcaption class=image-caption>VFS-驱动</figcaption></figure></p><h2 id=read>read</h2><p><code>read</code>的入口如下，输入参数是文件<code>fd</code>、buffer、长度。回顾之前的文章中学习过的，<code>fd</code>是指文件在<code>task_struct</code>中files table的下标，通过<code>fd</code>可以找到<code>struct file</code>，从而拿到inode，获取到文件内容。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=n>SYSCALL_DEFINE3</span><span class=p>(</span><span class=n>read</span><span class=p>,</span> <span class=kt>unsigned</span> <span class=kt>int</span><span class=p>,</span> <span class=n>fd</span><span class=p>,</span> <span class=kt>char</span> <span class=n>__user</span> <span class=o>*</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=n>size_t</span><span class=p>,</span> <span class=n>count</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>ksys_read</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=n>count</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>ksys_read</code>展开如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=n>ssize_t</span> <span class=nf>ksys_read</span><span class=p>(</span><span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>fd</span><span class=p>,</span> <span class=kt>char</span> <span class=n>__user</span> <span class=o>*</span><span class=n>buf</span><span class=p>,</span> <span class=n>size_t</span> <span class=n>count</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>fd</span> <span class=n>f</span> <span class=o>=</span> <span class=n>fdget_pos</span><span class=p>(</span><span class=n>fd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>ssize_t</span> <span class=n>ret</span> <span class=o>=</span> <span class=o>-</span><span class=n>EBADF</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>f</span><span class=p>.</span><span class=n>file</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>loff_t</span> <span class=n>pos</span><span class=p>,</span> <span class=o>*</span><span class=n>ppos</span> <span class=o>=</span> <span class=n>file_ppos</span><span class=p>(</span><span class=n>f</span><span class=p>.</span><span class=n>file</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=n>ppos</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=n>pos</span> <span class=o>=</span> <span class=o>*</span><span class=n>ppos</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=n>ppos</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>pos</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=n>ret</span> <span class=o>=</span> <span class=n>vfs_read</span><span class=p>(</span><span class=n>f</span><span class=p>.</span><span class=n>file</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=n>count</span><span class=p>,</span> <span class=n>ppos</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=n>ret</span> <span class=o>&gt;=</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=n>ppos</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=n>f</span><span class=p>.</span><span class=n>file</span><span class=o>-&gt;</span><span class=n>f_pos</span> <span class=o>=</span> <span class=n>pos</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=n>fdput_pos</span><span class=p>(</span><span class=n>f</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>ret</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>其中，<code>fdget_pos</code>会调用到以下这个函数：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=kt>unsigned</span> <span class=kt>long</span> <span class=nf>__fdget_pos</span><span class=p>(</span><span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>fd</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>v</span> <span class=o>=</span> <span class=n>__fdget</span><span class=p>(</span><span class=n>fd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>file</span> <span class=o>*</span><span class=n>file</span> <span class=o>=</span> <span class=p>(</span><span class=k>struct</span> <span class=n>file</span> <span class=o>*</span><span class=p>)(</span><span class=n>v</span> <span class=o>&amp;</span> <span class=o>~</span><span class=mi>3</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>file</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>file</span><span class=o>-&gt;</span><span class=n>f_mode</span> <span class=o>&amp;</span> <span class=n>FMODE_ATOMIC_POS</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=n>file_count</span><span class=p>(</span><span class=n>file</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=n>v</span> <span class=o>|=</span> <span class=n>FDPUT_POS_UNLOCK</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=n>mutex_lock</span><span class=p>(</span><span class=o>&amp;</span><span class=n>file</span><span class=o>-&gt;</span><span class=n>f_pos_lock</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>v</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>fdput_pos</code>展开如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=k>static</span> <span class=kr>inline</span> <span class=kt>void</span> <span class=nf>fdput_pos</span><span class=p>(</span><span class=k>struct</span> <span class=n>fd</span> <span class=n>f</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>f</span><span class=p>.</span><span class=n>flags</span> <span class=o>&amp;</span> <span class=n>FDPUT_POS_UNLOCK</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>__f_unlock_pos</span><span class=p>(</span><span class=n>f</span><span class=p>.</span><span class=n>file</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>fdput</span><span class=p>(</span><span class=n>f</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>如果文件被标记了<code>FMODE_ATOMIC_POS</code>，并且有多线程使用，那么<code>f_pos</code>会被加锁保护（认为是原子操作了）。在最后<code>fdput_pos</code>的时候则会对应解锁。注意到<code>struct file *file = (struct file *)(v & ~3);</code>这在<a href=/202211/tagged-pointer/ rel>tagged-pointer-让指针包含更多信息</a>一文是介绍过的。</p><p>再回<code>ksys_read</code>到先是通过<code>unsigned int fd</code>拿到<code>struct fd</code>，其定义如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=k>struct</span> <span class=n>fd</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>file</span> <span class=o>*</span><span class=n>file</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>flags</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><p>这时候可以拿到<code>struct file</code>了，回顾一下其中重要的成员有：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=k>struct</span> <span class=n>file</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>path</span>			<span class=n>f_path</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>inode</span>		<span class=o>*</span><span class=n>f_inode</span><span class=p>;</span>	<span class=cm>/* cached value */</span>
</span></span><span class=line><span class=cl>	<span class=k>const</span> <span class=k>struct</span> <span class=n>file_operations</span>	<span class=o>*</span><span class=n>f_op</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=c1>//...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>path</code>包含dentry、mnt信息，<code>inode</code>可以指向物理设备中的信息，<code>file_operations</code>保护一组操作表。</p><p><code>ksys_read</code>接下来会尝试获取文件的pos（这里是读位置）信息：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=n>loff_t</span> <span class=n>pos</span><span class=p>,</span> <span class=o>*</span><span class=n>ppos</span> <span class=o>=</span> <span class=n>file_ppos</span><span class=p>(</span><span class=n>f</span><span class=p>.</span><span class=n>file</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p><code>file_ppos</code>的返回值被赋给了<code>long long*</code>，为什么是一个指针？展开<code>file_ppos</code>看看：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=cm>/* file_ppos returns &amp;file-&gt;f_pos or NULL if file is stream */</span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kr>inline</span> <span class=n>loff_t</span> <span class=o>*</span><span class=nf>file_ppos</span><span class=p>(</span><span class=k>struct</span> <span class=n>file</span> <span class=o>*</span><span class=n>file</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>file</span><span class=o>-&gt;</span><span class=n>f_mode</span> <span class=o>&amp;</span> <span class=n>FMODE_STREAM</span> <span class=o>?</span> <span class=nb>NULL</span> <span class=o>:</span> <span class=o>&amp;</span><span class=n>file</span><span class=o>-&gt;</span><span class=n>f_pos</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>如果不是file stream的情况下，会返回<code>struct file</code>成员<code>f_pos</code>的地址。为什么要返回一个地址，而不是值呢？关注这段逻辑：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=n>ppos</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>pos</span> <span class=o>=</span> <span class=o>*</span><span class=n>ppos</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>ppos</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>pos</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>ppos</code>是指针，<code>ppos</code>本来是指向<code>struct file</code>的<code>f_pos</code>成员，上述逻辑走完后，<code>ppos</code>指向了一个临时的<code>pos</code>，这时候<code>f_pos</code>相当于被保护起来了。上述说法说得通，但是为什么不直接赋值给<code>po</code>s，这样也不会影响<code>f_pos</code>呀？回到<code>file_ppos</code>，因为对file stream的情况需要返回<code>NULL</code>，如果直接赋值给<code>pos</code>再处理这种<code>NULL</code>情况的话，事情也不会变得更简单，因此引入一个<code>ppos</code>是合理的。</p><p>再往下看：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=n>ret</span> <span class=o>=</span> <span class=n>vfs_read</span><span class=p>(</span><span class=n>f</span><span class=p>.</span><span class=n>file</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=n>count</span><span class=p>,</span> <span class=n>ppos</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=n>ret</span> <span class=o>&gt;=</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=n>ppos</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=n>f</span><span class=p>.</span><span class=n>file</span><span class=o>-&gt;</span><span class=n>f_pos</span> <span class=o>=</span> <span class=n>pos</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>fdput_pos</span><span class=p>(</span><span class=n>f</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>这段逻辑也可以说<code>ppos</code>起到了保护作用，在<code>vfs_read</code>之后，如果成功了，则会更新<code>f_pos</code>的值，如果失败也就不会更新了。这样做是可以保证失败的时候不会动<code>f_pos</code>，但是如果是多线程情况，且没有<code>FMODE_ATOMIC_POS</code>标记，<code>f_pos</code>的值不是乱套了吗？先进去<code>vfs_read</code>看看：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=n>ssize_t</span> <span class=nf>vfs_read</span><span class=p>(</span><span class=k>struct</span> <span class=n>file</span> <span class=o>*</span><span class=n>file</span><span class=p>,</span> <span class=kt>char</span> <span class=n>__user</span> <span class=o>*</span><span class=n>buf</span><span class=p>,</span> <span class=n>size_t</span> <span class=n>count</span><span class=p>,</span> <span class=n>loff_t</span> <span class=o>*</span><span class=n>pos</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>//... 校验 ...
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=p>(</span><span class=n>count</span> <span class=o>&gt;</span> <span class=n>MAX_RW_COUNT</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>count</span> <span class=o>=</span>  <span class=n>MAX_RW_COUNT</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>file</span><span class=o>-&gt;</span><span class=n>f_op</span><span class=o>-&gt;</span><span class=n>read</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>ret</span> <span class=o>=</span> <span class=n>file</span><span class=o>-&gt;</span><span class=n>f_op</span><span class=o>-&gt;</span><span class=n>read</span><span class=p>(</span><span class=n>file</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=n>count</span><span class=p>,</span> <span class=n>pos</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>file</span><span class=o>-&gt;</span><span class=n>f_op</span><span class=o>-&gt;</span><span class=n>read_iter</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>ret</span> <span class=o>=</span> <span class=n>new_sync_read</span><span class=p>(</span><span class=n>file</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=n>count</span><span class=p>,</span> <span class=n>pos</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>else</span>
</span></span><span class=line><span class=cl>		<span class=n>ret</span> <span class=o>=</span> <span class=o>-</span><span class=n>EINVAL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>ret</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>fsnotify_access</span><span class=p>(</span><span class=n>file</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=n>add_rchar</span><span class=p>(</span><span class=n>current</span><span class=p>,</span> <span class=n>ret</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=n>inc_syscr</span><span class=p>(</span><span class=n>current</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>ret</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>如果驱动实现了<code>read</code>接口，那么就调用<code>read</code>接口，这里依赖驱动实现，就先跳过了；如果驱动没有实现<code>read</code>，而是实现<code>read_iter</code>，那么就是调用<code>new_sync_read</code>，进去看看：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=k>static</span> <span class=n>ssize_t</span> <span class=nf>new_sync_read</span><span class=p>(</span><span class=k>struct</span> <span class=n>file</span> <span class=o>*</span><span class=n>filp</span><span class=p>,</span> <span class=kt>char</span> <span class=n>__user</span> <span class=o>*</span><span class=n>buf</span><span class=p>,</span> <span class=n>size_t</span> <span class=n>len</span><span class=p>,</span> <span class=n>loff_t</span> <span class=o>*</span><span class=n>ppos</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>kiocb</span> <span class=n>kiocb</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>iov_iter</span> <span class=n>iter</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>ssize_t</span> <span class=n>ret</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>init_sync_kiocb</span><span class=p>(</span><span class=o>&amp;</span><span class=n>kiocb</span><span class=p>,</span> <span class=n>filp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>kiocb</span><span class=p>.</span><span class=n>ki_pos</span> <span class=o>=</span> <span class=p>(</span><span class=n>ppos</span> <span class=o>?</span> <span class=o>*</span><span class=nl>ppos</span> <span class=p>:</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>iov_iter_ubuf</span><span class=p>(</span><span class=o>&amp;</span><span class=n>iter</span><span class=p>,</span> <span class=n>READ</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=n>len</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>ret</span> <span class=o>=</span> <span class=n>call_read_iter</span><span class=p>(</span><span class=n>filp</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>kiocb</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>iter</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>BUG_ON</span><span class=p>(</span><span class=n>ret</span> <span class=o>==</span> <span class=o>-</span><span class=n>EIOCBQUEUED</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>ppos</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=o>*</span><span class=n>ppos</span> <span class=o>=</span> <span class=n>kiocb</span><span class=p>.</span><span class=n>ki_pos</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>ret</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这里遇到了之前没有接触过的结构体（概念）<code>struct kiocb</code>和<code>struct iov_iter</code>，定义如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=k>struct</span> <span class=n>kiocb</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>file</span>		<span class=o>*</span><span class=n>ki_filp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>loff_t</span>			<span class=n>ki_pos</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>void</span> <span class=p>(</span><span class=o>*</span><span class=n>ki_complete</span><span class=p>)(</span><span class=k>struct</span> <span class=n>kiocb</span> <span class=o>*</span><span class=n>iocb</span><span class=p>,</span> <span class=kt>long</span> <span class=n>ret</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=kt>void</span>			<span class=o>*</span><span class=n>private</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span>			<span class=n>ki_flags</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>u16</span>			<span class=n>ki_ioprio</span><span class=p>;</span> <span class=cm>/* See linux/ioprio.h */</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>wait_page_queue</span>	<span class=o>*</span><span class=n>ki_waitq</span><span class=p>;</span> <span class=cm>/* for async buffered IO */</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=n>iov_iter</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>u8</span> <span class=n>iter_type</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>bool</span> <span class=n>nofault</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>bool</span> <span class=n>data_source</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>bool</span> <span class=n>user_backed</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>union</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>size_t</span> <span class=n>iov_offset</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=kt>int</span> <span class=n>last_offset</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>};</span>
</span></span><span class=line><span class=cl>	<span class=n>size_t</span> <span class=n>count</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>union</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>const</span> <span class=k>struct</span> <span class=n>iovec</span> <span class=o>*</span><span class=n>iov</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=k>const</span> <span class=k>struct</span> <span class=n>kvec</span> <span class=o>*</span><span class=n>kvec</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=k>const</span> <span class=k>struct</span> <span class=n>bio_vec</span> <span class=o>*</span><span class=n>bvec</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=k>struct</span> <span class=n>xarray</span> <span class=o>*</span><span class=n>xarray</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=k>struct</span> <span class=n>pipe_inode_info</span> <span class=o>*</span><span class=n>pipe</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=kt>void</span> <span class=n>__user</span> <span class=o>*</span><span class=n>ubuf</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>};</span>
</span></span><span class=line><span class=cl>	<span class=k>union</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>nr_segs</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=k>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>head</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>start_head</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=p>};</span>
</span></span><span class=line><span class=cl>		<span class=n>loff_t</span> <span class=n>xarray_start</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><p>这两个结构体可以获取什么信息呢？一个是<code>struct kiocb</code>扩展了<code>struct file</code>的一些信息，一个是<code>struct iov_iter</code>包含用户需要填充的buffer信息。（关于这两个概念先不深挖了，这里是我的知识盲区，似乎涉及到VFS更下面的东西。）经过<code>init_sync_kiocb</code>和<code>iov_iter_ubuf</code>的填充，就会调用到<code>call_read_iter</code>。不过还要注意到<code>ppos</code>是会被更新的。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=k>static</span> <span class=kr>inline</span> <span class=n>ssize_t</span> <span class=nf>call_read_iter</span><span class=p>(</span><span class=k>struct</span> <span class=n>file</span> <span class=o>*</span><span class=n>file</span><span class=p>,</span> <span class=k>struct</span> <span class=n>kiocb</span> <span class=o>*</span><span class=n>kio</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				     <span class=k>struct</span> <span class=n>iov_iter</span> <span class=o>*</span><span class=n>iter</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>file</span><span class=o>-&gt;</span><span class=n>f_op</span><span class=o>-&gt;</span><span class=n>read_iter</span><span class=p>(</span><span class=n>kio</span><span class=p>,</span> <span class=n>iter</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>回到<code>vfs_read</code>的最后，read完之后，就是通过<code>fsnotify_access</code>发送一个access fsnotify。</p><h3 id=小结>小结</h3><p>以上就是VFS这一层<code>read</code>的大致逻辑。大致流程就是先通过fd获取到<code>struct file</code>（这就是为什么<code>read</code>之前要先<code>open</code>），然后再获取当前的read指针位置，然后调用驱动的<code>read/read_iter</code>方法，如果读取成功则发送access fsnotify，最后把read指针更新后的位置回写给<code>struct file</code>。</p><p>上文还遗留一个问题，如果多线程读怎么办？可以假设驱动层的<code>read/read_iter</code>是原子的（那是驱动的事情），但是glibc的<code>read</code>默认是没有保护的，所以可能存在一些不安全的情况，比如<code>f_pos</code>的更新没有被保护，就可能导致多线程读错位。</p><p>关于多线程读的问题，可以再参考<code>fread</code>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=n>size_t</span>
</span></span><span class=line><span class=cl><span class=nf>_IO_fread</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=n>buf</span><span class=p>,</span> <span class=n>size_t</span> <span class=n>size</span><span class=p>,</span> <span class=n>size_t</span> <span class=n>count</span><span class=p>,</span> <span class=n>FILE</span> <span class=o>*</span><span class=n>fp</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>size_t</span> <span class=n>bytes_requested</span> <span class=o>=</span> <span class=n>size</span> <span class=o>*</span> <span class=n>count</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>size_t</span> <span class=n>bytes_read</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>CHECK_FILE</span> <span class=p>(</span><span class=n>fp</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>bytes_requested</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>_IO_acquire_lock</span> <span class=p>(</span><span class=n>fp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>bytes_read</span> <span class=o>=</span> <span class=n>_IO_sgetn</span> <span class=p>(</span><span class=n>fp</span><span class=p>,</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span> <span class=n>buf</span><span class=p>,</span> <span class=n>bytes_requested</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>_IO_release_lock</span> <span class=p>(</span><span class=n>fp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>bytes_requested</span> <span class=o>==</span> <span class=n>bytes_read</span> <span class=o>?</span> <span class=nl>count</span> <span class=p>:</span> <span class=n>bytes_read</span> <span class=o>/</span> <span class=n>size</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到，因为<code>_IO_acquire_lock</code>和<code>_IO_release_lock</code>，这是可以保证<code>fread</code>默认情况下就是线程安全的。</p><h2 id=write>write</h2><p><code>write</code>流程和<code>read</code>类似的，区别在<code>vfs_write</code>的实现：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=n>ssize_t</span> <span class=nf>vfs_write</span><span class=p>(</span><span class=k>struct</span> <span class=n>file</span> <span class=o>*</span><span class=n>file</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span> <span class=n>__user</span> <span class=o>*</span><span class=n>buf</span><span class=p>,</span> <span class=n>size_t</span> <span class=n>count</span><span class=p>,</span> <span class=n>loff_t</span> <span class=o>*</span><span class=n>pos</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// ... 校验 ...
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=n>file_start_write</span><span class=p>(</span><span class=n>file</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>file</span><span class=o>-&gt;</span><span class=n>f_op</span><span class=o>-&gt;</span><span class=n>write</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>ret</span> <span class=o>=</span> <span class=n>file</span><span class=o>-&gt;</span><span class=n>f_op</span><span class=o>-&gt;</span><span class=n>write</span><span class=p>(</span><span class=n>file</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=n>count</span><span class=p>,</span> <span class=n>pos</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>file</span><span class=o>-&gt;</span><span class=n>f_op</span><span class=o>-&gt;</span><span class=n>write_iter</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>ret</span> <span class=o>=</span> <span class=n>new_sync_write</span><span class=p>(</span><span class=n>file</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=n>count</span><span class=p>,</span> <span class=n>pos</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>else</span>
</span></span><span class=line><span class=cl>		<span class=n>ret</span> <span class=o>=</span> <span class=o>-</span><span class=n>EINVAL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>ret</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>fsnotify_modify</span><span class=p>(</span><span class=n>file</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=n>add_wchar</span><span class=p>(</span><span class=n>current</span><span class=p>,</span> <span class=n>ret</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=n>inc_syscw</span><span class=p>(</span><span class=n>current</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>file_end_write</span><span class=p>(</span><span class=n>file</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>ret</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>两者区别除了<code>write</code>发送的是<code>fsnotify_modify</code>通知外，<code>vfs_write</code>默认会保护<code>struct file</code>的读，怎么做的呢？<code>file_start_write</code>最终会调到<code>__sb_start_write</code>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=k>static</span> <span class=kr>inline</span> <span class=kt>void</span> <span class=nf>__sb_start_write</span><span class=p>(</span><span class=k>struct</span> <span class=n>super_block</span> <span class=o>*</span><span class=n>sb</span><span class=p>,</span> <span class=kt>int</span> <span class=n>level</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>percpu_down_read</span><span class=p>(</span><span class=n>sb</span><span class=o>-&gt;</span><span class=n>s_writers</span><span class=p>.</span><span class=n>rw_sem</span> <span class=o>+</span> <span class=n>level</span> <span class=o>-</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这时候给读加上了锁，可以参考<a href=https://www.kernel.org/doc/html/latest/locking/percpu-rw-semaphore.html target=_blank rel="noopener noreffer">percpu-rw-semaphore</a>。</p><p>在写完之后<code>file_end_write</code>调用<code>__sb_end_write</code>给读解锁：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=k>static</span> <span class=kr>inline</span> <span class=kt>void</span> <span class=nf>__sb_end_write</span><span class=p>(</span><span class=k>struct</span> <span class=n>super_block</span> <span class=o>*</span><span class=n>sb</span><span class=p>,</span> <span class=kt>int</span> <span class=n>level</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>percpu_up_read</span><span class=p>(</span><span class=n>sb</span><span class=o>-&gt;</span><span class=n>s_writers</span><span class=p>.</span><span class=n>rw_sem</span> <span class=o>+</span> <span class=n>level</span><span class=o>-</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div><div class=post-footer id=post-footer><div class=orlike-box></div><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2023-01-08</span></div><div class=post-info-license><span><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></div><div class=post-info-more><section><i class="fas fa-fw fa-th"></i>&nbsp;<a href=/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/>操作系统</a>,&nbsp;<a href=/categories/glibc/>glibc</a></section><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/linux/>Linux</a>,&nbsp;<a href=/tags/glibc/>glibc</a></section></div><div class=post-nav><a href=/202212/2022-summary/ class=prev rel=prev title=2022年终总结><i class="fas fa-angle-left fa-fw"></i>2022年终总结</a>
<a href=/202301/robomaster-experience/ class=next rel=next title=我在RoboMaster那些年>我在RoboMaster那些年<i class="fas fa-angle-right fa-fw"></i></a></div></div><div id=my-random-posts><div class=loadingThree><span></span>
<span></span>
<span></span>
<span></span>
<span></span></div></div><div id=comments><div id=giscus class=comment></div><script src=https://giscus.app/client.js data-repo=caibingcheng/comment data-repo-id=R_kgDOHgda4w data-category=Announcements data-category-id=DIC_kwDOHgda484CTfDe data-mapping=og:title data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=/css/giscus.css data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script><noscript>Please enable JavaScript to view the comments powered by <a href=https://giscus.app/>giscus</a>.</noscript></div></article></div></main><footer class=footer><hr style=opacity:.2><div class=footer-container><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2020 - 2024</span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span><span class=icp-splitter>&nbsp;|&nbsp;</span><br class=icp-br><span class=icp><a href="https://icp.gov.moe/?keyword=20222231" target=_blank>萌ICP备20222231号</a></span></div><div class=footer-line><a href=https://wiki.imcbc.cn target=_blank rel=noopener title="Bing's Wiki">Wiki</a>
&nbsp;|&nbsp;
<a href=https://rssblog.cn target=_blank rel=noopener title=RSSBlog>RSSBlog</a>
&nbsp;|&nbsp;
<a href=https://travellings.link target=_blank rel=noopener title=开往-友链接力>开往-友链接力</a>
&nbsp;|&nbsp;
<a href=https://www.foreverblog.cn/go.html target=_blank>穿梭虫洞</a></div><div class=footer-line><script>var build_date="2024-03-05T21:35:50+08:00"</script>已运行
<span id=run-time></span>
&nbsp;|&nbsp;
构建于
<span id=build-time></span>&nbsp;前</div><div class=footer-line><script async src=https://npm.elemecdn.com/penndu@1.0.0/bsz.js></script>
共计
<span id=busuanzi_value_site_uv></span>&nbsp;访客
&nbsp;|&nbsp;
<span id=busuanzi_value_site_pv></span>&nbsp;访问
&nbsp;|&nbsp;
256K&nbsp;字</div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw"></i>
</a><a id=reader-button class=fixed-button title=阅读模式><i class="fa fa-book fa-fw"></i></a></div><link rel=stylesheet href=https://fastly.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/css/lightgallery.min.css><link rel=stylesheet href=https://fastly.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css><link rel=stylesheet href=https://fastly.jsdelivr.net/npm/katex@0.11.1/dist/contrib/copy-tex.min.css><script type=text/javascript src=https://cdn.staticfile.org/jquery/3.6.0/jquery.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/npm/autocomplete.js@0.37.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/npm/algoliasearch@4.2.0/dist/algoliasearch-lite.umd.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/js/lightgallery.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/npm/lg-thumbnail.js@1.2.0/dist/lg-thumbnail.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/npm/lg-zoom.js@1.2.0/dist/lg-zoom.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/npm/katex@0.11.1/dist/contrib/copy-tex.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/npm/katex@0.11.1/dist/contrib/mhchem.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/gh/Albejr/jquery-albe-timeline/jquery-albe-timeline.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/gh/caibingcheng/orlike@client/orlike.min.js></script><script type=text/javascript src=/js/custom.js></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:50},comment:{},lightGallery:{actualSize:!1,exThumbImage:"data-thumbnail",hideBarsDelay:2e3,selector:".lightgallery",speed:400,thumbContHeight:80,thumbWidth:80,thumbnail:!0},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{algoliaAppID:"JMTHQS1VUU",algoliaIndex:"blog-bbing",algoliaSearchKey:"0dd43732743475449c844c0d0f21366a",highlightTag:"em",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:50,type:"algolia"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>