<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>Work Monitor 视频监控工具 - Bing's Blog</title><meta name=keywords content="[Life bbing bing hugo Blog C++ LoveIt]"><meta name=Description content="个人技术博客"><meta property="og:title" content="Work Monitor 视频监控工具"><meta property="og:description" content="已经很久沒有更新博客，主要是现在工作太忙，一天压得比较紧，回家之后就就没有太多精力去写博客了。
最近更新了一个Python工具，主要是用来视频监控。基本想法是通过延时摄影的方式，每隔一段时间拍摄一张照片，然后组合成视频，这样就可以看到一段时间内的变化。"><meta property="og:type" content="article"><meta property="og:url" content="https://imcbc.cn/202401/work-monitor/"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/caibingcheng/resources@main/images/13bOkrO.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-01-08T20:56:55+08:00"><meta property="article:modified_time" content="2024-01-08T20:56:55+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://cdn.jsdelivr.net/gh/caibingcheng/resources@main/images/13bOkrO.png"><meta name=twitter:title content="Work Monitor 视频监控工具"><meta name=twitter:description content="已经很久沒有更新博客，主要是现在工作太忙，一天压得比较紧，回家之后就就没有太多精力去写博客了。
最近更新了一个Python工具，主要是用来视频监控。基本想法是通过延时摄影的方式，每隔一段时间拍摄一张照片，然后组合成视频，这样就可以看到一段时间内的变化。"><meta name=application-name content="Bing's Blog"><meta name=apple-mobile-web-app-title content="Bing's Blog"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://imcbc.cn/202401/work-monitor/><link rel=prev href=https://imcbc.cn/202307/3k-diypc-nasup/><link rel=next href=https://imcbc.cn/202402/saomu/><link rel=stylesheet href=https://fastly.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=https://fastly.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.0/css/all.min.css><link rel=stylesheet href=https://fastly.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css><link rel=stylesheet href=https://fastly.jsdelivr.net/gh/Albejr/jquery-albe-timeline/templates/simple/style-albe-timeline.css><link rel=stylesheet href=https://fastly.jsdelivr.net/gh/caibingcheng/orlike@client/orlike.min.css><link rel=stylesheet href=/css/custom.css><meta name=google-site-verification content="xy1bCgQPV_H3_o2XD34o2mIByQxmzkV3GPOfhXg_mTM"><meta name=msvalidate.01 content="c81a65b6344571786df543a56c7bbe18"><meta name=baidu-site-verification content="code-WcyzWjgFYo"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Work Monitor 视频监控工具","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/imcbc.cn\/202401\/work-monitor\/"},"image":["https:\/\/imcbc.cn\/android-chrome-192x192.png"],"genre":"posts","keywords":"opencv, Python","wordcount":2849,"url":"https:\/\/imcbc.cn\/202401\/work-monitor\/","datePublished":"2024-01-08T20:56:55+08:00","dateModified":"2024-01-08T20:56:55+08:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"Bing","logo":"https:\/\/imcbc.cn\/android-chrome-192x192.png"},"author":{"@type":"Person","name":"bing"},"description":""}</script></head><body header-desktop=normal header-mobile=normal><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><a href=https://github.com/caibingcheng/ class=github-corner aria-label="View source on GitHub"><svg width="3.5rem" height="3.5rem" viewBox="0 0 250 250" style="fill:#151513;color:#fff;position:absolute;top:0;border:0;left:0;transform:scale(-1,1)" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><div class=header-title><a href=/ title="Bing's Blog">Bing's Blog</a></div><div class=menu><div class=menu-inner><div class=dropdown><a href=/posts/ class="menu-item menu-more dropbtn" title><i class='fas fa fa-archive'></i> 归档</a><div class="menu-more-content dropdown-content"><a href=/tags/ title><i class='fas fa fa-tag'></i> 标签 </a><a href=/categories/ title><i class='fas fa fa-th'></i> 分类</a></div></div><a class=menu-item href=/friends/><i class='fas fa fa-users'></i> 友链</a><div class=dropdown><a href=javascript:void(0); class="menu-item menu-more dropbtn" title><i class='fas fa fa-angle-double-down'></i> 更多</a><div class="menu-more-content dropdown-content"><a href=/tools/ title><i class='fas fa fa-cubes'></i> 工具 </a><a href=/about/ title><i class='fas fa fa-address-card'></i> 关于 </a><a href=/timeline/ title><i class='fas fa fa-building'></i> 建站 </a><a href=/index.xml/ title><i class='fas fa fa-rss'></i> RSS</a></div></div><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=搜索文章内容 id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin"></i></span>
</span><a href=https://travellings.link target=_blank class=menu-item rel=noopener title=开往-友链接力><i class='fas fa-fw fa-subway'></i></a>
<a href=https://rssblog.cn/bbing class=menu-item target=_blank rel=noopener title=RSSBlog><i class='fas fa-fw fa-inbox'></i></a>
<a href=https://www.foreverblog.cn/go.html class=menu-item target=_blank rel=noopener title=穿梭虫洞><i class="fas fa-fw fa-life-ring" title=穿梭虫洞-随机访问十年之约友链博客></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Bing's Blog">Bing's Blog</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章内容 id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></div><a href=/posts/ class=menu-item title><i class='fas fa fa-archive'></i> 归档</a>
<a href=/tags/ class=menu-item title><i class='fas fa fa-tag'></i> 标签</a>
<a href=/categories/ class=menu-item title><i class='fas fa fa-th'></i> 分类</a>
<a class=menu-item href=/friends/><i class='fas fa fa-users'></i> 友链</a>
<a href=/tools/ class=menu-item title><i class='fas fa fa-cubes'></i> 工具</a>
<a href=/about/ class=menu-item title><i class='fas fa fa-address-card'></i> 关于</a>
<a href=/timeline/ class=menu-item title><i class='fas fa fa-building'></i> 建站</a>
<a href=/index.xml/ class=menu-item title><i class='fas fa fa-rss'></i> RSS</a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class=single-title>Work Monitor 视频监控工具<sup>
<a id=reader-button-title title=阅读模式><i class="fa fa-book fa-fw"></i></a></sup></h1><div class=post-meta><div class=post-meta-line></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2024-01-08>2024-01-08</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 2849 字&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 6 分钟&nbsp;</div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><ul><li><a href=#安装>安装</a></li><li><a href=#使用>使用</a></li><li><a href=#代码讲解>代码讲解</a><ul><li><a href=#入口>入口</a></li><li><a href=#配置>配置</a></li><li><a href=#通信>通信</a></li><li><a href=#视频>视频</a></li></ul></li><li><a href=#小结>小结</a></li></ul></li></ul></nav></div></div><div class=content id=content><p>已经很久沒有更新博客，主要是现在工作太忙，一天压得比较紧，回家之后就就没有太多精力去写博客了。</p><p>最近更新了一个Python工具，主要是用来视频监控。基本想法是通过延时摄影的方式，每隔一段时间拍摄一张照片，然后组合成视频，这样就可以看到一段时间内的变化。</p><p>想做这个工具是因为我的电脑不太方便关或者锁屏，所以一般是打开的状态，但是我又想知道在我不在的时候，我的电脑有没有被别人使用，所以就想到了这个工具。目前处于可以使用的状态，后续我想加一些检测功能，比如检测到非自己的人脸就提高检测频率之类的，或者考虑视频压缩，可以减少一些重复、静态帧。</p><h3 id=安装>安装</h3><p>相关的包已经上传到了pypi，可以通过pip安装。依赖的包有opencv-python，numpy。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pip3 install work-monitor
</span></span></code></pre></td></tr></table></div></div><p>或者通过源码直接使用。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>git clone git@github.com:caibingcheng/work-monitor.git
</span></span><span class=line><span class=cl><span class=nb>cd</span> work-monitor
</span></span><span class=line><span class=cl>python3 -m monitor
</span></span></code></pre></td></tr></table></div></div><h3 id=使用>使用</h3><p>首先是启动监控服务。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>work-monitor server
</span></span></code></pre></td></tr></table></div></div><p>然后可以通过客户端来设置或查看服务端的状态，比如查看服务端的配置。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>work-monitor get_config
</span></span></code></pre></td></tr></table></div></div><p>或者设置服务端的配置。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>work-monitor set_config &lt;keys...&gt; &lt;value&gt;
</span></span></code></pre></td></tr></table></div></div><p>help命令可以查看更多的命令。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ work-monitor <span class=nb>help</span>
</span></span><span class=line><span class=cl>Usage: python3 -m monitor &lt;command&gt; <span class=o>[</span>arguments<span class=o>]</span>
</span></span><span class=line><span class=cl>Commands:
</span></span><span class=line><span class=cl>    help: Print <span class=nb>help</span>
</span></span><span class=line><span class=cl>    server: Start server <span class=o>[</span>video_path<span class=o>]</span>, default video_path is empty
</span></span><span class=line><span class=cl>    stop: Client command, stop server
</span></span><span class=line><span class=cl>    restart: Client command, restart server
</span></span><span class=line><span class=cl>    get_config: Client command, get config
</span></span><span class=line><span class=cl>    set_config: Client command, <span class=nb>set</span> config
</span></span></code></pre></td></tr></table></div></div><h3 id=代码讲解>代码讲解</h3><p>源码地址： <a href=https://github.com/caibingcheng/work-monitor target=_blank rel="noopener noreffer">https://github.com/caibingcheng/work-monitor</a></p><p>几个模块分类如下：</p><ul><li>app.py: 入口，调用command模块</li><li>command.py: 命令行模块，在其中配置该项目支持的命令</li><li>config.py: 配置模块，用于配置服务端的配置</li><li>server.py: 服务端模块，用于启动服务端，客户端和服务端的通信也在其中实现</li><li>log.py: 日志模块，用于记录日志</li><li>capture.py: 拍照模块，用于拍照和保存图片</li><li>video.py: 视频模块，用于将图片组合成视频</li><li>policy.py: 策略模块，用于配置拍照和视频的策略，比如拍照的间隔时间，视频的长度等</li></ul><h4 id=入口>入口</h4><p>主要关注server的入口。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@add_command</span><span class=p>(</span><span class=s2>&#34;server&#34;</span><span class=p>,</span> <span class=s2>&#34;Start server [video_path], default video_path is empty&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>server</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>log_info</span><span class=p>(</span><span class=s2>&#34;Starting&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>policy</span> <span class=o>=</span> <span class=n>config</span><span class=p>[</span><span class=s2>&#34;policy&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>log_info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Using policy </span><span class=si>{</span><span class=n>policy</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># str to function</span>
</span></span><span class=line><span class=cl>    <span class=n>policy</span> <span class=o>=</span> <span class=nb>globals</span><span class=p>()[</span><span class=n>policy</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kn>from</span> <span class=nn>monitor.server</span> <span class=kn>import</span> <span class=n>start_server</span><span class=p>,</span> <span class=n>should_stop</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>start_server</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>video_path_for_debug</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span> <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>args</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=k>else</span> <span class=n>args</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=ow>not</span> <span class=n>should_stop</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>policy</span><span class=p>(</span><span class=n>video_path_for_debug</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>log_error</span><span class=p>(</span><span class=n>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=c1># backtrace</span>
</span></span><span class=line><span class=cl>            <span class=kn>import</span> <span class=nn>traceback</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>traceback</span><span class=o>.</span><span class=n>print_exc</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>stop</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>log_info</span><span class=p>(</span><span class=s2>&#34;Stopped&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>先找到policy，然后启动命令监听的server，然后执行对应的policy。如果发生异常时，会给server发送stop命令，然后退出。（这里有问题，如果是server异常，则命令不一定能发送到server，所以需要改进。）</p><h4 id=配置>配置</h4><p>原始配置如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>raw_config</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;camera_id&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;video_dir&#34;</span><span class=p>:</span> <span class=s2>&#34;$HOME/Videos&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;frames_dir&#34;</span><span class=p>:</span> <span class=s2>&#34;$HOME/Pictures/work-monitor&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;config_dir&#34;</span><span class=p>:</span> <span class=s2>&#34;$HOME/.work-monitor&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;log_dir&#34;</span><span class=p>:</span> <span class=s2>&#34;$HOME/.work-monitor/log&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;fps&#34;</span><span class=p>:</span> <span class=mi>60</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;quality&#34;</span><span class=p>:</span> <span class=mi>75</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;frames_save&#34;</span><span class=p>:</span> <span class=kc>False</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;policy&#34;</span><span class=p>:</span> <span class=s2>&#34;easy_policy&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;easy_policy&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;frames_interval&#34;</span><span class=p>:</span> <span class=mi>10</span><span class=p>,</span> <span class=s2>&#34;frames_per_video&#34;</span><span class=p>:</span> <span class=mi>1000</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;server&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;port&#34;</span><span class=p>:</span> <span class=mi>22311</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>各项配置的含义如下：</p><ul><li>camera_id: 摄像头id，如果有多个摄像头，可以通过这个配置来选择摄像头</li><li>video_dir: 视频保存的目录</li><li>frames_dir: 帧图片保存的目录</li><li>config_dir: 配置文件保存的目录</li><li>log_dir: 日志保存的目录</li><li>fps: 视频的帧率</li><li>quality: 帧图片的质量，取值范围[0, 100]，0表示最差，100表示最好</li><li>frames_save: 是否保存帧图片，一般设置为False，因为帧图片会占用很大的空间</li><li>policy: 策略，目前只有easy_policy，后续可以添加更多的策略</li><li>easy_policy: easy_policy的配置，包括帧图片的间隔时间和视频的长度</li><li>server: 服务端的配置，目前只有端口号</li></ul><div class="details admonition tip open"><div class="details-summary admonition-title"><i class="icon fas fa-lightbulb fa-fw"></i>提示<i class="details-icon fas fa-angle-right fa-fw"></i></div><div class=details-content><div class=admonition-content>对于frames_save配置目前还有一些问题，如果设置值为True，并且policy是通过帧图片数判断是否要保存视频的话，则在第一次触发阈值之后会频繁触发且保存相同的帧。</div></div></div><p>配置是通过一个全局变量config来保存的，初始化流程如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>config</span> <span class=o>=</span> <span class=n>initialize_config</span><span class=p>(</span><span class=n>config</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>verify_config</span><span class=p>(</span><span class=n>config</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>choise</span> <span class=o>=</span> <span class=nb>input</span><span class=p>(</span><span class=s2>&#34;Reset config? (y/n)&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>choise</span> <span class=o>==</span> <span class=s2>&#34;y&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Resetting config&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>config</span> <span class=o>=</span> <span class=n>raw_config</span>
</span></span><span class=line><span class=cl>        <span class=n>config</span> <span class=o>=</span> <span class=n>initialize_config</span><span class=p>(</span><span class=n>config</span><span class=p>,</span> <span class=n>force</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Using raw config&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>config</span> <span class=o>=</span> <span class=n>raw_config</span>
</span></span><span class=line><span class=cl><span class=n>config</span> <span class=o>=</span> <span class=n>preprocess_config</span><span class=p>(</span><span class=n>config</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>verify_config</span><span class=p>(</span><span class=n>config</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>initialize_config会对原始的config作预处理，替换其中的环境变量，比如$HOME；判断值范围是否正确，比如quality的值范围是[0, 100]，如果不在范围内，则会抛出异常；创建目录，比如video_dir，frames_dir等；如果是第一次启动，则会将配置写入到文件。预处理之后会调用verify_config来验证配置是否正确，主要是检查config和raw_config的key是否一致，如果不一致，则会抛出异常。</p><p>当有异常的时候会尝试用raw_config来初始化config，如果用户允许的话，会覆盖掉原来的配置文件。</p><p>在server中可以动态更新参数，对应的修改会更新到配置文件中。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@add_server_command</span><span class=p>(</span><span class=s2>&#34;set_config&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>set_config_server</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>args</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>2</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=s2>&#34;Not enough arguments&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>current</span> <span class=o>=</span> <span class=n>config</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>current_header</span> <span class=o>=</span> <span class=n>current</span>
</span></span><span class=line><span class=cl>    <span class=n>keys</span> <span class=o>=</span> <span class=n>args</span><span class=p>[:</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>value</span> <span class=o>=</span> <span class=n>args</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>key</span> <span class=ow>in</span> <span class=n>keys</span><span class=p>[:</span><span class=o>-</span><span class=mi>1</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>key</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>current</span> <span class=ow>or</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>current</span><span class=p>[</span><span class=n>key</span><span class=p>],</span> <span class=nb>dict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Key </span><span class=si>{</span><span class=n>key</span><span class=si>}</span><span class=s2> not found&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>current</span> <span class=o>=</span> <span class=n>current</span><span class=p>[</span><span class=n>key</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>current</span><span class=p>[</span><span class=n>keys</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]]</span> <span class=o>=</span> <span class=n>value</span>
</span></span><span class=line><span class=cl>    <span class=n>current_header</span> <span class=o>=</span> <span class=n>initialize_config</span><span class=p>(</span><span class=n>current_header</span><span class=p>,</span> <span class=n>force</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>config_str</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>current_header</span><span class=p>,</span> <span class=n>indent</span><span class=o>=</span><span class=mi>4</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s2>&#34;utf-8&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>log_info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Sending config </span><span class=si>{</span><span class=n>config_str</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>update_config</span><span class=p>(</span><span class=n>config</span><span class=p>,</span> <span class=n>current_header</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>config_str</span>
</span></span></code></pre></td></tr></table></div></div><p>比如设置video_dir。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>work-monitor set_config video_dir /home/bing/Videos
</span></span></code></pre></td></tr></table></div></div><h4 id=通信>通信</h4><p>server在主线程中启动，在子线程中监听客户端的连接。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>start_server</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=c1># create a socket object</span>
</span></span><span class=line><span class=cl>    <span class=n>serversocket</span> <span class=o>=</span> <span class=n>socket</span><span class=o>.</span><span class=n>socket</span><span class=p>(</span><span class=n>socket</span><span class=o>.</span><span class=n>AF_INET</span><span class=p>,</span> <span class=n>socket</span><span class=o>.</span><span class=n>SOCK_STREAM</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># get local machine name</span>
</span></span><span class=line><span class=cl>    <span class=n>host</span> <span class=o>=</span> <span class=n>socket</span><span class=o>.</span><span class=n>gethostname</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>port</span> <span class=o>=</span> <span class=n>config</span><span class=p>[</span><span class=s2>&#34;server&#34;</span><span class=p>][</span><span class=s2>&#34;port&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># force to release the port</span>
</span></span><span class=line><span class=cl>    <span class=n>serversocket</span><span class=o>.</span><span class=n>setsockopt</span><span class=p>(</span><span class=n>socket</span><span class=o>.</span><span class=n>SOL_SOCKET</span><span class=p>,</span> <span class=n>socket</span><span class=o>.</span><span class=n>SO_REUSEADDR</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># set keep alive</span>
</span></span><span class=line><span class=cl>    <span class=n>serversocket</span><span class=o>.</span><span class=n>setsockopt</span><span class=p>(</span><span class=n>socket</span><span class=o>.</span><span class=n>SOL_SOCKET</span><span class=p>,</span> <span class=n>socket</span><span class=o>.</span><span class=n>SO_KEEPALIVE</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>serversocket</span><span class=o>.</span><span class=n>setsockopt</span><span class=p>(</span><span class=n>socket</span><span class=o>.</span><span class=n>IPPROTO_TCP</span><span class=p>,</span> <span class=n>socket</span><span class=o>.</span><span class=n>TCP_KEEPIDLE</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>serversocket</span><span class=o>.</span><span class=n>setsockopt</span><span class=p>(</span><span class=n>socket</span><span class=o>.</span><span class=n>IPPROTO_TCP</span><span class=p>,</span> <span class=n>socket</span><span class=o>.</span><span class=n>TCP_KEEPINTVL</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>serversocket</span><span class=o>.</span><span class=n>setsockopt</span><span class=p>(</span><span class=n>socket</span><span class=o>.</span><span class=n>IPPROTO_TCP</span><span class=p>,</span> <span class=n>socket</span><span class=o>.</span><span class=n>TCP_KEEPCNT</span><span class=p>,</span> <span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># bind to the port</span>
</span></span><span class=line><span class=cl>    <span class=n>serversocket</span><span class=o>.</span><span class=n>bind</span><span class=p>((</span><span class=n>host</span><span class=p>,</span> <span class=n>port</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># queue up to 5 requests</span>
</span></span><span class=line><span class=cl>    <span class=n>serversocket</span><span class=o>.</span><span class=n>listen</span><span class=p>(</span><span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>server_loop</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=n>log_info</span><span class=p>(</span><span class=s2>&#34;Server started&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># establish a connection</span>
</span></span><span class=line><span class=cl>            <span class=n>clientsocket</span><span class=p>,</span> <span class=n>addr</span> <span class=o>=</span> <span class=n>serversocket</span><span class=o>.</span><span class=n>accept</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>log_info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Got a connection from </span><span class=si>{</span><span class=n>addr</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>msg</span> <span class=o>=</span> <span class=n>clientsocket</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=mi>1024</span><span class=p>)</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s2>&#34;utf-8&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>split</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>log_info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Received </span><span class=si>{</span><span class=n>msg</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>argument</span> <span class=o>=</span> <span class=n>msg</span><span class=p>[</span><span class=mi>1</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>            <span class=n>msg</span> <span class=o>=</span> <span class=n>msg</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>msg</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>server_command</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>log_error</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Unknown command </span><span class=si>{</span><span class=n>msg</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=n>clientsocket</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=s2>&#34;failed&#34;</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s2>&#34;utf-8&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>clientsocket</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>server_command</span><span class=p>[</span><span class=n>msg</span><span class=p>](</span><span class=o>*</span><span class=n>argument</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># show backtrace</span>
</span></span><span class=line><span class=cl>                <span class=n>log_error</span><span class=p>(</span><span class=s2>&#34;Server failed&#34;</span><span class=p>,</span> <span class=n>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>log_error</span><span class=p>(</span><span class=s2>&#34;Config&#34;</span><span class=p>,</span> <span class=n>config</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=n>clientsocket</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=s2>&#34;failed&#34;</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s2>&#34;utf-8&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>clientsocket</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>server_loop</span><span class=p>)</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>客户端如下，是一般定式写法。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>send_msg_to_server</span><span class=p>(</span><span class=n>msg</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># create a socket object</span>
</span></span><span class=line><span class=cl>    <span class=n>client</span> <span class=o>=</span> <span class=n>socket</span><span class=o>.</span><span class=n>socket</span><span class=p>(</span><span class=n>socket</span><span class=o>.</span><span class=n>AF_INET</span><span class=p>,</span> <span class=n>socket</span><span class=o>.</span><span class=n>SOCK_STREAM</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># get local machine name</span>
</span></span><span class=line><span class=cl>    <span class=n>host</span> <span class=o>=</span> <span class=n>socket</span><span class=o>.</span><span class=n>gethostname</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>port</span> <span class=o>=</span> <span class=n>config</span><span class=p>[</span><span class=s2>&#34;server&#34;</span><span class=p>][</span><span class=s2>&#34;port&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># connection to hostname on the port.</span>
</span></span><span class=line><span class=cl>        <span class=n>client</span><span class=o>.</span><span class=n>connect</span><span class=p>((</span><span class=n>host</span><span class=p>,</span> <span class=n>port</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>log_error</span><span class=p>(</span><span class=s2>&#34;Client failed to connect to server&#34;</span><span class=p>,</span> <span class=n>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Receive no more than 1024 bytes</span>
</span></span><span class=line><span class=cl>    <span class=n>client</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>msg</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s2>&#34;utf-8&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>response</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=mi>1024</span><span class=p>)</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s2>&#34;utf-8&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>client</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>response</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=视频>视频</h4><p>拍照时，会将图片保存到frames_dir中，然后通过video模块来组合成视频。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>generate_video</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=c1># only one video can be generated at a time</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>video_in_progress</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>video_in_progress</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>log_info</span><span class=p>(</span><span class=s2>&#34;Generating video&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>frames</span><span class=p>,</span> <span class=n>frames_date_range</span> <span class=o>=</span> <span class=n>load_frames</span><span class=p>(</span><span class=n>config</span><span class=p>[</span><span class=s2>&#34;frames_dir&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=n>log_info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Total frames: </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>frames</span><span class=p>)</span><span class=si>}</span><span class=s2>, date range: </span><span class=si>{</span><span class=n>frames_date_range</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>frames</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>video_in_progress</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>    <span class=kn>import</span> <span class=nn>threading</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>target</span><span class=o>=</span><span class=n>generate_video_from_frames</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=n>frames</span><span class=p>,</span> <span class=n>frames_date_range</span><span class=p>,</span> <span class=n>config</span><span class=p>[</span><span class=s2>&#34;video_dir&#34;</span><span class=p>],</span> <span class=n>config</span><span class=p>[</span><span class=s2>&#34;fps&#34;</span><span class=p>]),</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>视频的生成是在子线程中进行的，考虑到一些边界情况，目前只允许一个视频生成线程在运行。</p><p>首先是检查frames_dir中是否有图片，如果没有则直接返回。然后将video_in_progress设置为True，表示有视频正在生成，然后在子线程中调用generate_video_from_frames来生成视频。</p><p>在检查frames_dir中是否有图片时，只是拿到图片的地址，此处不会读图，主要是考虑到frames_dir中的图片可能会很多，如果一次性读入内存，可能会导致内存不足，所以在生成视频的时候，会一张张的读入图片，然后组合成视频。</p><p>在图片保存的时候，会在图片中插入时间信息，这样在生成的视频中可以直观的看到时间信息。不过这样也会导致图片之间存在差异，不易于判断图片的相似度。（可以对相关区域做mask屏蔽。）</p><h3 id=小结>小结</h3><p>总算更新了一篇博客，这个工具还有很多可以改进的地方，但是比如之前写的fstats、fkfish之类的工具在第一版之后就已经很久没有更新了，目前看起来也够用，总之随心所欲吧。也有几个其他的工具还在推进中，还没有成品，后续慢慢更新。</p><p>另外，感觉我这段时间有些闭塞，在制作这个工具的过程中，知道了以下更新：</p><ul><li>python3.10支持pyproject.toml了，并且setup.py是不推荐的了</li><li>pypi用github action + twine发布会报错了，可以通过Trusted Publisher Management来管理发布者</li></ul><p>不过，这段时间也不是废了，只是接触的领域不同。目前对DMA、Misra规则、QNX系统等等有一些接触和了解，也是扩展了自己的知识面，并且目前所在的激光雷达领域对我来说，就像是我在相机领域的延续，所以这也是缘分了。后续的年终总结中会想介绍介绍我的想法。</p></div><div class=post-footer id=post-footer><div class=orlike-box></div><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2024-01-08</span></div><div class=post-info-license><span><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></div><div class=post-info-more><section><i class="fas fa-fw fa-th"></i>&nbsp;<a href=/categories/%E5%B7%A5%E5%85%B7/>工具</a></section><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/opencv/>opencv</a>,&nbsp;<a href=/tags/python/>Python</a></section></div><div class=post-nav><a href=/202307/3k-diypc-nasup/ class=prev rel=prev title=3000元装机和NAS升级><i class="fas fa-angle-left fa-fw"></i>3000元装机和NAS升级</a>
<a href=/202402/saomu/ class=next rel=next title=扫墓>扫墓<i class="fas fa-angle-right fa-fw"></i></a></div></div><div id=my-random-posts><div class=loadingThree><span></span>
<span></span>
<span></span>
<span></span>
<span></span></div></div><div id=comments><div id=giscus class=comment></div><script src=https://giscus.app/client.js data-repo=caibingcheng/comment data-repo-id=R_kgDOHgda4w data-category=Announcements data-category-id=DIC_kwDOHgda484CTfDe data-mapping=og:title data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=/css/giscus.css data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script><noscript>Please enable JavaScript to view the comments powered by <a href=https://giscus.app/>giscus</a>.</noscript></div></article></div></main><footer class=footer><hr style=opacity:.2><div class=footer-container><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2020 - 2024</span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span><span class=icp-splitter>&nbsp;|&nbsp;</span><br class=icp-br><span class=icp><a href="https://icp.gov.moe/?keyword=20222231" target=_blank>萌ICP备20222231号</a></span></div><div class=footer-line><a href=https://wiki.imcbc.cn target=_blank rel=noopener title="Bing's Wiki">Wiki</a>
&nbsp;|&nbsp;
<a href=https://rssblog.cn target=_blank rel=noopener title=RSSBlog>RSSBlog</a>
&nbsp;|&nbsp;
<a href=https://travellings.link target=_blank rel=noopener title=开往-友链接力>开往-友链接力</a>
&nbsp;|&nbsp;
<a href=https://www.foreverblog.cn/go.html target=_blank>穿梭虫洞</a></div><div class=footer-line><script>var build_date="2024-03-05T21:35:50+08:00"</script>已运行
<span id=run-time></span>
&nbsp;|&nbsp;
构建于
<span id=build-time></span>&nbsp;前</div><div class=footer-line><script async src=https://npm.elemecdn.com/penndu@1.0.0/bsz.js></script>
共计
<span id=busuanzi_value_site_uv></span>&nbsp;访客
&nbsp;|&nbsp;
<span id=busuanzi_value_site_pv></span>&nbsp;访问
&nbsp;|&nbsp;
256K&nbsp;字</div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw"></i>
</a><a id=reader-button class=fixed-button title=阅读模式><i class="fa fa-book fa-fw"></i></a></div><script type=text/javascript src=https://cdn.staticfile.org/jquery/3.6.0/jquery.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/npm/autocomplete.js@0.37.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/npm/algoliasearch@4.2.0/dist/algoliasearch-lite.umd.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/gh/Albejr/jquery-albe-timeline/jquery-albe-timeline.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/gh/caibingcheng/orlike@client/orlike.min.js></script><script type=text/javascript src=/js/custom.js></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:50},comment:{},search:{algoliaAppID:"JMTHQS1VUU",algoliaIndex:"blog-bbing",algoliaSearchKey:"0dd43732743475449c844c0d0f21366a",highlightTag:"em",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:50,type:"algolia"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>