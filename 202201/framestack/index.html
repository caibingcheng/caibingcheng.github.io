<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>程序的栈帧 - Bing's Blog</title><meta name=keywords content="[Life bbing bing hugo Blog C++ LoveIt]"><meta name=Description content="个人技术博客"><meta property="og:title" content="程序的栈帧"><meta property="og:description" content="在《glibc-exit源码阅读》和《《UCB CS61a SICP Python 中文》一周目笔记(一)》中我们提到了栈帧的概念，但是我对这个概念越来越模糊，栈帧是什么？栈帧是不是包含了程序的执行指令？"><meta property="og:type" content="article"><meta property="og:url" content="https://imcbc.cn/202201/framestack/"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/caibingcheng/resources@main/images/13bOkrO.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-01-26T13:18:50+08:00"><meta property="article:modified_time" content="2022-01-26T13:18:50+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://cdn.jsdelivr.net/gh/caibingcheng/resources@main/images/13bOkrO.png"><meta name=twitter:title content="程序的栈帧"><meta name=twitter:description content="在《glibc-exit源码阅读》和《《UCB CS61a SICP Python 中文》一周目笔记(一)》中我们提到了栈帧的概念，但是我对这个概念越来越模糊，栈帧是什么？栈帧是不是包含了程序的执行指令？"><meta name=application-name content="Bing's Blog"><meta name=apple-mobile-web-app-title content="Bing's Blog"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://imcbc.cn/202201/framestack/><link rel=prev href=https://imcbc.cn/202201/glibc-exit/><link rel=next href=https://imcbc.cn/202202/fopen-sys-open/><link rel=stylesheet href=https://fastly.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=https://fastly.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.0/css/all.min.css><link rel=stylesheet href=https://fastly.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css><link rel=stylesheet href=https://fastly.jsdelivr.net/gh/Albejr/jquery-albe-timeline/templates/simple/style-albe-timeline.css><link rel=stylesheet href=https://fastly.jsdelivr.net/gh/caibingcheng/orlike@client/orlike.min.css><link rel=stylesheet href=/css/custom.css><meta name=google-site-verification content="xy1bCgQPV_H3_o2XD34o2mIByQxmzkV3GPOfhXg_mTM"><meta name=msvalidate.01 content="c81a65b6344571786df543a56c7bbe18"><meta name=baidu-site-verification content="code-WcyzWjgFYo"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"程序的栈帧","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/imcbc.cn\/202201\/framestack\/"},"image":["https:\/\/imcbc.cn\/android-chrome-192x192.png"],"genre":"posts","keywords":"Linux, 栈","wordcount":4002,"url":"https:\/\/imcbc.cn\/202201\/framestack\/","datePublished":"2022-01-26T13:18:50+08:00","dateModified":"2022-01-26T13:18:50+08:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"Bing","logo":"https:\/\/imcbc.cn\/android-chrome-192x192.png"},"author":{"@type":"Person","name":"bbing"},"description":""}</script></head><body header-desktop=normal header-mobile=normal><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><a href=https://github.com/caibingcheng/ class=github-corner aria-label="View source on GitHub"><svg width="3.5rem" height="3.5rem" viewBox="0 0 250 250" style="fill:#151513;color:#fff;position:absolute;top:0;border:0;left:0;transform:scale(-1,1)" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><div class=header-title><a href=/ title="Bing's Blog">Bing's Blog</a></div><div class=menu><div class=menu-inner><div class=dropdown><a href=/posts/ class="menu-item menu-more dropbtn" title><i class='fas fa fa-archive'></i> 归档</a><div class="menu-more-content dropdown-content"><a href=/tags/ title><i class='fas fa fa-tag'></i> 标签 </a><a href=/categories/ title><i class='fas fa fa-th'></i> 分类</a></div></div><a class=menu-item href=/friends/><i class='fas fa fa-users'></i> 友链</a><div class=dropdown><a href=javascript:void(0); class="menu-item menu-more dropbtn" title><i class='fas fa fa-angle-double-down'></i> 更多</a><div class="menu-more-content dropdown-content"><a href=/tools/ title><i class='fas fa fa-cubes'></i> 工具 </a><a href=/about/ title><i class='fas fa fa-address-card'></i> 关于 </a><a href=/timeline/ title><i class='fas fa fa-building'></i> 建站 </a><a href=/index.xml/ title><i class='fas fa fa-rss'></i> RSS</a></div></div><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=搜索文章内容 id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin"></i></span>
</span><a href=https://travellings.link target=_blank class=menu-item rel=noopener title=开往-友链接力><i class='fas fa-fw fa-subway'></i></a>
<a href=https://rssblog.cn/bbing class=menu-item target=_blank rel=noopener title=RSSBlog><i class='fas fa-fw fa-inbox'></i></a>
<a href=https://www.foreverblog.cn/go.html class=menu-item target=_blank rel=noopener title=穿梭虫洞><i class="fas fa-fw fa-life-ring" title=穿梭虫洞-随机访问十年之约友链博客></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Bing's Blog">Bing's Blog</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章内容 id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></div><a href=/posts/ class=menu-item title><i class='fas fa fa-archive'></i> 归档</a>
<a href=/tags/ class=menu-item title><i class='fas fa fa-tag'></i> 标签</a>
<a href=/categories/ class=menu-item title><i class='fas fa fa-th'></i> 分类</a>
<a class=menu-item href=/friends/><i class='fas fa fa-users'></i> 友链</a>
<a href=/tools/ class=menu-item title><i class='fas fa fa-cubes'></i> 工具</a>
<a href=/about/ class=menu-item title><i class='fas fa fa-address-card'></i> 关于</a>
<a href=/timeline/ class=menu-item title><i class='fas fa fa-building'></i> 建站</a>
<a href=/index.xml/ class=menu-item title><i class='fas fa fa-rss'></i> RSS</a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class=single-title>程序的栈帧<sup>
<a id=reader-button-title title=阅读模式><i class="fa fa-book fa-fw"></i></a></sup></h1><div class=post-meta><div class=post-meta-line></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2022-01-26>2022-01-26</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 4002 字&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 8 分钟&nbsp;</div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#栈帧>栈帧</a><ul><li><a href=#保存栈底和扩展栈>保存栈底和扩展栈</a></li><li><a href=#局部变量>局部变量</a></li><li><a href=#函数入参准备>函数入参准备</a></li><li><a href=#函数调用>函数调用</a></li><li><a href=#子函数>子函数</a></li><li><a href=#函数退出>函数退出</a></li></ul></li><li><a href=#黑魔法>黑魔法</a></li><li><a href=#结论>结论</a></li></ul></nav></div></div><div class=content id=content><p>在<a href=/202201/glibc-exit/ rel>《glibc-exit源码阅读》</a>和<a href=/202108/sicp-python-read1/ rel>《《UCB CS61a SICP Python 中文》一周目笔记(一)》</a>中我们提到了栈帧的概念，但是我对这个概念越来越模糊，栈帧是什么？栈帧是不是包含了程序的执行指令？</p><p>本文的说法或者结果可能因为不同平台或不同编译器而产生差别，但是本文的目的不是为了搞清楚某一个平台/编译器下的栈帧，而是为了搞清楚栈帧整体的概念，因此即使不同平台/编译器下，也应该不会有很大差别。</p><h2 id=栈帧>栈帧</h2><p>按照约定，以下<code>rbp</code>表示栈底，<code>rsp</code>表示栈顶，栈向低地址方向增长。</p><p>来看一段代码，以下使用<code>x86-64 clang 13.0.0</code>版本编译，需要开启<code>O0</code>优化：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=kt>int</span> <span class=nf>func</span><span class=p>(</span><span class=kt>int</span> <span class=n>v1</span><span class=p>,</span> <span class=kt>int</span> <span class=n>v2</span><span class=p>,</span> <span class=kt>int</span> <span class=n>v3</span><span class=p>,</span> <span class=kt>int</span> <span class=n>v4</span><span class=p>,</span> <span class=kt>int</span> <span class=n>v5</span><span class=p>,</span> <span class=kt>int</span> <span class=n>v6</span><span class=p>,</span> <span class=kt>int</span> <span class=n>v7</span><span class=p>,</span> <span class=kt>int</span> <span class=n>v8</span><span class=p>,</span> <span class=kt>int</span> <span class=n>v9</span><span class=p>,</span> <span class=kt>int</span> <span class=n>v10</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>n1</span> <span class=o>=</span> <span class=n>v1</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>n10</span> <span class=o>=</span> <span class=n>v10</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>nv</span> <span class=o>=</span> <span class=n>v1</span> <span class=o>+</span> <span class=n>v2</span> <span class=o>+</span> <span class=n>v3</span> <span class=o>+</span> <span class=n>v4</span> <span class=o>+</span> <span class=n>v5</span> <span class=o>+</span> <span class=n>v6</span> <span class=o>+</span> <span class=n>v7</span> <span class=o>+</span> <span class=n>v8</span> <span class=o>+</span> <span class=n>v9</span> <span class=o>+</span> <span class=n>v10</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>vv</span><span class=p>[</span><span class=mi>100</span><span class=p>]{</span><span class=mi>1</span><span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>vv10</span> <span class=o>=</span> <span class=n>vv</span><span class=p>[</span><span class=mi>10</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>cv</span><span class=p>[</span><span class=mi>10</span><span class=p>]</span> <span class=o>=</span> <span class=s>&#34;hello&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>nv</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>a</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>b</span> <span class=o>=</span> <span class=mi>10</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>c</span> <span class=o>=</span> <span class=mi>11</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>func</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>5</span><span class=p>,</span> <span class=mi>6</span><span class=p>,</span> <span class=mi>7</span><span class=p>,</span> <span class=mi>8</span><span class=p>,</span> <span class=mi>9</span><span class=p>,</span> <span class=n>b</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>得到<code>main</code>和<code>func</code>的汇编结果如下，下面来分析汇编流程。</p><p>首先看<code>main</code>函数的汇编：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ASM data-lang=ASM><span class=line><span class=cl><span class=nl>main:</span>
</span></span><span class=line><span class=cl> <span class=nf>push</span>   <span class=no>rbp</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>rbp</span><span class=p>,</span><span class=no>rsp</span>
</span></span><span class=line><span class=cl> <span class=nf>sub</span>    <span class=no>rsp</span><span class=p>,</span><span class=mi>0x30</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0x4</span><span class=p>],</span><span class=mi>0x0</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0x8</span><span class=p>],</span><span class=mi>0x1</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0xc</span><span class=p>],</span><span class=mi>0xa</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0x10</span><span class=p>],</span><span class=mi>0xb</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>edi</span><span class=p>,</span><span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0x8</span><span class=p>]</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>eax</span><span class=p>,</span><span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0xc</span><span class=p>]</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>esi</span><span class=p>,</span><span class=mi>0x2</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>edx</span><span class=p>,</span><span class=mi>0x3</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>ecx</span><span class=p>,</span><span class=mi>0x4</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>r8d</span><span class=p>,</span><span class=mi>0x5</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>r9d</span><span class=p>,</span><span class=mi>0x6</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rsp</span><span class=p>],</span><span class=mi>0x7</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rsp</span><span class=err>+</span><span class=mi>0x8</span><span class=p>],</span><span class=mi>0x8</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rsp</span><span class=err>+</span><span class=mi>0x10</span><span class=p>],</span><span class=mi>0x9</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rsp</span><span class=err>+</span><span class=mi>0x18</span><span class=p>],</span><span class=no>eax</span>
</span></span><span class=line><span class=cl> <span class=nf>call</span>   <span class=mi>401130</span> <span class=err>&lt;</span><span class=no>func</span><span class=p>(</span><span class=no>int</span><span class=p>,</span> <span class=no>int</span><span class=p>,</span> <span class=no>int</span><span class=p>,</span> <span class=no>int</span><span class=p>,</span> <span class=no>int</span><span class=p>,</span> <span class=no>int</span><span class=p>,</span> <span class=no>int</span><span class=p>,</span> <span class=no>int</span><span class=p>,</span> <span class=no>int</span><span class=p>,</span> <span class=no>int</span><span class=p>)</span><span class=err>&gt;</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>eax</span><span class=p>,</span><span class=mi>0x1</span>
</span></span><span class=line><span class=cl> <span class=nf>add</span>    <span class=no>rsp</span><span class=p>,</span><span class=mi>0x30</span>
</span></span><span class=line><span class=cl> <span class=nf>pop</span>    <span class=no>rbp</span>
</span></span><span class=line><span class=cl> <span class=nf>ret</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=保存栈底和扩展栈>保存栈底和扩展栈</h3><p>第一步是准备操作：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ASM data-lang=ASM><span class=line><span class=cl> <span class=nf>push</span>   <span class=no>rbp</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>rbp</span><span class=p>,</span><span class=no>rsp</span>
</span></span><span class=line><span class=cl> <span class=nf>sub</span>    <span class=no>rsp</span><span class=p>,</span><span class=mi>0x30</span>
</span></span></code></pre></td></tr></table></div></div><p>把上一次的<code>rbp</code>入栈，然后把<code>rbp</code>的值置为<code>rsp</code>，也就是说，目前为止，栈底就是上一次的栈顶，然后将栈顶寄存器<code>rsp</code>下移<code>0x30</code>个字节，这里约定了，64位机上，<code>rsp</code>偏移需要是16的整数倍。</p><p>第一步操作就是把上一次的栈顶作为现在的栈底，然后把栈顶下移一段距离，以增加当前栈的长度。</p><h3 id=局部变量>局部变量</h3><p>第二步操作初始化了一些局部变量：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ASM data-lang=ASM><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0x4</span><span class=p>],</span><span class=mi>0x0</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0x8</span><span class=p>],</span><span class=mi>0x1</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0xc</span><span class=p>],</span><span class=mi>0xa</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0x10</span><span class=p>],</span><span class=mi>0xb</span>
</span></span></code></pre></td></tr></table></div></div><p>如上，按照代码顺序，局部变量按照从高地址到低地址排列，比如<code>rbp-0x8</code>代表变量<code>a</code>，<code>rbp-0xc</code>代表变量<code>b</code>。但是也有一个问题，<code>rbp-0x4</code>代表的是什么？这里存在疑问，不像是为了内存对齐，因为即使我让<code>main</code>函数中的变量<code>8B</code>对齐了，这个<code>rbp-0x4</code>还是存在，但是使用gcc编译的话就不存在了，所以也可以暂时猜想为编译器的某优化目的。</p><h3 id=函数入参准备>函数入参准备</h3><p>第三步是准备函数入参，准备好后就要调用函数了：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ASM data-lang=ASM><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>edi</span><span class=p>,</span><span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0x8</span><span class=p>]</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>eax</span><span class=p>,</span><span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0xc</span><span class=p>]</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>esi</span><span class=p>,</span><span class=mi>0x2</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>edx</span><span class=p>,</span><span class=mi>0x3</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>ecx</span><span class=p>,</span><span class=mi>0x4</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>r8d</span><span class=p>,</span><span class=mi>0x5</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>r9d</span><span class=p>,</span><span class=mi>0x6</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rsp</span><span class=p>],</span><span class=mi>0x7</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rsp</span><span class=err>+</span><span class=mi>0x8</span><span class=p>],</span><span class=mi>0x8</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rsp</span><span class=err>+</span><span class=mi>0x10</span><span class=p>],</span><span class=mi>0x9</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rsp</span><span class=err>+</span><span class=mi>0x18</span><span class=p>],</span><span class=no>eax</span>
</span></span></code></pre></td></tr></table></div></div><p>这里的计算顺序是从左往右，如果是gcc编译器，计算顺序则是从右往左，计算顺序和入参顺序在<a href=/202110/ppi-ipp-func rel>《i++和++i在函数入参时的一些问题》</a>和<a href=/202108/sicp-python-read1/ rel>《《UCB CS61a SICP Python 中文》一周目笔记(一)》</a>有讲过。</p><p>这里还需要注意的就是这几句：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ASM data-lang=ASM><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>edi</span><span class=p>,</span><span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0x8</span><span class=p>]</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>eax</span><span class=p>,</span><span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0xc</span><span class=p>]</span>
</span></span><span class=line><span class=cl> <span class=c>##...
</span></span></span><span class=line><span class=cl><span class=c></span> <span class=nf>mov</span>    <span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rsp</span><span class=err>+</span><span class=mi>0x18</span><span class=p>],</span><span class=no>eax</span>
</span></span></code></pre></td></tr></table></div></div><p>在开始的时候就拿到了<code>a(rbp-0x8)</code>和<code>b(rbp-0xc)</code>两个变量，但是这里入参准备阶段实际只用到<code>a</code>，<code>b</code>在最后才准备好，被写入了<code>rsp+0x18</code>。</p><p>这里的地址也是值得关注的：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ASM data-lang=ASM><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rsp</span><span class=p>],</span><span class=mi>0x7</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rsp</span><span class=err>+</span><span class=mi>0x8</span><span class=p>],</span><span class=mi>0x8</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rsp</span><span class=err>+</span><span class=mi>0x10</span><span class=p>],</span><span class=mi>0x9</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rsp</span><span class=err>+</span><span class=mi>0x18</span><span class=p>],</span><span class=no>eax</span>
</span></span></code></pre></td></tr></table></div></div><p>注意到，这部分都是用的<code>rsp</code>加一个偏移得到的地址，而不是<code>rbp</code>减偏移得到的地址，并且这些参数是被写入了内存，而前6个参数是被写入的寄存器。这里的共识是，如果函数参数个数少于6个，则使用寄存器传递，如果大于6个，则多余的参数会使用内存传递，是不是所有情况都这样，暂时不必要追究，大部分情况都是这样的。</p><p>至于为什么用<code>rsp</code>加一个偏移来传递参数，我认为这是编译器的优化问题，使用gcc编译器的话，就是使用push指令，相当于是使用<code>rsp</code>减一个偏移来传递参数。为什么说是编译器优化问题呢？看这一段：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ASM data-lang=ASM><span class=line><span class=cl> <span class=nf>sub</span>    <span class=no>rsp</span><span class=p>,</span><span class=mi>0x30</span>
</span></span></code></pre></td></tr></table></div></div><p>在开头已经分析过了，这是移动了栈顶指针，现在栈的大小是<code>48B</code>（如果是gcc的话，分配的是<code>16B</code>），对于4个<code>int</code>参数，3个<code>int</code>变量，和上述说的<code>4B</code>的未知空间，<code>48B > (4 * 4 + 3 * 4 + 4)B</code>是满足要求的，所以为了利用好空间，这样操作是可能的。</p><h3 id=函数调用>函数调用</h3><p>第四步就是函数调用了：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ASM data-lang=ASM><span class=line><span class=cl> <span class=nf>call</span>   <span class=mi>401130</span> <span class=err>&lt;</span><span class=no>func</span><span class=p>(</span><span class=no>int</span><span class=p>,</span> <span class=no>int</span><span class=p>,</span> <span class=no>int</span><span class=p>,</span> <span class=no>int</span><span class=p>,</span> <span class=no>int</span><span class=p>,</span> <span class=no>int</span><span class=p>,</span> <span class=no>int</span><span class=p>,</span> <span class=no>int</span><span class=p>,</span> <span class=no>int</span><span class=p>,</span> <span class=no>int</span><span class=p>)</span><span class=err>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>这里<code>call</code>指令需要拆解一下，方便后续分析，<code>call</code>指令相当于：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ASM data-lang=ASM><span class=line><span class=cl> <span class=nf>push</span> <span class=no>ip</span>
</span></span><span class=line><span class=cl> <span class=nf>jmp</span> <span class=mi>401130</span> <span class=err>&lt;</span><span class=no>func</span><span class=p>(</span><span class=no>int</span><span class=p>,</span> <span class=no>int</span><span class=p>,</span> <span class=no>int</span><span class=p>,</span> <span class=no>int</span><span class=p>,</span> <span class=no>int</span><span class=p>,</span> <span class=no>int</span><span class=p>,</span> <span class=no>int</span><span class=p>,</span> <span class=no>int</span><span class=p>,</span> <span class=no>int</span><span class=p>,</span> <span class=no>int</span><span class=p>)</span><span class=err>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=子函数>子函数</h3><p>现在我们进入到了函数内部，回忆在这之前我们做了什么工作？ 保存了调用者的<code>ip</code>指针（或者叫<code>pc</code>指针），这里对应就是<code>main</code>函数中<code>call</code>的后一句，所以我们可以方便的恢复到<code>jmp</code>之后。下面来看子函数：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ASM data-lang=ASM><span class=line><span class=cl><span class=nf>func</span><span class=p>(</span><span class=no>int</span><span class=p>,</span> <span class=no>int</span><span class=p>,</span> <span class=no>int</span><span class=p>,</span> <span class=no>int</span><span class=p>,</span> <span class=no>int</span><span class=p>,</span> <span class=no>int</span><span class=p>,</span> <span class=no>int</span><span class=p>,</span> <span class=no>int</span><span class=p>,</span> <span class=no>int</span><span class=p>,</span> <span class=no>int</span><span class=p>):</span>
</span></span><span class=line><span class=cl> <span class=nf>push</span>   <span class=no>rbp</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>rbp</span><span class=p>,</span><span class=no>rsp</span>
</span></span><span class=line><span class=cl> <span class=nf>sub</span>    <span class=no>rsp</span><span class=p>,</span><span class=mi>0x1d0</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>eax</span><span class=p>,</span><span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp</span><span class=err>+</span><span class=mi>0x28</span><span class=p>]</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>eax</span><span class=p>,</span><span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp</span><span class=err>+</span><span class=mi>0x20</span><span class=p>]</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>eax</span><span class=p>,</span><span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp</span><span class=err>+</span><span class=mi>0x18</span><span class=p>]</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>eax</span><span class=p>,</span><span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp</span><span class=err>+</span><span class=mi>0x10</span><span class=p>]</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0x4</span><span class=p>],</span><span class=no>edi</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0x8</span><span class=p>],</span><span class=no>esi</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0xc</span><span class=p>],</span><span class=no>edx</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0x10</span><span class=p>],</span><span class=no>ecx</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0x14</span><span class=p>],</span><span class=no>r8d</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0x18</span><span class=p>],</span><span class=no>r9d</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>eax</span><span class=p>,</span><span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0x4</span><span class=p>]</span>
</span></span><span class=line><span class=cl> <span class=nf>add</span>    <span class=no>eax</span><span class=p>,</span><span class=mi>0x1</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0x1c</span><span class=p>],</span><span class=no>eax</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>eax</span><span class=p>,</span><span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp</span><span class=err>+</span><span class=mi>0x28</span><span class=p>]</span>
</span></span><span class=line><span class=cl> <span class=nf>add</span>    <span class=no>eax</span><span class=p>,</span><span class=mi>0x1</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0x20</span><span class=p>],</span><span class=no>eax</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>eax</span><span class=p>,</span><span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0x4</span><span class=p>]</span>
</span></span><span class=line><span class=cl> <span class=nf>add</span>    <span class=no>eax</span><span class=p>,</span><span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0x8</span><span class=p>]</span>
</span></span><span class=line><span class=cl> <span class=nf>add</span>    <span class=no>eax</span><span class=p>,</span><span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0xc</span><span class=p>]</span>
</span></span><span class=line><span class=cl> <span class=nf>add</span>    <span class=no>eax</span><span class=p>,</span><span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0x10</span><span class=p>]</span>
</span></span><span class=line><span class=cl> <span class=nf>add</span>    <span class=no>eax</span><span class=p>,</span><span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0x14</span><span class=p>]</span>
</span></span><span class=line><span class=cl> <span class=nf>add</span>    <span class=no>eax</span><span class=p>,</span><span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0x18</span><span class=p>]</span>
</span></span><span class=line><span class=cl> <span class=nf>add</span>    <span class=no>eax</span><span class=p>,</span><span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp</span><span class=err>+</span><span class=mi>0x10</span><span class=p>]</span>
</span></span><span class=line><span class=cl> <span class=nf>add</span>    <span class=no>eax</span><span class=p>,</span><span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp</span><span class=err>+</span><span class=mi>0x18</span><span class=p>]</span>
</span></span><span class=line><span class=cl> <span class=nf>add</span>    <span class=no>eax</span><span class=p>,</span><span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp</span><span class=err>+</span><span class=mi>0x20</span><span class=p>]</span>
</span></span><span class=line><span class=cl> <span class=nf>add</span>    <span class=no>eax</span><span class=p>,</span><span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp</span><span class=err>+</span><span class=mi>0x28</span><span class=p>]</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0x24</span><span class=p>],</span><span class=no>eax</span>
</span></span><span class=line><span class=cl> <span class=nf>lea</span>    <span class=no>rdi</span><span class=p>,[</span><span class=no>rbp-0x1c0</span><span class=p>]</span>
</span></span><span class=line><span class=cl> <span class=nf>xor</span>    <span class=no>esi</span><span class=p>,</span><span class=no>esi</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>edx</span><span class=p>,</span><span class=mi>0x190</span>
</span></span><span class=line><span class=cl> <span class=nf>call</span>   <span class=mh>401030</span> <span class=p>&lt;</span><span class=no>memset@plt</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0x1c0</span><span class=p>],</span><span class=mi>0x1</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>eax</span><span class=p>,</span><span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0x198</span><span class=p>]</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0x1c4</span><span class=p>],</span><span class=no>eax</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>rax</span><span class=p>,</span><span class=no>QWORD</span> <span class=no>PTR</span> <span class=no>ds</span><span class=p>:</span><span class=mi>0x402004</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>QWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0x1ce</span><span class=p>],</span><span class=no>rax</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>ax</span><span class=p>,</span><span class=no>WORD</span> <span class=no>PTR</span> <span class=no>ds</span><span class=p>:</span><span class=mi>0x40200c</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>WORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0x1c6</span><span class=p>],</span><span class=no>ax</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>eax</span><span class=p>,</span><span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0x24</span><span class=p>]</span>
</span></span><span class=line><span class=cl> <span class=nf>add</span>    <span class=no>rsp</span><span class=p>,</span><span class=mi>0x1d0</span>
</span></span><span class=line><span class=cl> <span class=nf>pop</span>    <span class=no>rbp</span>
</span></span><span class=line><span class=cl> <span class=nf>ret</span>
</span></span><span class=line><span class=cl> <span class=nf>cs</span> <span class=no>nop</span> <span class=no>WORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rax</span><span class=err>+</span><span class=no>rax</span><span class=p>*</span><span class=mi>1</span><span class=err>+</span><span class=mi>0x0</span><span class=p>]</span>
</span></span><span class=line><span class=cl> <span class=nf>nop</span>    <span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rax</span><span class=err>+</span><span class=no>rax</span><span class=p>*</span><span class=mi>1</span><span class=err>+</span><span class=mi>0x0</span><span class=p>]</span>
</span></span></code></pre></td></tr></table></div></div><p>第一步我们保存了<code>rbp</code>寄存器，这里的<code>rbp</code>寄存器保存了什么值？就是调用者的栈底指针，这里对应的就是<code>main</code>的栈底指针。所以目前为止，我们保存了<code>main</code>的栈底和<code>pc</code>指针，已经只要恢复这两个指针，我们又可以回到<code>main</code>工作了！</p><p>第二步把<code>func</code>帧的栈底设置为了<code>main</code>的栈顶，所以这两个栈连续了～，然后扩展了<code>func</code>函数的栈，大小是<code>0x1d0</code>。</p><p>第三步是入参：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ASM data-lang=ASM><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>eax</span><span class=p>,</span><span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp</span><span class=err>+</span><span class=mi>0x28</span><span class=p>]</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>eax</span><span class=p>,</span><span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp</span><span class=err>+</span><span class=mi>0x20</span><span class=p>]</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>eax</span><span class=p>,</span><span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp</span><span class=err>+</span><span class=mi>0x18</span><span class=p>]</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>eax</span><span class=p>,</span><span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp</span><span class=err>+</span><span class=mi>0x10</span><span class=p>]</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0x4</span><span class=p>],</span><span class=no>edi</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0x8</span><span class=p>],</span><span class=no>esi</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0xc</span><span class=p>],</span><span class=no>edx</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0x10</span><span class=p>],</span><span class=no>ecx</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0x14</span><span class=p>],</span><span class=no>r8d</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0x18</span><span class=p>],</span><span class=no>r9d</span>
</span></span></code></pre></td></tr></table></div></div><p>对照入参准备阶段，参数计算是从左往右，这里入参是从右往左。现在我们观察到了函数入参的结论了。另外，这几个地址可以关注一下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ASM data-lang=ASM><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>eax</span><span class=p>,</span><span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp</span><span class=err>+</span><span class=mi>0x28</span><span class=p>]</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>eax</span><span class=p>,</span><span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp</span><span class=err>+</span><span class=mi>0x20</span><span class=p>]</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>eax</span><span class=p>,</span><span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp</span><span class=err>+</span><span class=mi>0x18</span><span class=p>]</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>eax</span><span class=p>,</span><span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp</span><span class=err>+</span><span class=mi>0x10</span><span class=p>]</span>
</span></span></code></pre></td></tr></table></div></div><p>和<code>main</code>参数准备的地址相比，还偏移了<code>0x10</code>个字节，为什么？因为<code>call</code>指令的时候保存了<code>pc</code>指针，进入到<code>func</code>函数的时候又保存了<code>rbp</code>指针，一共是<code>16B</code>，对应就是增加了<code>0x10</code>。</p><p>总之，目前为止，我们将<code>main</code>函数传入的参数都保存在了<code>func</code>函数栈帧里面。后续的赋值语句我们就不分析了，不过需要关在下面两部分：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ASM data-lang=ASM><span class=line><span class=cl> <span class=nf>lea</span>    <span class=no>rdi</span><span class=p>,[</span><span class=no>rbp-0x1c0</span><span class=p>]</span>
</span></span><span class=line><span class=cl> <span class=nf>xor</span>    <span class=no>esi</span><span class=p>,</span><span class=no>esi</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>edx</span><span class=p>,</span><span class=mi>0x190</span>
</span></span><span class=line><span class=cl> <span class=nf>call</span>   <span class=mh>401030</span> <span class=p>&lt;</span><span class=no>memset@plt</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0x1c0</span><span class=p>],</span><span class=mi>0x1</span>
</span></span></code></pre></td></tr></table></div></div><p>这里用于分配和初始化<code>vv[100]</code>这个数组，调用<code>memset</code>初始化为0,然后给第一个元素初始化为1，是否调用<code>memset</code>初始化是编译器行为，并不是所有编译器都会帮助你初始化一个数组，这是需要注意的。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ASM data-lang=ASM><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>rax</span><span class=p>,</span><span class=no>QWORD</span> <span class=no>PTR</span> <span class=no>ds</span><span class=p>:</span><span class=mi>0x402004</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>QWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0x1ce</span><span class=p>],</span><span class=no>rax</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>ax</span><span class=p>,</span><span class=no>WORD</span> <span class=no>PTR</span> <span class=no>ds</span><span class=p>:</span><span class=mi>0x40200c</span>
</span></span><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>WORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0x1c6</span><span class=p>],</span><span class=no>ax</span>
</span></span></code></pre></td></tr></table></div></div><p>这部分用于给<code>cv[10]</code>初始化为<code>"hello"</code>，可以看到<code>"hello"</code>对应在了<code>ds</code>区，并且发现这里是有复制操作的，怎么复制的就先不关心了，这也能给我们提醒，如果非必要的话，可以直接使用指针指向<code>"hello"</code>，而不是用一个数组。</p><p>最后就是<code>func</code>的退出，这部分是和<code>main</code>类似的，就不介绍了。</p><p><figure><a class=lightgallery href=https://bu.dusays.com/2022/06/26/62b87fd68ec3f.png title=函数调用的栈帧 data-thumbnail=https://bu.dusays.com/2022/06/26/62b87fd68ec3f.png data-sub-html="<h2>函数调用的栈帧</h2><p>函数调用的栈帧</p>"><img class=lazyload src=/svg/loading.min.svg data-src=https://bu.dusays.com/2022/06/26/62b87fd68ec3f.png data-srcset="https://bu.dusays.com/2022/06/26/62b87fd68ec3f.png, https://bu.dusays.com/2022/06/26/62b87fd68ec3f.png 1.5x, https://bu.dusays.com/2022/06/26/62b87fd68ec3f.png 2x" data-sizes=auto alt=https://bu.dusays.com/2022/06/26/62b87fd68ec3f.png></a><figcaption class=image-caption>函数调用的栈帧</figcaption></figure></p><h3 id=函数退出>函数退出</h3><p>上述函数调用之后，就需要退出main函数了：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ASM data-lang=ASM><span class=line><span class=cl> <span class=nf>mov</span>    <span class=no>eax</span><span class=p>,</span><span class=mi>0x1</span>
</span></span><span class=line><span class=cl> <span class=nf>add</span>    <span class=no>rsp</span><span class=p>,</span><span class=mi>0x30</span>
</span></span><span class=line><span class=cl> <span class=nf>pop</span>    <span class=no>rbp</span>
</span></span><span class=line><span class=cl> <span class=nf>ret</span>
</span></span></code></pre></td></tr></table></div></div><p>我开始比较疑惑，为什么会把<code>0x1</code>赋值给<code>eax</code>寄存器？原来是<code>main</code>函数返回了<code>1</code>，所以返回值先给了<code>eax</code>寄存器。赋值完返回值后，会把栈顶寄存器移动到栈底，这里对应的就是<code>add rsp,0x30</code>，然后恢复调用者的栈底，<code>main</code>的调用者就是<code>__libc_start_main</code>，在<a href=/202201/glibc-exit/#main%e5%87%bd%e6%95%b0 rel>《glibc-exit源码阅读》</a>已经介绍过了。<code>ret</code>指令则会<code>pop</code>出<code>ip</code>寄存器，相当于恢复到调用者上次执行的位置。</p><p><figure><a class=lightgallery href=https://bu.dusays.com/2022/06/26/62b87fd9497ad.png title=函数退出的栈帧 data-thumbnail=https://bu.dusays.com/2022/06/26/62b87fd9497ad.png data-sub-html="<h2>函数退出的栈帧</h2><p>函数退出的栈帧</p>"><img class=lazyload src=/svg/loading.min.svg data-src=https://bu.dusays.com/2022/06/26/62b87fd9497ad.png data-srcset="https://bu.dusays.com/2022/06/26/62b87fd9497ad.png, https://bu.dusays.com/2022/06/26/62b87fd9497ad.png 1.5x, https://bu.dusays.com/2022/06/26/62b87fd9497ad.png 2x" data-sizes=auto alt=https://bu.dusays.com/2022/06/26/62b87fd9497ad.png></a><figcaption class=image-caption>函数退出的栈帧</figcaption></figure></p><h2 id=黑魔法>黑魔法</h2><p>通过上面的分析，可以知道，函数在调用子函数后，栈会向下增长，子函数返回后，栈会减小，栈底和栈顶又会回到调用者的位置，但是并没有清空子函数的栈记录。</p><p>因此，我们可以实现一个黑魔法，在<code>main</code>函数里面获得<code>func</code>函数中的局部变量！如下就是我们的攻击函数：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>func</span><span class=p>(</span><span class=kt>int</span> <span class=n>v1</span><span class=p>,</span> <span class=kt>int</span> <span class=n>v2</span><span class=p>,</span> <span class=kt>int</span> <span class=n>v3</span><span class=p>,</span> <span class=kt>int</span> <span class=n>v4</span><span class=p>,</span> <span class=kt>int</span> <span class=n>v5</span><span class=p>,</span> <span class=kt>int</span> <span class=n>v6</span><span class=p>,</span> <span class=kt>int</span> <span class=n>v7</span><span class=p>,</span> <span class=kt>int</span> <span class=n>v8</span><span class=p>,</span> <span class=kt>int</span> <span class=n>v9</span><span class=p>,</span> <span class=kt>int</span> <span class=n>v10</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>n1</span> <span class=o>=</span> <span class=n>v1</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>n10</span> <span class=o>=</span> <span class=n>v10</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>nv</span> <span class=o>=</span> <span class=n>v1</span> <span class=o>+</span> <span class=n>v2</span> <span class=o>+</span> <span class=n>v3</span> <span class=o>+</span> <span class=n>v4</span> <span class=o>+</span> <span class=n>v5</span> <span class=o>+</span> <span class=n>v6</span> <span class=o>+</span> <span class=n>v7</span> <span class=o>+</span> <span class=n>v8</span> <span class=o>+</span> <span class=n>v9</span> <span class=o>+</span> <span class=n>v10</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>vv</span><span class=p>[</span><span class=mi>100</span><span class=p>]{</span><span class=mi>1</span><span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>vv10</span> <span class=o>=</span> <span class=n>vv</span><span class=p>[</span><span class=mi>10</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>cv</span><span class=p>[</span><span class=mi>10</span><span class=p>]</span> <span class=o>=</span> <span class=s>&#34;hello&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>nv</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>a</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>b</span> <span class=o>=</span> <span class=mi>10</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>c</span> <span class=o>=</span> <span class=mi>11</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>func</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>5</span><span class=p>,</span> <span class=mi>6</span><span class=p>,</span> <span class=mi>7</span><span class=p>,</span> <span class=mi>8</span><span class=p>,</span> <span class=mi>9</span><span class=p>,</span> <span class=n>b</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;%s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=p>(</span><span class=n>reinterpret_cast</span><span class=o>&lt;</span><span class=kt>char</span> <span class=o>*&gt;</span><span class=p>(</span><span class=o>&amp;</span><span class=n>a</span><span class=p>)</span> <span class=o>+</span> <span class=mi>4</span> <span class=o>+</span> <span class=mi>4</span> <span class=o>-</span> <span class=mi>16</span> <span class=o>*</span> <span class=mi>3</span> <span class=o>-</span> <span class=mi>8</span> <span class=o>-</span> <span class=mi>8</span> <span class=o>-</span> <span class=mi>462</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>关键部分是：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=p>(</span><span class=n>reinterpret_cast</span><span class=o>&lt;</span><span class=kt>char</span> <span class=o>*&gt;</span><span class=p>(</span><span class=o>&amp;</span><span class=n>a</span><span class=p>)</span> <span class=o>+</span> <span class=mi>4</span> <span class=o>+</span> <span class=mi>4</span> <span class=o>-</span> <span class=mi>16</span> <span class=o>*</span> <span class=mi>3</span> <span class=o>-</span> <span class=mi>8</span> <span class=o>-</span> <span class=mi>8</span> <span class=o>-</span> <span class=mi>462</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>我们来分析每个数字的含义：</p><ol><li>第一个<code>+ 4</code>，因为变量<code>a</code>占<code>4B</code>，为了回到<code>main</code>的栈底，我们先上移<code>4B</code></li><li>第二个<code>+ 4</code>，暂时没找到原因，通过分析clang的汇编才能找到这多出来的<code>4B</code>，总之，还需要上移<code>4B</code></li><li><code>- 16 * 3</code>，以上我们回到了<code>main</code>的栈底，现在需要到<code>main</code>的栈顶，所以下移<code>16 * 3</code></li><li><code>- 8 - 8</code>， 现在走到了<code>main</code>的栈顶，调用<code>func</code>还有两个<code>push</code>操作，分别是<code>push``ip</code>和<code>rbp</code>，所以再下移两个<code>8B</code></li><li><code>- 462</code>， 现在走到了<code>func</code>的栈底，为了得到<code>cv</code>的值，我们需要知道<code>cv</code>的偏移， <code>cv</code>的偏移是<code>0x1ce</code>对应就是<code>462</code></li></ol><p>所以，以上<code>printf</code>部分，可以在<code>main</code>函数打印<code>func</code>函数中的局部变量，这里就会打印<code>"hello"</code>。</p><p>不过，还是有疑问，<code>- 462</code>是怎么来的，如果只分析<code>func</code>的局部变量的大小，计算出来的不是<code>462</code>，而是<code>(100 + 4 + 6) × 4 + 10 = 450</code>，通过汇编分析，多出来的<code>12B</code>是在<code>vv[100]</code>这个数组初始化过程中产生的，可以尝试增加另外一个数组，也会发现会多出来几个字节的空间，这里就不追究了。</p><p>假想攻击：</p><p>通过以上分析，我们知道程序执行过程中会在程序栈中留下痕迹。如果某软件会把用户密码明文地临时保存在一个局部变量中，是不是可以通过hook一些基础函数，比如hook glibc的某些函数来入侵软件的进程栈呢？入侵之后就可以获取到整个进程栈（一般也就8MB），然后通过实时分析（比如关键词匹配等等）进程栈来猜解用户密码。不过，如果多线程的话，线程栈可能会和进程栈有区别，会增加数据量。</p><h2 id=结论>结论</h2><p>现在来回答一下我的疑问：栈帧是什么？栈帧是不是包含了程序的执行指令？</p><p>栈帧是栈，是保存程序运行局部变量的栈，是程序栈的一部分，动态增长。栈帧不包含程序的执行指令，但是包含执行指令的地址。</p></div><div class=post-footer id=post-footer><div class=orlike-box></div><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2022-01-26</span></div><div class=post-info-license><span><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></div><div class=post-info-more><section><i class="fas fa-fw fa-th"></i>&nbsp;<a href=/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/>操作系统</a></section><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/linux/>Linux</a>,&nbsp;<a href=/tags/%E6%A0%88/>栈</a></section></div><div class=post-nav><a href=/202201/glibc-exit/ class=prev rel=prev title=glibc-exit源码阅读><i class="fas fa-angle-left fa-fw"></i>glibc-exit源码阅读</a>
<a href=/202202/fopen-sys-open/ class=next rel=next title=glibc-fopen源码阅读-补充篇-open系统调用>glibc-fopen源码阅读-补充篇-open系统调用<i class="fas fa-angle-right fa-fw"></i></a></div></div><div id=my-random-posts><div class=loadingThree><span></span>
<span></span>
<span></span>
<span></span>
<span></span></div></div><div id=comments><div id=giscus class=comment></div><script src=https://giscus.app/client.js data-repo=caibingcheng/comment data-repo-id=R_kgDOHgda4w data-category=Announcements data-category-id=DIC_kwDOHgda484CTfDe data-mapping=og:title data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=/css/giscus.css data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script><noscript>Please enable JavaScript to view the comments powered by <a href=https://giscus.app/>giscus</a>.</noscript></div></article></div></main><footer class=footer><hr style=opacity:.2><div class=footer-container><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2020 - 2024</span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span><span class=icp-splitter>&nbsp;|&nbsp;</span><br class=icp-br><span class=icp><a href="https://icp.gov.moe/?keyword=20222231" target=_blank>萌ICP备20222231号</a></span></div><div class=footer-line><a href=https://wiki.imcbc.cn target=_blank rel=noopener title="Bing's Wiki">Wiki</a>
&nbsp;|&nbsp;
<a href=https://rssblog.cn target=_blank rel=noopener title=RSSBlog>RSSBlog</a>
&nbsp;|&nbsp;
<a href=https://travellings.link target=_blank rel=noopener title=开往-友链接力>开往-友链接力</a>
&nbsp;|&nbsp;
<a href=https://www.foreverblog.cn/go.html target=_blank>穿梭虫洞</a></div><div class=footer-line><script>var build_date="2024-03-05T21:35:51+08:00"</script>已运行
<span id=run-time></span>
&nbsp;|&nbsp;
构建于
<span id=build-time></span>&nbsp;前</div><div class=footer-line><script async src=https://npm.elemecdn.com/penndu@1.0.0/bsz.js></script>
共计
<span id=busuanzi_value_site_uv></span>&nbsp;访客
&nbsp;|&nbsp;
<span id=busuanzi_value_site_pv></span>&nbsp;访问
&nbsp;|&nbsp;
256K&nbsp;字</div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw"></i>
</a><a id=reader-button class=fixed-button title=阅读模式><i class="fa fa-book fa-fw"></i></a></div><link rel=stylesheet href=https://fastly.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/css/lightgallery.min.css><link rel=stylesheet href=https://fastly.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css><link rel=stylesheet href=https://fastly.jsdelivr.net/npm/katex@0.11.1/dist/contrib/copy-tex.min.css><script type=text/javascript src=https://cdn.staticfile.org/jquery/3.6.0/jquery.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/npm/autocomplete.js@0.37.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/npm/algoliasearch@4.2.0/dist/algoliasearch-lite.umd.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/js/lightgallery.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/npm/lg-thumbnail.js@1.2.0/dist/lg-thumbnail.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/npm/lg-zoom.js@1.2.0/dist/lg-zoom.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/npm/katex@0.11.1/dist/contrib/copy-tex.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/npm/katex@0.11.1/dist/contrib/mhchem.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/gh/Albejr/jquery-albe-timeline/jquery-albe-timeline.min.js></script><script type=text/javascript src=https://fastly.jsdelivr.net/gh/caibingcheng/orlike@client/orlike.min.js></script><script type=text/javascript src=/js/custom.js></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:50},comment:{},lightGallery:{actualSize:!1,exThumbImage:"data-thumbnail",hideBarsDelay:2e3,selector:".lightgallery",speed:400,thumbContHeight:80,thumbWidth:80,thumbnail:!0},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{algoliaAppID:"JMTHQS1VUU",algoliaIndex:"blog-bbing",algoliaSearchKey:"0dd43732743475449c844c0d0f21366a",highlightTag:"em",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:50,type:"algolia"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>